<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Controlled Freedom</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/svg+xml" href="images/minilogo.svg">
    <style>
        :root {
            --accent: #f97316;
        }
        .loader {
            border-top-color: var(--accent);
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="auth-container" class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div>
                <img class="mx-auto h-24 w-auto" src="images/logo.svg" alt="Controlled Freedom">
                <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                    Sign in to your account
                </h2>
            </div>
            <form id="login-form" class="mt-8 space-y-6">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="email" class="sr-only">Email address</label>
                        <input id="email" name="email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-orange-500 focus:border-orange-500 focus:z-10 sm:text-sm" placeholder="Email address">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Password</label>
                        <input id="password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-orange-500 focus:border-orange-500 focus:z-10 sm:text-sm" placeholder="Password">
                    </div>
                </div>
                <div>
                    <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-orange-600 hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500">
                        Sign in
                    </button>
                </div>
                <p id="auth-error" class="text-red-500 text-sm mt-2"></p>
            </form>
        </div>
    </div>

    <div id="admin-panel" class="hidden">
        <header class="bg-white shadow-md">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-800">Admin Dashboard</h1>
                <button id="logout-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Logout</button>
            </div>
        </header>

        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Form Column -->
                <div class="lg:col-span-1">
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h2 id="form-title" class="text-2xl font-bold mb-6 text-gray-900">Create New Article</h2>
                        <form id="article-form" class="space-y-4">
                            <input type="hidden" id="article-id">
                            <div>
                                <label for="article-type" class="block text-sm font-medium text-gray-700">Article Type</label>
                                <select id="article-type" name="article-type" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm rounded-md">
                                    <option value="news">News</option>
                                    <option value="review">Review</option>
                                </select>
                            </div>
                            <div>
                                <label for="title" class="block text-sm font-medium text-gray-700">Title</label>
                                <input type="text" id="title" name="title" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm">
                            </div>
                            <!-- Review Specific Fields -->
                            <div id="review-album-fields" class="hidden space-y-4">
                                <div>
                                    <label for="albumTitle" class="block text-sm font-medium text-gray-700">Album Title</label>
                                    <input type="text" id="albumTitle" name="albumTitle" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="artist" class="block text-sm font-medium text-gray-700">Artist</label>
                                    <input type="text" id="artist" name="artist" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="rating" class="block text-sm font-medium text-gray-700">Rating (1-5)</label>
                                    <input type="number" id="rating" name="rating" min="1" max="5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm">
                                </div>
                            </div>
                             <!-- NEW Review Detail Fields -->
                            <div id="review-fields" class="hidden space-y-4">
                                <div>
                                    <label for="releaseDate" class="block text-sm font-medium text-gray-700">Release Date (Year)</label>
                                    <input type="number" id="releaseDate" name="releaseDate" placeholder="e.g., 1959" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="genre" class="block text-sm font-medium text-gray-700">Genre(s) (comma-separated)</label>
                                    <input type="text" id="genre" name="genre" placeholder="e.g., Hard Bop, Post-Bop" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="label" class="block text-sm font-medium text-gray-700">Label</label>
                                    <input type="text" id="label" name="label" placeholder="e.g., Blue Note" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm">
                                </div>
                            </div>
                            <div>
                                <label for="imageUrl" class="block text-sm font-medium text-gray-700">Image URL</label>
                                <input type="url" id="imageUrl" name="imageUrl" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="body" class="block text-sm font-medium text-gray-700">Body (HTML allowed)</label>
                                <textarea id="body" name="body" rows="10" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm"></textarea>
                                <p class="mt-2 text-xs text-gray-500">Wrap the final paragraph in &lt;highlight&gt;...&lt;/highlight&gt; to feature it.</p>
                            </div>
                            <div class="flex items-center justify-between">
                                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-orange-600 hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500">
                                    Save Article
                                </button>
                                <button type="button" id="clear-form-btn" class="ml-4 text-sm text-gray-600 hover:text-gray-900">Clear</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Articles List Column -->
                <div class="lg:col-span-2">
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-bold mb-4 text-gray-900">Existing Articles</h2>
                        <div id="articles-list" class="space-y-4">
                            <!-- Loader -->
                            <div id="list-loader" class="flex justify-center items-center">
                                <div class="loader h-8 w-8 border-4 rounded-full"></div>
                            </div>
                            <!-- Articles will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, doc, updateDoc, deleteDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA1ZujlHARbBmqjr8Hi_GETCk4UzD_J4hM",
            authDomain: "controlled-freedom.firebaseapp.com",
            projectId: "controlled-freedom",
            storageBucket: "controlled-freedom.appspot.com",
            messagingSenderId: "992659637634",
            appId: "1:992659637634:web:88de99efae5cb7cf53bb9b",
            measurementId: "G-ETT07JGVSB"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const authContainer = document.getElementById('auth-container');
        const adminPanel = document.getElementById('admin-panel');
        const loginForm = document.getElementById('login-form');
        const authError = document.getElementById('auth-error');
        const logoutBtn = document.getElementById('logout-btn');
        const articleForm = document.getElementById('article-form');
        const articlesList = document.getElementById('articles-list');
        const formTitle = document.getElementById('form-title');
        const clearFormBtn = document.getElementById('clear-form-btn');
        const articleTypeSelect = document.getElementById('article-type');
        const reviewAlbumFields = document.getElementById('review-album-fields');
        const reviewFields = document.getElementById('review-fields');

        // --- Helper Function to Generate URL Slug ---
        const generateSlug = (text) => {
            return text.toString().toLowerCase()
                .replace(/\s+/g, '-')           // Replace spaces with -
                .replace(/[^\w\-]+/g, '')       // Remove all non-word chars
                .replace(/\-\-+/g, '-')         // Replace multiple - with single -
                .replace(/^-+/, '')             // Trim - from start of text
                .replace(/-+$/, '');            // Trim - from end of text
        };

        // Auth state listener
        onAuthStateChanged(auth, user => {
            if (user) {
                authContainer.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                loadArticles();
            } else {
                authContainer.classList.remove('hidden');
                adminPanel.classList.add('hidden');
            }
        });

        // Login
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = loginForm.email.value;
            const password = loginForm.password.value;
            signInWithEmailAndPassword(auth, email, password)
                .catch(error => {
                    authError.textContent = error.message;
                });
        });

        // Logout
        logoutBtn.addEventListener('click', () => {
            signOut(auth);
        });

        // Toggle review-specific fields based on article type
        articleTypeSelect.addEventListener('change', (e) => {
            const isReview = e.target.value === 'review';
            reviewAlbumFields.classList.toggle('hidden', !isReview);
            reviewFields.classList.toggle('hidden', !isReview);
        });

        // Handle form submission (Create/Update)
        const handleFormSubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('article-id').value;
            const type = articleTypeSelect.value;
            const title = document.getElementById('title').value;
            const body = document.getElementById('body').value;
            const imageUrl = document.getElementById('imageUrl').value;

            const articleData = {
                type,
                title,
                body,
                imageUrl,
                author: auth.currentUser.email,
                publishDate: new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }),
                updatedAt: serverTimestamp()
            };

            if (type === 'review') {
                const albumTitle = document.getElementById('albumTitle').value;
                articleData.albumTitle = albumTitle;
                articleData.artist = document.getElementById('artist').value;
                articleData.rating = parseInt(document.getElementById('rating').value);
                articleData.year = parseInt(document.getElementById('releaseDate').value) || null;
                articleData.genres = document.getElementById('genre').value.split(',').map(g => g.trim()).filter(g => g);
                articleData.label = document.getElementById('label').value;
                articleData.slug = generateSlug(albumTitle); // Generate slug from album title
            } else {
                 articleData.slug = generateSlug(title); // Generate slug from article title
            }

            try {
                if (id) {
                    // Update
                    const docRef = doc(db, "articles", id);
                    await updateDoc(docRef, articleData);
                } else {
                    // Create
                    articleData.createdAt = serverTimestamp();
                    await addDoc(collection(db, "articles"), articleData);
                }
                clearForm();
                await loadArticles();
            } catch (error) {
                console.error("Error saving article: ", error);
                alert("Could not save article. Check console for details.");
            }
        };

        const loadArticles = async () => {
            articlesList.innerHTML = `<div id="list-loader" class="flex justify-center items-center"><div class="loader h-8 w-8 border-4 rounded-full"></div></div>`;
            try {
                const articlesRef = collection(db, "articles");
                const q = query(articlesRef, orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                let html = '';
                querySnapshot.forEach((doc) => {
                    const article = { id: doc.id, ...doc.data() };
                    const articleUrl = article.type === 'review' 
                        ? `/reviews/${article.slug}` 
                        : `/news/${article.slug}`;

                    html += `
                        <div class="p-4 border rounded-md bg-gray-50">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-bold text-lg">${article.title}</p>
                                    <p class="text-sm text-gray-500">${article.type.toUpperCase()} | ${article.publishDate}</p>
                                    <a href="${articleUrl}" target="_blank" class="text-xs text-blue-500 hover:underline">${articleUrl}</a>
                                </div>
                                <div class="flex space-x-2 flex-shrink-0 ml-4">
                                    <button data-id="${article.id}" class="edit-btn text-blue-600 hover:text-blue-800">Edit</button>
                                    <button data-id="${article.id}" class="delete-btn text-red-600 hover:text-red-800">Delete</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                articlesList.innerHTML = html || '<p>No articles found.</p>';
            } catch (error) {
                console.error("Error loading articles:", error);
                articlesList.innerHTML = '<p class="text-red-500">Could not load articles.</p>';
            }
        };

        const editArticle = async (id) => {
            const docRef = doc(db, "articles", id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const article = docSnap.data();
                formTitle.textContent = "Edit Article";
                document.getElementById('article-id').value = id;
                articleTypeSelect.value = article.type;
                document.getElementById('title').value = article.title;
                document.getElementById('body').value = article.body;
                document.getElementById('imageUrl').value = article.imageUrl || '';

                const isReview = article.type === 'review';
                reviewAlbumFields.classList.toggle('hidden', !isReview);
                reviewFields.classList.toggle('hidden', !isReview);

                if (isReview) {
                    document.getElementById('albumTitle').value = article.albumTitle || '';
                    document.getElementById('artist').value = article.artist || '';
                    document.getElementById('rating').value = article.rating || 3;
                    document.getElementById('releaseDate').value = article.year || '';
                    document.getElementById('genre').value = (article.genres || []).join(', ');
                    document.getElementById('label').value = article.label || '';
                }
                window.scrollTo(0, 0);
            }
        };

        const deleteArticle = async (id) => {
            if (confirm("Are you sure you want to delete this article?")) {
                try {
                    await deleteDoc(doc(db, "articles", id));
                    await loadArticles();
                } catch (error) {
                    console.error("Error deleting article: ", error);
                    alert("Could not delete article.");
                }
            }
        };
        
        const clearForm = () => {
            articleForm.reset();
            document.getElementById('article-id').value = '';
            formTitle.textContent = "Create New Article";
            reviewAlbumFields.classList.add('hidden');
            reviewFields.classList.add('hidden');
            articleTypeSelect.value = 'news';
        };

        articlesList.addEventListener('click', (e) => {
            const id = e.target.dataset.id;
            if (e.target.classList.contains('edit-btn')) {
                editArticle(id);
            }
            if (e.target.classList.contains('delete-btn')) {
                deleteArticle(id);
            }
        });

        articleForm.addEventListener('submit', handleFormSubmit);
        clearFormBtn.addEventListener('click', clearForm);

    </script>
</body>
</html>
