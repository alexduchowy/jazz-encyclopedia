<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legacy - Controlled Freedom</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;700;900&family=Lora:ital,wght@0,400;0,600;1,400;1,600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-main: #f5f5f4; --bg-secondary: #e7e5e4; --bg-dark: #1a1a1a; --text-main: #1c1917; --text-muted: #44403c; --accent: #f97316; --accent-dark: #ea580c; --yellow-accent: #facc15;
            --genre-melodic-path: #64748b; --genre-free-jazz: #fca5a5; --genre-avant-garde: #fecdd3; --genre-jazz-fusion: #a5f3fc; --genre-post-bop: #fed7aa; --genre-hard-bop: #d8b4fe; --genre-default: #e7e5e4;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-main); color: var(--text-main); }
        h1, h2, h3, h4, h5 { font-family: 'Bebas Neue', sans-serif; letter-spacing: 0.05em; }
        .nav-link { transition: color 0.2s; font-family: 'Bebas Neue', sans-serif; letter-spacing: 0.1em; font-size: 1.1rem; }
        .nav-link:hover, .nav-link.active { color: var(--accent); }
        .section-header { transform: rotate(-1deg); display: inline-block; background-color: var(--accent); color: var(--bg-main); padding: 0.25rem 1rem; margin-bottom: 1rem; }
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease-out, opacity 0.3s ease-out; }
        .modal.opacity-0 .modal-content { opacity: 0; transform: scale(0.95) translateY(10px); }
        .legacy-album-card { width: 200px; flex-shrink: 0; background-color: var(--bg-main); border-radius: 0.25rem; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; box-shadow: 4px 4px 0px var(--text-main); border: 2px solid var(--text-main); overflow: hidden; }
        .legacy-album-card:hover { transform: translateY(-5px) rotate(2deg); }
        .legacy-album-card img { width: 100%; height: 200px; object-fit: cover; filter: grayscale(100%); transition: filter 0.3s ease; }
        .legacy-album-card:hover img { filter: grayscale(0%); }
        .artist-card { background-color: var(--bg-main); border-radius: 0.25rem; overflow: hidden; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; box-shadow: 4px 4px 0px var(--text-main); border: 2px solid var(--text-main); }
        .artist-card:hover { transform: translateY(-5px) rotate(2deg); box-shadow: 8px 8px 0px var(--accent) !important; }
        .artist-card.bandleader { box-shadow: 4px 4px 0px var(--accent); }
        .artist-card img { width: 100%; height: 224px; object-fit: cover; filter: grayscale(100%); transition: filter 0.3s ease; }
        .artist-card:hover img { filter: grayscale(0%); }
        #artist-slider-track { display: flex; transition: transform 0.5s ease-in-out; }
        .artist-slider-page { width: 100%; flex-shrink: 0; display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; }
        @media (min-width: 768px) { .artist-slider-page { grid-template-columns: repeat(6, 1fr); } }
        .styled-select select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23f97316' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.7rem center; background-size: 1.2em; }
        #modal-analysis-section { background-color: var(--bg-dark); padding: 1.5rem; margin-top: 2rem; border: 2px solid var(--text-main); box-shadow: 4px 4px 0px var(--text-main); }
        #modal-analysis-section h5 { color: var(--bg-main); }
        .liner-notes-text { font-family: 'Lora', serif; font-size: 1rem; line-height: 1.6; color: #d4d4d2; }
        audio.styled-player { height: 35px; accent-color: var(--accent); }
        .genre-tag { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 600; color: var(--text-main); border: 2px solid var(--text-main); }
        .clickable-link { cursor: pointer; text-decoration: underline; text-decoration-color: var(--accent); }
        .title-rotate { transform: rotate(-1.5deg); }
        .nav-bar-hidden-behaviour { display: flex; transform: rotate(-1.5deg); }
        @media (max-width: 640px) { .nav-bar-hidden-behaviour { display: none; } }
        #mobile-menu-panel { transition: transform 0.3s ease-in-out; }
        #mobile-menu-overlay.hidden #mobile-menu-panel { transform: translateX(100%); }
        .path-selector-card { 
            background-color: var(--bg-secondary); 
            border: 2px solid var(--text-main); 
            border-radius: 0.25rem; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            box-shadow: 4px 4px 0px var(--text-main); 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
        }
        .path-selector-card-img { height: 160px; width: 100%; object-fit: cover; filter: grayscale(50%); transition: filter 0.3s ease; }
        .path-selector-card:hover .path-selector-card-img, .path-selector-card.active .path-selector-card-img { filter: grayscale(0%); }
        .path-selector-card-content { padding: 1rem; flex-grow: 1; display: flex; flex-direction: column; }
        .path-selector-card:hover { transform: translateY(-4px) rotate(-1deg); box-shadow: 6px 6px 0px var(--text-main); }
        .path-selector-card.active { transform: translateY(-4px) rotate(-1deg) scale(1.02); border-width: 4px; border-color: var(--path-color, var(--accent)); box-shadow: 8px 8px 0px var(--path-color, var(--accent)); }
        #legacy-slider-wrapper { background-color: rgba(231, 229, 228, 0.5); transition: background-color 0.5s ease-in-out; }
        #legacy-album-track { padding: 1rem 0; transition: transform 0.5s ease-in-out; }
        #loader { position: fixed; inset: 0; background-color: var(--bg-main); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .loader-spinner { border: 4px solid var(--bg-secondary); border-top: 4px solid var(--accent); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .content-hidden { display: none; }
        .dropdown-menu { background-color: var(--bg-main); border: 2px solid var(--text-main); box-shadow: 4px 4px 0px var(--text-main); margin-top: 1.75rem; transform: rotate(1.5deg); transform-origin: top left; }
        .dropdown-menu a { font-family: 'Inter', sans-serif; letter-spacing: normal; font-size: 1rem; display: block; padding: 0.5rem 1.5rem; color: var(--text-muted); transition: all 0.2s; }
        .dropdown-menu a:hover { background-color: var(--accent); color: var(--bg-main); transform: translateX(5px); }
        .desktop-dropdown-behaviour { display: none; }
        .group:hover .desktop-dropdown-behaviour { display: block; }
        .landmark-album-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem 1rem;
            list-style-position: inside;
        }

        /* Family Tree Styles */
        #family-tree-wrapper {
            position: relative;
        }
        #family-tree-container {
            overflow-x: auto;
            padding: 2rem 0;
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        #family-tree-container::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        .family-tree {
            display: inline-flex;
            flex-direction: row;
            align-items: center;
            gap: 50px;
            padding: 2rem;
        }
        .tree-level {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 20px;
            position: relative;
        }
        .tree-level::before {
            content: '';
            position: absolute;
            top: 50%;
            right: 100%;
            transform: translateY(-50%);
            width: 50px;
            height: 2px;
            background-color: var(--text-muted);
        }
        .family-tree > .tree-level:first-child::before {
            display: none;
        }
        .genre-node {
            padding: 1rem 1.5rem;
            border: 2px solid var(--text-main);
            border-radius: 0.25rem;
            box-shadow: 4px 4px 0px var(--text-main);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            text-align: center;
            min-width: 150px;
        }
        .genre-node:hover {
            transform: translateY(-4px) rotate(1deg);
            box-shadow: 6px 6px 0px var(--accent);
        }
        .genre-node h4 {
            font-size: 1.5rem;
        }
        .genre-node.subgenre {
            margin-left: 30px;
        }
        .genre-node.subgenre h4 {
            font-size: 1.1rem;
        }
        .genre-group {
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }
        .genre-group::before {
            content: '';
            position: absolute;
            top: 50%;
            right: 100%;
            transform: translateY(-50%);
            width: 25px;
            height: 2px;
            background-color: var(--text-muted);
        }
        .tree-level > .genre-node:not(:first-child)::after, .tree-level > .genre-group:not(:first-child)::after {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 20px;
            background-color: var(--text-muted);
        }
        .subgenre-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
            position: relative;
            padding-left: 25px;
        }
        .subgenre-container::before {
            content: '';
            position: absolute;
            top: 10%;
            bottom: 10%;
            left: 0;
            width: 2px;
            background-color: var(--text-muted);
        }
        .subgenre-container .genre-node::before {
            content: '';
            position: absolute;
            top: 50%;
            right: 100%;
            transform: translateY(-50%);
            width: 25px;
            height: 2px;
            background-color: var(--text-muted);
        }
    </style>
</head>
<body class="bg-stone-100 text-stone-900">

    <div id="loader"><div class="loader-spinner"></div></div>

    <div id="page-content" class="content-hidden">
        <div class="sticky top-0 z-50 h-24">
            <header class="relative container mx-auto h-full">
                <!-- This is the crooked background. It is positioned absolutely within the header -->
                <div class="absolute inset-x-0 top-4 h-20 bg-stone-100 border-2 border-stone-900" style="transform: rotate(-1.5deg); box-shadow: 5px 5px 0px var(--text-main); z-index: 1;"></div>
                
                <!-- This is the navigation content. It is NOT rotated and sits on top of the background -->
                <nav class="relative z-10 flex items-center justify-between h-full px-4 sm:px-6 lg:px-8">
                    <div class="title-rotate flex-shrink-0 mt-12 sm:mt-10">
                        <a href="index.html"><img src="images/logo.svg" alt="Controlled Freedom Logo" class="h-16 sm:h-20"></a>
                    </div>
                    <div class="nav-bar-hidden-behaviour sm:items-center sm:space-x-8">
                        <div class="relative group">
                            <a href="index.html" class="nav-link px-3 py-2 rounded-md font-medium text-stone-600">Home</a>
                            <div class="absolute desktop-dropdown-behaviour pt-2 z-10">
                                <div class="dropdown-menu rounded-sm py-2">
                                    <a href="index.html#overview">Overview</a>
                                    <a href="index.html#timeline">Timeline</a>
                                    <a href="index.html#matrix">Genres</a>
                                    <a href="index.html#artists">Artists</a>
                                </div>
                            </div>
                        </div>
                        <div class="relative group">
                            <a href="legacy.html" class="nav-link active px-3 py-2 rounded-md font-medium text-stone-600">Legacy</a>
                             <div class="absolute desktop-dropdown-behaviour pt-2 z-10">
                                <div class="dropdown-menu rounded-sm py-2">
                                    <a href="legacy.html#legacy">Path Timeline</a>
                                    <a href="legacy.html#artists">Legacy Artists</a>
                                </div>
                            </div>
                        </div>
                       <div class="relative group">
                            <a href="reviews.html" class="nav-link px-3 py-2 rounded-md font-medium text-stone-600">Reviews</a>
                             <div class="absolute desktop-dropdown-behaviour pt-2 z-10">
                                <div class="dropdown-menu rounded-sm py-2">
                                    <a href="reviews.html#news">Latest News</a>
                                    <a href="reviews.html#reviews">Album Reviews</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Hamburger Menu Button -->
                    <div class="sm:hidden">
                        <button id="mobile-menu-button" class="p-2 -mr-2 rounded-md text-stone-900 hover:bg-stone-200 focus:outline-none">
                            <svg class="h-8 w-8" stroke="currentColor" fill="none" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                            </svg>
                        </button>
                    </div>
                </nav>
            </header>
        </div>

        <main class="-mt-24">
            <!-- Banner Section -->
            <section id="banner" class="relative w-full h-60 md:h-72 lg:h-80">
                <img src="images/bannerlegacy.png" alt="Legacy of Jazz" class="w-full h-full object-cover" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/1920x320/1c1917/f5f5f4?text=Legacy';">
                <div class="absolute inset-x-0 bottom-0 h-full bg-gradient-to-t from-stone-100 to-transparent"></div>
            </section>

            <section id="legacy" class="pt-12 pb-16 sm:pb-20 bg-stone-100">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-6xl text-center">
                    <h2 class="section-header text-5xl">Legacy</h2>
                    <p class="text-center text-lg text-stone-600 mb-4 max-w-3xl mx-auto italic">How a golden age splintered into new forms, leaving an indelible mark on music.</p>
                    <p class="text-left text-base text-stone-700 max-w-4xl mx-auto mb-12">The two decades from 1950 to 1969 were a period of unprecedented creative explosion in jazz. But the story didn't end there. The innovations of these years branched out, creating new musical languages that continue to evolve today. This section explores the primary paths that grew from the fertile ground of the post-bop era, tracing the lineage of modern jazz into the 21st century.</p>
                    <div id="path-selector-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8 mb-12">
                        <!-- Path cards will be injected here by JavaScript -->
                    </div>
                    <div id="legacy-slider-wrapper" class="hidden mt-8 p-6 rounded-lg">
                        <h3 id="legacy-slider-title" class="text-4xl mb-8 text-center transition-colors duration-300"></h3>
                        <div id="legacy-album-slider-container" class="relative">
                            <div id="legacy-album-track-wrapper" class="overflow-hidden"><div id="legacy-album-track" class="flex gap-6"></div></div>
                            <button id="legacy-prev-btn" class="absolute top-1/2 -translate-y-1/2 -left-4 z-10 p-2 rounded-full bg-stone-900 text-stone-100 hover:bg-orange-500 transition-all disabled:opacity-25 disabled:cursor-not-allowed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg></button>
                            <button id="legacy-next-btn" class="absolute top-1/2 -translate-y-1/2 -right-4 z-10 p-2 rounded-full bg-stone-900 text-stone-100 hover:bg-orange-500 transition-all disabled:opacity-25 disabled:cursor-not-allowed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg></button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- GENRE FAMILY TREE SECTION -->
            <section id="legacy-genres" class="py-16 sm:py-20">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center">
                    <h2 class="section-header text-5xl">The Jazz Family Tree</h2>
                    <p class="text-center text-lg text-stone-600 mb-12 max-w-3xl mx-auto italic">Explore the evolution of jazz styles. Click on a genre to learn more.</p>
                    <div id="family-tree-wrapper">
                        <div id="family-tree-container">
                            <div id="genre-family-tree" class="family-tree">
                                <!-- Family tree will be injected here by JavaScript -->
                            </div>
                        </div>
                        <button id="tree-prev-btn" class="absolute top-1/2 -translate-y-1/2 left-0 z-10 p-2 rounded-full bg-stone-900 text-stone-100 hover:bg-orange-500 transition-all disabled:opacity-25 disabled:cursor-not-allowed hidden"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg></button>
                        <button id="tree-next-btn" class="absolute top-1/2 -translate-y-1/2 right-0 z-10 p-2 rounded-full bg-stone-900 text-stone-100 hover:bg-orange-500 transition-all disabled:opacity-25 disabled:cursor-not-allowed hidden"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg></button>
                    </div>
                </div>
            </section>

            <section id="artists" class="py-16 sm:py-20 bg-stone-200 border-y-4 border-stone-900">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center">
                    <h2 class="section-header text-5xl">Legacy Artists</h2>
                    <p class="text-center text-lg text-stone-600 mb-12 max-w-3xl mx-auto italic">Explore the musicians who carried the torch forward.</p>
                    <div id="instrument-filter-container" class="flex justify-center mb-8 hidden"><div class="w-full max-w-xs styled-select"><label for="instrument-filter" class="block text-sm font-medium text-stone-600 mb-2 text-center">Filter by Instrument:</label><select id="instrument-filter" class="block w-full rounded-sm border-2 border-stone-900 bg-stone-100 text-stone-900 py-2 pl-3 pr-10 focus:border-orange-500 focus:outline-none focus:ring-orange-500 font-bold"></select></div></div>
                    <div id="artist-slider-wrapper" class="relative w-full">
                        <div id="artist-slider-container" class="overflow-hidden min-h-[550px] md:min-h-[580px]"><div id="artist-slider-track"></div></div>
                        <div id="artist-pagination-controls" class="absolute inset-x-0 -bottom-12 flex justify-center items-center gap-4"><button id="artist-prev-btn" class="pointer-events-auto p-2 rounded-full bg-stone-900 text-stone-100 hover:bg-orange-500 transition-all disabled:opacity-25 disabled:cursor-not-allowed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg></button><span id="artist-page-indicator" class="font-bold text-lg text-stone-900 pointer-events-auto"></span><button id="artist-next-btn" class="pointer-events-auto p-2 rounded-full bg-stone-900 text-stone-100 hover:bg-orange-500 transition-all disabled:opacity-25 disabled:cursor-not-allowed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg></button></div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="bg-stone-900 text-stone-200 py-8">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <p class="font-bold">An interactive exploration based on the "Chronological Encyclopedia of Jazz".</p>
                <div class="mt-6 border-t border-stone-700 pt-6"><p id="footer-copyright" class="text-xs text-stone-400"></p></div>
            </div>
        </footer>
    </div>
    
    <div id="album-modal" class="modal fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div id="modal-content" class="modal-content bg-stone-100 border-2 border-stone-900 rounded-sm shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col transform scale-95">
            <div class="flex justify-between items-start p-4 border-b-2 border-stone-900 flex-shrink-0">
                <div><h3 id="modal-title" class="text-4xl text-orange-500"></h3><button id="modal-artist" class="text-xl text-stone-600 bg-transparent border-none p-0"></button></div>
                <button id="close-modal" class="text-4xl font-bold p-2 leading-none text-stone-500 hover:text-orange-500">×</button>
            </div>
            <div id="modal-body" class="p-6 overflow-y-auto"><div id="modal-album-main-details" class="flex flex-col md:flex-row gap-6"><div id="modal-album-art-container" class="w-full md:w-1/3 flex-shrink-0"><img id="modal-album-art" src="" class="w-full h-auto rounded-sm border-2 border-stone-900" alt="" loading="lazy"></div><div id="modal-album-details" class="w-full md:w-2/3"></div></div><div id="analysis-wrapper" class="relative mt-4"></div></div>
        </div>
    </div>
    <div id="artist-modal" class="modal fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-100 border-2 border-stone-900 rounded-sm shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col transform scale-95">
            <div class="flex justify-between items-start p-4 border-b-2 border-stone-900 flex-shrink-0"><h3 id="artist-modal-title" class="text-4xl text-orange-500"></h3><button id="close-artist-modal" class="text-4xl font-bold p-2 leading-none text-stone-500 hover:text-orange-500">×</button></div>
            <div id="artist-modal-body" class="p-6 overflow-y-auto"></div>
        </div>
    </div>
    <div id="genre-modal" class="modal fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-100 border-2 border-stone-900 rounded-sm shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col transform scale-95">
             <div class="flex justify-between items-start p-4 border-b-2 border-stone-900 flex-shrink-0">
                 <h3 id="genre-modal-title" class="text-4xl"></h3>
                 <button id="close-genre-modal" class="text-4xl font-bold p-2 leading-none text-stone-500 hover:text-orange-500">×</button>
             </div>
             <div id="genre-modal-body" class="p-6 overflow-y-auto"></div>
        </div>
    </div>

    <div id="mobile-menu-overlay" class="hidden fixed inset-0 z-50">
        <div id="mobile-menu-bg" class="fixed inset-0 bg-black opacity-50"></div>
        <div id="mobile-menu-panel" class="fixed top-0 right-0 bottom-0 bg-stone-100 w-64 shadow-lg p-4 transform translate-x-full">
            <div class="flex justify-end mb-4">
                <button id="mobile-menu-close-button" class="p-2 -mr-2 rounded-md text-stone-900 hover:bg-stone-200 focus:outline-none">
                     <svg class="h-8 w-8" stroke="currentColor" fill="none" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <nav id="mobile-nav-links" class="flex flex-col space-y-2">
                <div>
                    <button class="mobile-nav-header w-full text-left text-lg font-bold text-stone-900 hover:text-orange-500">Home</button>
                    <div class="mobile-submenu hidden pl-4 pt-2 space-y-2">
                        <a href="index.html#overview" class="mobile-nav-link block">Overview</a>
                        <a href="index.html#timeline" class="mobile-nav-link block">Timeline</a>
                        <a href="index.html#matrix" class="mobile-nav-link block">Genres</a>
                        <a href="index.html#artists" class="mobile-nav-link block">Artists</a>
                    </div>
                </div>
                <div>
                    <button class="mobile-nav-header w-full text-left text-lg font-bold text-stone-900 hover:text-orange-500">Legacy</button>
                    <div class="mobile-submenu hidden pl-4 pt-2 space-y-2">
                        <a href="legacy.html#legacy" class="mobile-nav-link block">Path Timeline</a>
                        <a href="legacy.html#artists" class="mobile-nav-link block">Legacy Artists</a>
                    </div>
                </div>
                <div>
                    <button class="mobile-nav-header w-full text-left text-lg font-bold text-stone-900 hover:text-orange-500">Reviews</button>
                    <div class="mobile-submenu hidden pl-4 pt-2 space-y-2">
                        <a href="reviews.html#news" class="mobile-nav-link block">Latest News</a>
                        <a href="reviews.html#reviews" class="mobile-nav-link block">Album Reviews</a>
                    </div>
                </div>
            </nav>
        </div>
    </div>

    <script>
        const LegacyApp = {
            state: {
                legacyData: {},
                artistProfiles: {},
                artistsData: [],
                allLegacyAlbums: [],
                fullAlbumDatabase: [],
                genreData: {},
                genreColorMap: { 'Jazz Fusion': 'var(--genre-jazz-fusion)', 'Jazz-Rock': 'var(--genre-jazz-fusion)', 'Jazz-Funk': 'var(--genre-jazz-fusion)', 'Spiritual Jazz': 'var(--genre-free-jazz)', 'Free Jazz': 'var(--genre-free-jazz)', 'Avant-Garde Jazz': 'var(--genre-avant-garde)', 'Modern Creative': 'var(--genre-avant-garde)', 'Third Stream': 'var(--genre-avant-garde)', 'ECM Style Jazz': 'var(--genre-melodic-path)', 'Smooth Jazz': 'var(--genre-melodic-path)', 'Ambient Jazz': 'var(--genre-melodic-path)', 'Afro-Jazz': 'var(--genre-post-bop)', 'Cape Jazz': 'var(--genre-post-bop)', 'Hard Bop': 'var(--genre-hard-bop)', 'Post-Bop': 'var(--genre-post-bop)', 'Neo-Bop': 'var(--genre-hard-bop)', 'default': 'var(--genre-default)' },
                currentLegacyAlbumPage: 0,
                legacyAlbumsPerPage: 0,
                totalLegacyAlbumPages: 0,
                currentArtistPage: 0,
                totalArtistPages: 0,
                currentPathArtists: [],
            },
            elements: {},
            init() {
                this.cacheDOMElements();
                for (const key in this.methods) { this.methods[key] = this.methods[key].bind(this); }
                this.fetchData();
            },
            cacheDOMElements() {
                this.elements = {
                    loader: document.getElementById('loader'),
                    pageContent: document.getElementById('page-content'),
                    pathSelectorGrid: document.getElementById('path-selector-grid'),
                    legacySliderWrapper: document.getElementById('legacy-slider-wrapper'),
                    legacySliderTitle: document.getElementById('legacy-slider-title'),
                    legacyAlbumTrack: document.getElementById('legacy-album-track'),
                    legacyPrevBtn: document.getElementById('legacy-prev-btn'),
                    legacyNextBtn: document.getElementById('legacy-next-btn'),
                    artistSliderTrack: document.getElementById('artist-slider-track'),
                    artistPaginationControls: document.getElementById('artist-pagination-controls'),
                    artistPageIndicator: document.getElementById('artist-page-indicator'),
                    albumModal: document.getElementById('album-modal'),
                    artistModal: document.getElementById('artist-modal'),
                    genreModal: document.getElementById('genre-modal'),
                    mobileMenuButton: document.getElementById('mobile-menu-button'),
                    mobileMenuOverlay: document.getElementById('mobile-menu-overlay'),
                    mobileMenuPanel: document.getElementById('mobile-menu-panel'),
                    mobileMenuCloseButton: document.getElementById('mobile-menu-close-button'),
                    footerCopyright: document.getElementById('footer-copyright'),
                    genreFamilyTree: document.getElementById('genre-family-tree'),
                    treeContainer: document.getElementById('family-tree-container'),
                    treePrevBtn: document.getElementById('tree-prev-btn'),
                    treeNextBtn: document.getElementById('tree-next-btn'),
                };
            },
            fetchData() {
                Promise.all([
                    fetch('legacy.json').then(res => res.json()),
                    fetch('artists.json').then(res => res.json()),
                    fetch('database.json').then(res => res.json()),
                    fetch('genres.json').then(res => res.json())
                ]).then(([legacyData, artistProfileData, dbData, genreData]) => {
                    this.state.legacyData = legacyData.paths;
                    this.state.artistProfiles = artistProfileData;
                    this.state.genreData = genreData;
                    
                    const normalizeGenres = (album) => {
                        if (typeof album.genres === 'string') {
                            album.genres = album.genres.split(',').map(g => g.trim());
                        } else if (!Array.isArray(album.genres)) {
                            album.genres = [];
                        }
                    };

                    dbData.albums.forEach(normalizeGenres);
                    this.state.fullAlbumDatabase = dbData.albums;

                    const allLegacyAlbums = Object.values(legacyData.paths).flatMap(path => path.albums);
                    allLegacyAlbums.forEach(normalizeGenres);
                    this.state.allLegacyAlbums = allLegacyAlbums;

                    this.initializeAppUI();
                }).catch(error => {
                    console.error('Error fetching data:', error);
                    this.elements.pageContent.innerHTML = `<div class="text-center p-8"><h2 class="text-2xl font-bold text-red-600">Failed to Load Data</h2><p class="text-stone-600 mt-2">${error.message}</p></div>`;
                    this.showPage();
                });
            },
            showPage() {
                this.elements.loader.style.display = 'none';
                this.elements.pageContent.classList.remove('content-hidden');
            },
            initializeAppUI() {
                this.methods.processArtists();
                this.methods.setupLegacySection();
                this.methods.renderGenreFamilyTree();
                this.methods.setupArtistSlider();
                this.methods.setupModals();
                this.methods.setupMobileMenu();
                this.methods.setupGeneralEventListeners();
                this.showPage();
            },
            methods: {
                getCanonicalName(name) {
                    if (!name) return '';
                    const trimmedName = name.trim();
                    if (trimmedName === 'Roland Kirk') return 'Rahsaan Roland Kirk';
                    if (trimmedName === 'Anthony Williams') return 'Tony Williams';
                    return trimmedName;
                },
                slugify(name) {
                    if (!name) return '';
                    return name.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]+/g, '').replace(/--+/g, '-').replace(/^-+/, '').replace(/-+$/, '');
                },
                processArtists() {
                    const artistsMap = new Map();
                    const allAlbums = this.state.allLegacyAlbums.concat(this.state.fullAlbumDatabase);
                    
                    allAlbums.forEach(album => {
                        const artistName = this.methods.getCanonicalName(album.artist);
                        if (!artistsMap.has(artistName)) {
                             artistsMap.set(artistName, {
                                name: artistName,
                                instruments: new Set(),
                                albums: new Set(),
                                photo: `images/${this.methods.slugify(artistName)}.jpg`,
                                profile: this.state.artistProfiles[artistName] || { name: artistName, profile: 'No profile available.' }
                            });
                        }
                        const artistEntry = artistsMap.get(artistName);
                        artistEntry.albums.add(album.albumTitle);
                        if(this.state.artistProfiles[artistName] && this.state.artistProfiles[artistName].instruments){
                            this.state.artistProfiles[artistName].instruments.forEach(inst => artistEntry.instruments.add(inst));
                        }
                    });

                    this.state.artistsData = Array.from(artistsMap.values()).map(artist => ({
                        ...artist,
                        instruments: Array.from(artist.instruments),
                        albums: Array.from(artist.albums),
                        tier: 1 
                    }));
                },
                setupLegacySection() {
                    this.methods.renderPathSelector();
                    this.elements.legacyPrevBtn.addEventListener('click', () => this.methods.moveLegacyAlbumSlide(-1));
                    this.elements.legacyNextBtn.addEventListener('click', () => this.methods.moveLegacyAlbumSlide(1));
                    const firstPathKey = Object.keys(this.state.legacyData)[0];
                    if (firstPathKey) {
                        this.methods.renderLegacyAlbumSlider(firstPathKey);
                        const firstCard = this.elements.pathSelectorGrid.querySelector('.path-selector-card');
                        if (firstCard) firstCard.classList.add('active');
                    }
                },
                getPathColor(pathData) {
                    const affinity = pathData.genreAffinity.split(', ')[0];
                    return this.state.genreColorMap[affinity] || this.state.genreColorMap['default'];
                },
                renderPathSelector() {
                    const { pathSelectorGrid } = this.elements;
                    pathSelectorGrid.innerHTML = '';
                    const pathDescriptions = { "The Electric Path": "A high-voltage fusion of jazz improvisation with the raw power of rock and funk.", "The Spiritual Path": "A quest for transcendence through sound, blending jazz with Eastern and African influences.", "The Avant-Garde Path": "A radical deconstruction of traditional music, exploring pure sound, texture, and 'energy playing.'", "The Melodic Path": "Characterized by strong, folk-like melodies and atmospheric soundscapes, favoring lyrical improvisation.", "The Afro-Jazz Path": "A conscious reconnection with the music's African and Caribbean roots, integrating traditional rhythms.", "The Neo-Bop Path": "A powerful revival of the acoustic post-bop tradition that emerged in the 1980s." };
                    Object.entries(this.state.legacyData).forEach(([pathKey, pathData]) => {
                        const card = document.createElement('div');
                        card.className = 'path-selector-card text-left';
                        card.dataset.pathKey = pathKey;
                        const pathColor = this.methods.getPathColor(pathData);
                        card.style.setProperty('--path-color', pathColor);
                        const imageSlug = pathData.title.replace('The ', '').toLowerCase().replace(/\s+/g, '-');
                        card.innerHTML = `<img src="images/${imageSlug}.jpg" alt="${pathData.title}" class="path-selector-card-img" onerror="this.onerror=null;this.src='https://placehold.co/320x160/1c1917/f5f5f4?text=Path';"><div class="path-selector-card-content"><h4 class="text-3xl font-bold">${pathData.title}</h4><p class="text-sm text-stone-600">${pathDescriptions[pathData.title] || ''}</p></div>`;
                        card.addEventListener('click', () => {
                            pathSelectorGrid.querySelectorAll('.path-selector-card').forEach(c => c.classList.remove('active'));
                            card.classList.add('active');
                            this.methods.renderLegacyAlbumSlider(pathKey);
                        });
                        pathSelectorGrid.appendChild(card);
                    });
                },
                renderLegacyAlbumSlider(pathKey) {
                    const { legacySliderWrapper, legacySliderTitle, legacyAlbumTrack } = this.elements;
                    const pathData = this.state.legacyData[pathKey];
                    if (!pathData) return;
                    legacySliderTitle.textContent = `Key Albums of ${pathData.title}`;
                    const pathColor = this.methods.getPathColor(pathData);
                    const bgColor = pathColor.startsWith('var') ? `color-mix(in srgb, ${getComputedStyle(document.documentElement).getPropertyValue(pathColor.match(/--[a-zA-Z-]+/)[0]).trim()} 15%, transparent)` : `${pathColor}26`;
                    legacySliderWrapper.style.backgroundColor = bgColor;
                    legacyAlbumTrack.innerHTML = '';
                    pathData.albums.forEach(album => {
                        const card = document.createElement('div');
                        card.className = 'legacy-album-card';
                        card.dataset.albumTitle = album.albumTitle;
                        card.dataset.artist = album.artist;
                        card.innerHTML = `<img src="${album.cover}" alt="Cover for ${album.albumTitle}" onerror="this.onerror=null;this.src='https://placehold.co/200x200/1c1917/f5f5f4?text=No+Image';"><div class="legacy-album-card-info"><h5 class="font-bold truncate">${album.albumTitle}</h5><p class="truncate">${album.artist}</p></div>`;
                        card.addEventListener('click', () => {
                            const fullAlbumData = this.state.fullAlbumDatabase.find(a => a.albumTitle === album.albumTitle && a.artist === album.artist) || this.state.allLegacyAlbums.find(a => a.albumTitle === album.albumTitle && a.artist === album.artist) || album;
                            this.methods.openAlbumModal(fullAlbumData);
                        });
                        legacyAlbumTrack.appendChild(card);
                    });
                    legacySliderWrapper.classList.remove('hidden');
                    this.state.currentLegacyAlbumPage = 0;
                    this.methods.updateLegacyAlbumSliderView();

                    const artistNames = [...new Set(pathData.albums.map(a => this.methods.getCanonicalName(a.artist)))];
                    this.state.currentPathArtists = this.state.artistsData.filter(artist => artistNames.includes(artist.name));
                    this.methods.setupArtistSlider();
                },
                updateLegacyAlbumSliderView() {
                    const { legacyAlbumTrack, legacyPrevBtn, legacyNextBtn } = this.elements;
                    const trackWrapper = document.getElementById('legacy-album-track-wrapper');
                    if (!trackWrapper) return;
                    const card = legacyAlbumTrack.querySelector('.legacy-album-card');
                    if (!card) return;
                    const cardWidth = card.offsetWidth;
                    const gap = parseInt(window.getComputedStyle(legacyAlbumTrack).gap) || 24;
                    const totalCardWidth = cardWidth + gap;
                    const visibleWidth = trackWrapper.offsetWidth;
                    this.state.legacyAlbumsPerPage = Math.floor(visibleWidth / totalCardWidth);
                    const numCards = legacyAlbumTrack.children.length;
                    this.state.totalLegacyAlbumPages = Math.max(0, numCards - this.state.legacyAlbumsPerPage);
                    this.state.currentLegacyAlbumPage = Math.max(0, Math.min(this.state.currentLegacyAlbumPage, this.state.totalLegacyAlbumPages));
                    const offset = -this.state.currentLegacyAlbumPage * totalCardWidth;
                    legacyAlbumTrack.style.transform = `translateX(${offset}px)`;
                    legacyPrevBtn.disabled = this.state.currentLegacyAlbumPage === 0;
                    legacyNextBtn.disabled = this.state.currentLegacyAlbumPage >= this.state.totalLegacyAlbumPages;
                },
                moveLegacyAlbumSlide(direction) {
                    this.state.currentLegacyAlbumPage += direction;
                    this.methods.updateLegacyAlbumSliderView();
                },
                renderGenreFamilyTree() {
                    const { genreFamilyTree } = this.elements;
                    if (!genreFamilyTree || !this.state.genreData.genres) return;

                    const treeStructure = [
                        ['Bebop', 'Cool Jazz'],
                        ['Hard Bop', 'Modal Jazz'],
                        ['Post-Bop', 'Avant-Garde', 'Free Jazz'],
                        ['Soul Jazz', 'Afro-Jazz', 'Spiritual Jazz', 'Third Stream'],
                        ['Jazz Fusion', 'Ambient Jazz', 'Jazz-Funk', 'Jazz-Rock'],
                        ['Modern Creative', 'ECM Style Jazz', 'Smooth Jazz']
                    ];
                    
                    const independentSubgenres = {
                        'Hard Bop': ['Neo-Bop'],
                        'Afro-Jazz': ['Cape Jazz']
                    };

                    const findGenreData = (name) => {
                        for (const [genreKey, genreValue] of Object.entries(this.state.genreData.genres)) {
                            if (genreKey === name) return { name, ...genreValue };
                            if (genreValue.subgenres && genreValue.subgenres[name]) {
                                const parentColor = genreValue.color || 'var(--bg-secondary)';
                                return { name, ...genreValue.subgenres[name], parent: genreKey, parentColor };
                            }
                        }
                        return null;
                    };

                    let treeHtml = '';
                    treeStructure.forEach((level) => {
                        let levelHtml = '<div class="tree-level">';
                        level.forEach(genreName => {
                            const genreInfo = findGenreData(genreName);
                            if (genreInfo) {
                                if (independentSubgenres[genreName]) {
                                    let groupHtml = `<div class="genre-group">`;
                                    groupHtml += `<div class="genre-node" data-genre-name="${genreInfo.name}" style="background-color: ${genreInfo.color || 'var(--bg-secondary)'};"><h4>${genreInfo.name}</h4></div>`;
                                    let subgenreHtml = '<div class="subgenre-container">';
                                    independentSubgenres[genreName].forEach(subName => {
                                        const subInfo = findGenreData(subName);
                                        if (subInfo) {
                                            subgenreHtml += `<div class="genre-node subgenre" data-genre-name="${subInfo.name}" style="background-color: ${genreInfo.color || 'var(--bg-secondary)'};"><h4>${subInfo.name}</h4></div>`;
                                        }
                                    });
                                    subgenreHtml += '</div>';
                                    groupHtml += subgenreHtml;
                                    groupHtml += `</div>`;
                                    levelHtml += groupHtml;
                                } else {
                                    levelHtml += `<div class="genre-node" data-genre-name="${genreInfo.name}" style="background-color: ${genreInfo.color || 'var(--bg-secondary)'};"><h4>${genreInfo.name}</h4></div>`;
                                }
                            }
                        });
                        levelHtml += '</div>';
                        treeHtml += levelHtml;
                    });

                    genreFamilyTree.innerHTML = treeHtml;
                    this.methods.setupTreeScrolling();
                },
                setupTreeScrolling() {
                    const { treeContainer, treePrevBtn, treeNextBtn } = this.elements;
                    const checkScroll = () => {
                        if (treeContainer.scrollWidth > treeContainer.clientWidth) {
                            treePrevBtn.classList.remove('hidden');
                            treeNextBtn.classList.remove('hidden');
                            treePrevBtn.disabled = treeContainer.scrollLeft === 0;
                            treeNextBtn.disabled = treeContainer.scrollLeft >= treeContainer.scrollWidth - treeContainer.clientWidth - 1;
                        } else {
                            treePrevBtn.classList.add('hidden');
                            treeNextBtn.classList.add('hidden');
                        }
                    };
                    treeContainer.addEventListener('scroll', checkScroll);
                    window.addEventListener('resize', checkScroll);
                    treePrevBtn.addEventListener('click', () => treeContainer.scrollBy({ left: -300, behavior: 'smooth' }));
                    treeNextBtn.addEventListener('click', () => treeContainer.scrollBy({ left: 300, behavior: 'smooth' }));
                    setTimeout(checkScroll, 100);
                },
                setupArtistSlider() {
                    const { artistSliderTrack, artistPaginationControls, artistPageIndicator } = this.elements;
                    const filteredArtists = [...this.state.currentPathArtists].sort((a, b) => a.name.localeCompare(b.name));
                    
                    artistSliderTrack.innerHTML = '';
                    const pageSize = window.innerWidth >= 768 ? 12 : 6;
                    this.state.totalArtistPages = Math.ceil(filteredArtists.length / pageSize);
                    artistPaginationControls.classList.toggle('hidden', this.state.totalArtistPages <= 1);

                    for (let i = 0; i < this.state.totalArtistPages; i++) {
                        const pageDiv = document.createElement('div');
                        pageDiv.className = 'artist-slider-page';
                        const pageArtists = filteredArtists.slice(i * pageSize, (i + 1) * pageSize);
                        pageArtists.forEach(artist => {
                            const card = document.createElement('div');
                            card.className = 'artist-card bandleader';
                            card.dataset.artistName = artist.name;
                            card.innerHTML = `<div class="h-56 bg-stone-900"><img src="${artist.photo}" alt="Photo of ${artist.name}" onerror="this.onerror=null;this.src='images/artistplaceholder.jpg';"></div><div class="p-3"><h4 class="font-bold text-base text-stone-900 truncate">${artist.name}</h4></div>`;
                            pageDiv.appendChild(card);
                        });
                        artistSliderTrack.appendChild(pageDiv);
                    }
                    this.methods.goToArtistPage(0);
                },
                setupModals() {
                    const { albumModal, artistModal, genreModal } = this.elements;
                    albumModal.querySelector('#close-modal').addEventListener('click', () => this.methods.closeAlbumModal());
                    albumModal.addEventListener('click', e => { 
                        if (e.target.id === 'album-modal') this.methods.closeAlbumModal(); 
                        const target = e.target.closest('.clickable-link[data-artist-name]');
                        if (target) {
                            const artistName = target.dataset.artistName;
                            const artist = this.state.artistsData.find(a => a.name === artistName);
                            if (artist) this.methods.closeAlbumModal(() => this.methods.openArtistModal(artist));
                        }
                    });
                    
                    artistModal.querySelector('#close-artist-modal').addEventListener('click', () => this.methods.closeArtistModal());
                    artistModal.addEventListener('click', e => { if (e.target.id === 'artist-modal') this.methods.closeArtistModal(); });

                    genreModal.querySelector('#close-genre-modal').addEventListener('click', () => this.methods.closeGenreModal());
                    genreModal.addEventListener('click', e => { if (e.target.id === 'genre-modal') this.methods.closeGenreModal(); });

                    document.addEventListener('keydown', e => { 
                        if (e.key === "Escape") { 
                            this.methods.closeAlbumModal(); 
                            this.methods.closeArtistModal();
                            this.methods.closeGenreModal();
                        } 
                    });
                },
                setupMobileMenu() {
                    const { mobileMenuButton, mobileMenuOverlay, mobileMenuPanel, mobileMenuCloseButton } = this.elements;
                    const openMenu = () => {
                        mobileMenuOverlay.classList.remove('hidden');
                        setTimeout(() => { mobileMenuPanel.style.transform = 'translateX(0)'; }, 10);
                    };
                    const closeMenu = () => {
                        mobileMenuPanel.style.transform = 'translateX(100%)';
                        setTimeout(() => { mobileMenuOverlay.classList.add('hidden'); }, 300);
                    };
                    mobileMenuButton.addEventListener('click', openMenu);
                    mobileMenuCloseButton.addEventListener('click', closeMenu);
                    document.getElementById('mobile-menu-bg').addEventListener('click', closeMenu);
                    document.querySelectorAll('.mobile-nav-header').forEach(header => {
                        header.addEventListener('click', () => header.nextElementSibling.classList.toggle('hidden'));
                    });
                     document.querySelectorAll('#mobile-nav-links a').forEach(link => {
                        link.addEventListener('click', (e) => {
                            const href = link.getAttribute('href');
                            if (href.startsWith('#')) {
                                e.preventDefault();
                                closeMenu();
                                const targetElement = document.querySelector(href);
                                if (targetElement) setTimeout(() => window.scrollTo({ top: targetElement.offsetTop - 80, behavior: 'smooth' }), 300);
                            }
                        });
                    });
                },
                setupGeneralEventListeners() {
                    this.elements.artistSliderTrack.addEventListener('click', (e) => {
                        const card = e.target.closest('.artist-card');
                        if (card && card.dataset.artistName) {
                            const artist = this.state.artistsData.find(a => a.name === card.dataset.artistName);
                            if (artist) this.methods.openArtistModal(artist);
                        }
                    });
                    this.elements.genreFamilyTree.addEventListener('click', (e) => {
                        const card = e.target.closest('.genre-node');
                        if (card && card.dataset.genreName) {
                            this.methods.openGenreModal(card.dataset.genreName);
                        }
                    });
                    this.elements.artistPrevBtn.addEventListener('click', () => this.methods.goToArtistPage(this.state.currentArtistPage - 1));
                    this.elements.artistNextBtn.addEventListener('click', () => this.methods.goToArtistPage(this.state.currentArtistPage + 1));
                    let resizeTimeout;
                    window.addEventListener('resize', () => {
                        clearTimeout(resizeTimeout);
                        resizeTimeout = setTimeout(() => {
                            this.methods.setupArtistSlider(this.state.currentPathArtists.map(a => a.name));
                            this.methods.updateLegacyAlbumSliderView();
                        }, 200);
                    });
                    this.elements.footerCopyright.textContent = `© ${new Date().getFullYear()} Controlled Freedom. All Rights Reserved.`;
                },
                openAlbumModal(album) {
                    const { albumModal } = this.elements;
                    albumModal.querySelector('#modal-title').textContent = album.albumTitle;
                    
                    const artistBtn = albumModal.querySelector('#modal-artist');
                    artistBtn.textContent = album.artist;
                    artistBtn.dataset.artistName = album.artist;
                    artistBtn.className = 'text-xl text-stone-600 bg-transparent border-none p-0 clickable-link';
                    
                    const modalImg = albumModal.querySelector('#modal-album-art');
                    modalImg.src = album.cover || '';
                    modalImg.alt = `Cover for ${album.albumTitle}`;
                    modalImg.onerror = function() { this.onerror=null; this.src='https://placehold.co/400x400/1c1917/f5f5f4?text=No+Image'; };
                    
                    const pivotalTrack = album.pivotalTracks && album.pivotalTracks.length > 0 ? album.pivotalTracks[0] : {};
                    
                    const genreTags = (album.genres || []).map(g => `<span class="genre-tag" style="background-color: ${this.state.genreColorMap[g.trim()] || 'var(--genre-default)'}">${g.trim()}</span>`).join(' ');

                    const lineupHtml = (pivotalTrack.lineup || 'N/A').split(/, (?![^()]*\))/).map(personnel => {
                        const match = personnel.trim().match(/(.+?)\s\((.+)\)/);
                        if (match && this.state.artistsData.some(a => a.name === this.methods.getCanonicalName(match[1].trim()))) {
                            const canonicalName = this.methods.getCanonicalName(match[1].trim());
                            return `<span class="clickable-link" data-artist-name="${canonicalName}">${canonicalName}</span> (${match[2]})`;
                        }
                        return personnel;
                    }).join(', ');

                    albumModal.querySelector('#modal-album-details').innerHTML = `<h4 class="text-3xl text-stone-900 mb-4">Album Details</h4><div class="grid grid-cols-[auto,1fr] gap-x-4 gap-y-2 text-base text-stone-900"><strong class="font-bold">Genre:</strong> <div class="flex flex-wrap gap-2">${genreTags}</div><strong class="font-bold">Recorded:</strong> <span>${pivotalTrack.recordingDate || 'N/A'}</span><strong class="font-bold">Label:</strong> <span>${pivotalTrack.label || 'N/A'}</span><strong class="font-bold align-top">Line-Up:</strong> <span>${lineupHtml}</span></div>`;
                    
                    const analysisWrapper = albumModal.querySelector('#analysis-wrapper');
                    const pivotalTracksHtml = (album.pivotalTracks || []).map(track => {
                        return `<div class="mb-8 last:mb-0">
                                    <h5 class="text-2xl font-bold text-white">Key Track: "${track.title}"</h5>
                                    <p class="liner-notes-text">${track.analysis}</p>
                                </div>`;
                    }).join('<hr class="border-stone-700 my-8">');

                    analysisWrapper.innerHTML = `<div id="modal-analysis-section">${pivotalTracksHtml || '<p class="liner-notes-text">Analysis not available.</p>'}</div>`;
                    
                    albumModal.classList.remove('opacity-0', 'pointer-events-none');
                    albumModal.querySelector('.modal-content').classList.remove('scale-95');
                },
                closeAlbumModal(callback) {
                    const { albumModal } = this.elements;
                    albumModal.classList.add('opacity-0', 'pointer-events-none');
                    albumModal.querySelector('.modal-content').classList.add('scale-95');
                    if (typeof callback === 'function') setTimeout(callback, 300);
                },
                openArtistModal(artist) {
                    const { artistModal } = this.elements;
                    const profile = artist.profile || {};
                    artistModal.querySelector('#artist-modal-title').textContent = artist.name;
                    const body = artistModal.querySelector('#artist-modal-body');
                    body.innerHTML = `<div class="flex flex-col sm:flex-row gap-6"><div class="w-full sm:w-1/3 flex-shrink-0"><img src="${artist.photo}" class="w-full h-auto rounded-sm border-2 border-stone-900" onerror="this.onerror=null;this.src='images/artistplaceholder.jpg';"><p class="mt-4 text-stone-900 text-sm"><strong class="font-bold">Instruments:</strong> ${artist.instruments.join(', ')}</p></div><div class="w-full sm:w-2/3"><h4 class="text-2xl text-stone-900 mb-2">Profile</h4><p class="text-base text-stone-700 leading-relaxed">${profile.profile || 'No profile available.'}</p></div></div>`;
                    artistModal.classList.remove('opacity-0', 'pointer-events-none');
                    artistModal.querySelector('.modal-content').classList.remove('scale-95');
                },
                closeArtistModal(callback) {
                    const { artistModal } = this.elements;
                    artistModal.classList.add('opacity-0', 'pointer-events-none');
                    artistModal.querySelector('.modal-content').classList.add('scale-95');
                    if (typeof callback === 'function') setTimeout(callback, 300);
                },
                openGenreModal(genreName) {
                    const { genreModal } = this.elements;
                    let genreInfo;
                    let parentGenreName;

                    for (const [key, value] of Object.entries(this.state.genreData.genres)) {
                        if (key === genreName) {
                            genreInfo = value;
                            break;
                        }
                        if (value.subgenres && value.subgenres[genreName]) {
                            genreInfo = value.subgenres[genreName];
                            parentGenreName = key;
                            break;
                        }
                    }
                    
                    if (!genreInfo) return;

                    const titleEl = document.getElementById('genre-modal-title');
                    titleEl.textContent = genreName;
                    const bodyEl = document.getElementById('genre-modal-body');

                    const keyArtistsHtml = genreInfo.artists ? `<p class="text-base text-stone-700 leading-relaxed">${genreInfo.artists}</p>` : '';
                    const landmarkAlbumsHtml = genreInfo.landmarkAlbums ? `<ul class="list-disc list-inside space-y-1 landmark-album-list">${genreInfo.landmarkAlbums.map(a => `<li>${a}</li>`).join('')}</ul>` : '';
                    const characteristicsHtml = genreInfo.data ? `<ul class="list-disc list-inside space-y-1 text-stone-700">
                        ${this.state.genreData.features.map((feature, i) => `<li><strong>${feature}:</strong> ${genreInfo.data[i]}</li>`).join('')}
                    </ul>` : '';

                    bodyEl.innerHTML = `
                        <div class="space-y-6">
                            ${parentGenreName ? `<p class="text-sm text-stone-500 -mt-2 mb-4">A subgenre of <strong>${parentGenreName}</strong></p>` : ''}
                            <div>
                                <h4 class="text-2xl font-bold text-stone-900 mb-2">Overview</h4>
                                <p class="text-base text-stone-700 leading-relaxed">${genreInfo.profile || 'No profile available.'}</p>
                            </div>
                            ${characteristicsHtml ? `<div><h4 class="text-2xl font-bold text-stone-900 mb-2">Key Characteristics</h4>${characteristicsHtml}</div>` : ''}
                            ${keyArtistsHtml ? `<div><h4 class="text-2xl font-bold text-stone-900 mb-2">Key Artists</h4>${keyArtistsHtml}</div>` : ''}
                            ${landmarkAlbumsHtml ? `<div><h4 class="text-2xl font-bold text-stone-900 mb-2">Landmark Albums</h4>${landmarkAlbumsHtml}</div>` : ''}
                        </div>
                    `;

                    genreModal.classList.remove('opacity-0', 'pointer-events-none');
                    genreModal.querySelector('.modal-content').classList.remove('scale-95');
                },
                closeGenreModal() {
                    const { genreModal } = this.elements;
                    genreModal.classList.add('opacity-0', 'pointer-events-none');
                    genreModal.querySelector('.modal-content').classList.add('scale-95');
                },
                populateInstrumentFilter(artists) {
                    const { instrumentFilter } = this.elements;
                    if (!instrumentFilter) return;
                    const instruments = new Set();
                    artists.forEach(artist => artist.instruments.forEach(inst => instruments.add(inst)));
                    instrumentFilter.innerHTML = '<option value="all">All Instruments</option>';
                    Array.from(instruments).sort().forEach(inst => {
                        const option = document.createElement('option');
                        option.value = inst;
                        option.textContent = inst.charAt(0).toUpperCase() + inst.slice(1);
                        instrumentFilter.appendChild(option);
                    });
                },
                goToArtistPage(pageIndex) {
                    const { artistSliderTrack, artistPrevBtn, artistNextBtn, artistPageIndicator } = this.elements;
                    this.state.currentArtistPage = Math.max(0, Math.min(pageIndex, this.state.totalArtistPages - 1));
                    artistSliderTrack.style.transform = `translateX(-${this.state.currentArtistPage * 100}%)`;
                    artistPrevBtn.disabled = this.state.currentArtistPage === 0;
                    artistNextBtn.disabled = this.state.currentArtistPage >= this.state.totalArtistPages - 1;
                    if (artistPageIndicator) {
                        artistPageIndicator.textContent = this.state.totalArtistPages > 0 ? `${this.state.currentArtistPage + 1} / ${this.state.totalArtistPages}` : '';
                    }
                },
                setupDraggable(container) {
                    if (!container) return;
                    let isDown = false, startX, scrollLeft;
                    container.addEventListener('mousedown', (e) => { isDown = true; container.style.cursor = 'grabbing'; startX = e.pageX - container.offsetLeft; scrollLeft = container.scrollLeft; });
                    container.addEventListener('mouseleave', () => { isDown = false; container.style.cursor = 'grab'; });
                    container.addEventListener('mouseup', () => { isDown = false; container.style.cursor = 'grab'; });
                    container.addEventListener('mousemove', (e) => {
                        if(!isDown) return;
                        e.preventDefault();
                        const x = e.pageX - container.offsetLeft;
                        const walk = (x - startX) * 2;
                        container.scrollLeft = scrollLeft - walk;
                    });
                },
            }
        };
        document.addEventListener('DOMContentLoaded', () => LegacyApp.init());
    </script>
</body>
</html>
