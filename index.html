<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controlled Freedom: An Interactive Jazz Encyclopedia</title>
    
    <!-- External Libraries & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;700;900&family=Lora:ital,wght@0,400;0,600;1,400;1,600&display=swap" rel="stylesheet">
    
    <!-- Custom CSS Styling -->
    <style>
        :root {
            --bg-main: #f5f5f4; --bg-secondary: #e7e5e4; --bg-dark: #1a1a1a; --text-main: #1c1917; --text-muted: #44403c; --accent: #f97316; --accent-dark: #ea580c; --yellow-accent: #facc15;
            --genre-bebop: #C19A6B; --genre-hard-bop: #d8b4fe; --genre-cool-jazz: #93c5fd; --genre-modal-jazz: #a7f3d0; --genre-post-bop: #fed7aa; --genre-free-jazz: #fca5a5; --genre-avant-garde: #fecdd3; --genre-jazz-fusion: #a5f3fc; --genre-default: #e7e5e4;
            --era-cool-light: #dbeafe; --era-hard-bop-light: #f3e8ff; --era-bebop-light: #EADDCA; --era-modal-light: #d1fae5; --era-post-bop-light: #ffedd5; --era-free-jazz-light: #fee2e2; --era-roots-light: #fef9c3; --era-fusion-light: #cffafe;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-main); color: var(--text-main); }
        h1, h2, h3, h4, h5 { font-family: 'Bebas Neue', sans-serif; letter-spacing: 0.05em; }
        .nav-link { transition: color 0.2s; font-family: 'Bebas Neue', sans-serif; letter-spacing: 0.1em; font-size: 1.2rem; }
        .nav-link:hover, .nav-link.active { color: var(--accent); }
        .section-header { transform: rotate(-1deg); display: inline-block; background-color: var(--accent); color: var(--bg-main); padding: 0.25rem 1rem; margin-bottom: 1rem; }
        #genre-matrix-container { border: 2px solid var(--text-main); border-radius: 0.25rem; overflow: auto; max-height: 70vh; background-color: var(--bg-main); }
        .matrix-table { border-collapse: collapse; width: 100%; min-width: 800px; }
        .matrix-table th, .matrix-table td { padding: 1rem; border-bottom: 2px solid var(--bg-secondary); text-align: left; vertical-align: top; }
        .matrix-table thead th { background-color: var(--text-main); color: var(--bg-main); position: sticky; top: 0; z-index: 10; }
        .matrix-table tbody th { font-family: 'Bebas Neue', sans-serif; font-size: 1.25rem; width: 150px; position: sticky; left: 0; z-index: 5; border-right: 2px solid var(--bg-secondary); }
        .genre-header-button { display: flex; align-items: center; justify-content: space-between; width: 100%; text-align: left; background: none; border: none; padding: 0; cursor: pointer; font-size: inherit; font-weight: inherit; color: inherit; }
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease-out, opacity 0.3s ease-out; }
        #horizontal-timeline-container { position: relative; width: 100%; overflow-x: auto; cursor: grab; border: none; -ms-overflow-style: none; scrollbar-width: none; }
        #horizontal-timeline-container::-webkit-scrollbar { display: none; }
        #timeline-wrapper { position: relative; display: inline-flex; align-items: flex-start; padding: 2rem 1rem; padding-top: 5rem; z-index: 2; }
        .timeline-year-section { display: flex; flex-shrink: 0; flex-direction: column; align-items: center; border-left: 4px dotted #a8a29e; padding: 0 2rem; }
        .timeline-album-list { display: grid; grid-template-rows: repeat(2, 1fr); grid-auto-flow: column; gap: 1.5rem; min-height: 520px; }
        .timeline-album-card { width: 200px; flex-shrink: 0; background-color: var(--bg-main); border-radius: 0.25rem; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease; box-shadow: 4px 4px 0px var(--text-main); border: 2px solid var(--text-main); overflow: hidden; }
        .timeline-album-card:hover { transform: translateY(-5px) rotate(2deg); }
        .timeline-album-card.dimmed { opacity: 0.5; }
        .timeline-album-card.highlighted { opacity: 1; box-shadow: 8px 8px 0px var(--highlight-color, var(--accent)); }
        .timeline-album-card.clicked { transform: translateY(-5px) rotate(2deg) scale(1.05); box-shadow: 8px 8px 0px var(--accent) !important; opacity: 1 !important; z-index: 10; }
        .timeline-album-card.landmark-album { border-width: 4px; border-color: var(--landmark-color, var(--accent)); box-shadow: 0 0 15px 0px var(--landmark-color, var(--accent)); }
        .timeline-album-card img { width: 100%; height: 200px; object-fit: cover; filter: grayscale(100%); transition: filter 0.3s ease; }
        .timeline-album-card:hover img, .timeline-album-card.highlighted img, .timeline-album-card.clicked img { filter: grayscale(0%); }
        .timeline-album-card-info { padding: 0.75rem; }
        .artist-card { background-color: var(--bg-main); border-radius: 0.25rem; overflow: hidden; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; box-shadow: 4px 4px 0px var(--text-main); border: 2px solid var(--text-main); }
        .artist-card:hover { transform: translateY(-5px) rotate(2deg); box-shadow: 8px 8px 0px var(--accent) !important; }
        .artist-card.bandleader { box-shadow: 4px 4px 0px var(--accent); }
        .artist-card.influential-sideman { box-shadow: 4px 4px 0px var(--yellow-accent); }
        .artist-card img { width: 100%; height: 224px; object-fit: cover; object-position: center; filter: grayscale(100%); transition: filter 0.3s ease; }
        .artist-card:hover img { filter: grayscale(0%); }
        #artist-slider-track { display: flex; transition: transform 0.5s ease-in-out; }
        .artist-slider-page { width: 100%; flex-shrink: 0; display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; }
        @media (min-width: 768px) { .artist-slider-page { grid-template-columns: repeat(6, 1fr); } }
        .styled-select select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23f97316' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.7rem center; background-size: 1.2em; }
        #modal-analysis-section { background-color: var(--bg-dark); padding: 1.5rem; margin-top: 2rem; border: 2px solid var(--text-main); box-shadow: 4px 4px 0px var(--text-main); }
        #modal-analysis-section h5 { color: var(--bg-main); }
        .liner-notes-text { font-family: 'Lora', serif; font-size: 1rem; line-height: 1.6; color: #d4d4d2; }
        audio.styled-player { height: 35px; accent-color: var(--accent); }
        .genre-checkbox-label { display: flex; align-items: center; cursor: pointer; font-size: 0.875rem; font-weight: 600; padding: 0.5rem 1rem; border: 2px solid var(--text-main); border-radius: 9999px; background-color: var(--bg-main); transition: all 0.2s ease; }
        .genre-checkbox-label input { display: none; }
        .genre-checkbox-label:has(input:checked) { background-color: var(--genre-color, var(--accent)); color: var(--text-main); }
        #loader { position: fixed; inset: 0; background-color: var(--bg-main); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .loader-spinner { border: 4px solid var(--bg-secondary); border-top: 4px solid var(--accent); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .content-hidden { display: none; }
        .genre-tag { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 600; color: var(--text-main); border: 2px solid var(--text-main); }
        .clickable-link { cursor: pointer; text-decoration: underline; text-decoration-color: var(--accent); }
        .fade-in-element { opacity: 0; transform: translateY(20px); transition: opacity 0.5s ease-out, transform 0.5s ease-out; }
        .fade-in-element.is-visible { opacity: 1; transform: translateY(0); }
        .title-rotate { transform: rotate(-1.5deg); }
        .nav-bar-hidden-behaviour { display: flex; transform: rotate(-1.5deg); }
        @media (max-width: 768px) { .nav-bar-hidden-behaviour { display: none; } }
        #mobile-menu-panel { transition: transform 0.3s ease-in-out; }
        #mobile-menu-overlay.hidden #mobile-menu-panel { transform: translateX(100%); }
        .artist-modal-timeline { list-style: none; padding-left: 1rem; border-left: 2px solid var(--bg-secondary); }
        .artist-modal-timeline-item { position: relative; padding-bottom: 1rem; padding-left: 1.5rem; }
        .artist-modal-timeline-item::before { content: ''; position: absolute; left: -0.4rem; top: 0.25rem; width: 0.65rem; height: 0.65rem; border-radius: 9999px; background-color: var(--bg-secondary); border: 2px solid var(--text-main); }
        .era-section { padding-top: 1.5rem; padding-bottom: 2rem; border-left: 4px solid var(--text-main); display: flex; flex-direction: row; }
        .era-content { display: flex; flex-direction: row; align-items: flex-start; }

        /* NEW Dropdown Styles */
        .dropdown-menu {
            background-color: var(--bg-main);
            border: 2px solid var(--text-main);
            box-shadow: 4px 4px 0px var(--text-main);
            margin-top: 1.75rem;
            transform: rotate(1.5deg);
            transform-origin: top left;
        }
        .dropdown-menu a {
            font-family: 'Inter', sans-serif;
            letter-spacing: normal;
            font-size: 1rem;
            display: block;
            padding: 0.5rem 1.5rem;
            color: var(--text-muted);
            transition: all 0.2s;
        }
        .dropdown-menu a:hover {
            background-color: var(--accent);
            color: var(--bg-main);
            transform: translateX(5px);
        }
    </style>
</head>
<body class="bg-stone-100 text-stone-900">

    <div id="loader"><div class="loader-spinner"></div></div>

    <div id="page-content" class="content-hidden">
        <!-- HEADER -->
        <div class="sticky top-0 z-50 h-24">
            <header class="relative container mx-auto h-full">
                <div class="absolute inset-x-0 top-4 h-20 bg-stone-100 border-2 border-stone-900" style="transform: rotate(-1.5deg); box-shadow: 5px 5px 0px var(--text-main); z-index: 1;"></div>
                <nav class="relative z-10 flex items-center justify-between h-full px-4 sm:px-6 lg:px-8">
                    <div class="title-rotate flex-shrink-0 mt-12 sm:mt-10">
                        <a href="#"><img src="images/logo.svg" alt="Controlled Freedom Logo" class="h-16 sm:h-20"></a>
                    </div>
                    <!-- Desktop Navigation -->
                    <div class="nav-bar-hidden-behaviour sm:items-center sm:space-x-8">
                        <div class="relative group">
                            <a href="#" class="nav-link active px-3 py-2 rounded-md font-medium text-stone-600">Home</a>
                            <div class="absolute hidden group-hover:block pt-2 z-10">
                                <div class="dropdown-menu rounded-sm py-2">
                                    <a href="#overview">Overview</a>
                                    <a href="#timeline">Timeline</a>
                                    <a href="#matrix">Genres</a>
                                    <a href="#artists">Artists</a>
                                </div>
                            </div>
                        </div>
                        <div class="relative group">
                            <a href="legacy.html" class="nav-link px-3 py-2 rounded-md font-medium text-stone-600">Legacy</a>
                            <div class="absolute hidden group-hover:block pt-2 z-10">
                                <div class="dropdown-menu rounded-sm py-2">
                                    <a href="legacy.html#legacy">Path Timeline</a>
                                    <a href="legacy.html#artists">Legacy Artists</a>
                                </div>
                            </div>
                        </div>
                        <a href="reviews.html" class="nav-link px-3 py-2 rounded-md font-medium text-stone-600">Reviews</a>
                    </div>
                    <!-- Hamburger Menu Button -->
                    <div class="sm:hidden">
                        <button id="mobile-menu-button" class="p-2 -mr-2 rounded-md text-stone-900 hover:bg-stone-200 focus:outline-none">
                            <svg class="h-8 w-8" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        </button>
                    </div>
                </nav>
            </header>
        </div>

        <main class="-mt-24">
            <section id="banner" class="relative w-full h-60 md:h-72 lg:h-80">
                <img src="images/banner.jpg" alt="Post-bop musicians in a rehearsal space" class="w-full h-full object-cover" loading="lazy" onerror="this.onerror=null;this.src='https://images.unsplash.com/photo-1511192336575-5a79af67d629?q=80&w=2074&auto=format&fit=crop';">
                <div class="absolute inset-x-0 bottom-0 h-full bg-gradient-to-t from-stone-100 to-transparent"></div>
            </section>

            <section id="overview" class="pt-12 pb-16 sm:pb-20 bg-stone-100">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-6xl">
                    <div class="grid md:grid-cols-5 gap-12 items-start">
                        <div class="md:col-span-3 space-y-6 text-base md:text-lg leading-relaxed text-stone-900 text-left">
                            <div class="mb-8"><h2 class="section-header text-5xl">A Jazz Evolution Encyclopedia</h2><p class="text-lg text-stone-600 mt-4 italic">Follow the development of modern jazz through the 50s and 60s.</p></div>
                            <p>The period between 1950 and 1969 represents the most accelerated and dynamic evolution in jazz history. From the virtuosic fire of <strong>Bebop</strong>, the music branched into myriad new forms. Some musicians pursued the soulful, blues-drenched energy of <strong>Hard Bop</strong>, while others explored the harmonically rich, restrained arrangements of <strong>Cool Jazz</strong>.</p>
                            <p>At the heart of this era lies the central theme of <strong style="color: var(--accent);">"controlled freedom."</strong> The philosophy of <strong>Post-Bop</strong> sought a middle ground between dense structures and the radical abandon of the burgeoning <strong>Free Jazz</strong> and <strong>Avant-Garde</strong> scenes, introducing new harmonic and rhythmic complexity while still retaining elements of form and melody.</p>
                            <p>This application provides an interactive journey through this interconnected history, ordered by recording date—not release date—to understand the influence exercised between all these musicians and <strong>reveal the authentic path of jazz evolution as it happened.</strong></p>
                        </div>
                        <div class="md:col-span-2 mt-8 md:mt-0">
                            <div id="on-this-day" class="mb-8"></div>
                            <iframe style="border-radius:12px" src="https://open.spotify.com/embed/playlist/6nFqx9JIZD29Qxccp6mh4N?utm_source=generator" width="100%" height="352" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
                        </div>
                    </div>
                </div>
            </section>

            <section id="timeline" class="py-16 sm:py-20 bg-stone-200 border-y-4 border-stone-900">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center">
                    <h2 class="section-header text-5xl">Timeline Explorer</h2>
                    <p class="text-center text-lg text-stone-600 mb-8 max-w-3xl mx-auto italic">Use the filters to explore a year-by-year breakdown of landmark albums.</p>
                    <div id="timeline-controls" class="flex flex-col items-center justify-center gap-4 mb-8"><div id="genre-filter-container" class="flex flex-wrap justify-center gap-x-4 gap-y-3"></div></div>
                    <div class="relative group">
                        <div id="sticky-header-display" class="absolute top-4 left-1 sm:left-4 flex items-end gap-x-3 pointer-events-none z-10"><div id="sticky-year-display" class="font-black text-orange-500 text-5xl leading-none"></div><h3 id="sticky-era-title" class="font-black text-stone-500 text-3xl leading-tight pb-1"></h3></div>
                        <div id="horizontal-timeline-container" class="min-h-[600px] flex items-center"><canvas id="timeline-canvas"></canvas><div id="timeline-wrapper"></div></div>
                        <button id="scroll-left-btn" class="absolute left-0 sm:-left-4 top-1/2 -translate-y-1/2 z-20 p-2 rounded-full bg-stone-900 text-stone-100 hover:bg-orange-500 transition-all"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg></button>
                        <button id="scroll-right-btn" class="absolute right-0 sm:-right-4 top-1/2 -translate-y-1/2 z-20 p-2 rounded-full bg-stone-900 text-stone-100 hover:bg-orange-500 transition-all"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg></button>
                    </div>
                    <div class="mt-6"><div id="custom-scrollbar" class="w-full h-3 bg-stone-300 rounded-full cursor-pointer relative"><div id="custom-scrollbar-markers"></div><div id="custom-scrollbar-thumb" class="h-full bg-stone-800 rounded-full absolute top-0 cursor-grab"></div></div></div>
                </div>
            </section>

            <section id="matrix" class="py-16 sm:py-20">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center">
                    <h2 class="section-header text-5xl">The Genres</h2>
                    <p class="text-center text-lg text-stone-600 mb-12 max-w-3xl mx-auto italic">Compare the main aspects of each style.</p>
                    <div id="genre-matrix-container" class="matrix-container max-w-6xl mx-auto"><table id="style-matrix-table" class="matrix-table"></table></div>
                </div>
            </section>

            <section id="artists" class="py-16 sm:py-20 bg-stone-200 border-y-4 border-stone-900">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center">
                    <h2 class="section-header text-5xl">The Architects</h2>
                    <p class="text-center text-lg text-stone-600 mb-12 max-w-3xl mx-auto italic">Explore the musicians who defined an era.</p>
                    <div class="flex justify-center mb-8"><div class="w-full max-w-xs styled-select"><label for="instrument-filter" class="block text-sm font-medium text-stone-600 mb-2 text-center">Filter by Instrument:</label><select id="instrument-filter" class="block w-full rounded-sm border-2 border-stone-900 bg-stone-100 text-stone-900 py-2 pl-3 pr-10 focus:border-orange-500 focus:outline-none focus:ring-orange-500 font-bold"></select></div></div>
                    <div id="artist-slider-wrapper" class="relative">
                        <div id="artist-slider-container" class="min-h-[550px] md:min-h-[580px]"><div id="artist-slider-track"></div></div>
                        <div id="artist-pagination-controls" class="absolute inset-x-0 -bottom-12 flex justify-center items-center gap-4"><button id="artist-prev-btn" class="pointer-events-auto p-2 rounded-full bg-stone-900 text-stone-100 hover:bg-orange-500 transition-all disabled:opacity-25 disabled:cursor-not-allowed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg></button><span id="artist-page-indicator" class="font-bold text-lg text-stone-900 pointer-events-auto"></span><button id="artist-next-btn" class="pointer-events-auto p-2 rounded-full bg-stone-900 text-stone-100 hover:bg-orange-500 transition-all disabled:opacity-25 disabled:cursor-not-allowed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg></button></div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="bg-stone-900 text-stone-200 py-8">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <p class="font-bold">An interactive exploration based on the "Chronological Encyclopedia of Jazz".</p>
                <p class="text-sm text-stone-400 mt-2">Designed to bring music history to life through interactive data visualization.</p>
                <div class="mt-6 border-t border-stone-700 pt-6"><p id="footer-copyright" class="text-xs text-stone-400"></p><p class="text-xs text-stone-500 mt-2">Disclaimer: All music and images are the property of their respective copyright holders. This is a non-profit project for educational purposes only.</p></div>
            </div>
        </footer>
    </div>
    
    <!-- Modals -->
    <div id="album-modal" class="modal fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div id="modal-content" class="modal-content bg-stone-100 border-2 border-stone-900 rounded-sm shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col transform scale-95">
            <div class="flex justify-between items-start p-4 border-b-2 border-stone-900 flex-shrink-0">
                <div><h3 id="modal-title" class="text-4xl text-orange-500"></h3><button id="modal-artist" class="text-xl text-stone-600 bg-transparent border-none p-0"></button></div>
                <button id="close-modal" class="text-4xl font-bold p-2 leading-none text-stone-500 hover:text-orange-500">×</button>
            </div>
            <div id="modal-body" class="p-6 overflow-y-auto">
                <div id="modal-album-main-details" class="flex flex-col md:flex-row gap-6">
                    <div id="modal-album-art-container" class="w-full md:w-1/3 flex-shrink-0"><img id="modal-album-art" src="" class="w-full h-auto rounded-sm border-2 border-stone-900" alt="" loading="lazy"></div>
                    <div id="modal-album-details" class="w-full md:w-2/3"></div>
                </div>
                <div id="analysis-wrapper" class="relative mt-4"></div>
            </div>
            <div id="modal-nav-footer" class="flex justify-between items-center p-4 border-t-2 border-stone-900 flex-shrink-0 bg-stone-200">
                <button id="prev-album-btn" class="px-4 py-2 bg-stone-900 text-stone-100 rounded-sm font-bold hover:bg-orange-500 transition-colors disabled:bg-stone-400 disabled:cursor-not-allowed">Previous Album</button>
                <button id="next-album-btn" class="px-4 py-2 bg-stone-900 text-stone-100 rounded-sm font-bold hover:bg-orange-500 transition-colors disabled:bg-stone-400 disabled:cursor-not-allowed">Next Album</button>
            </div>
        </div>
    </div>
    <div id="artist-modal" class="modal fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-100 border-2 border-stone-900 rounded-sm shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col transform scale-95">
            <div class="flex justify-between items-start p-4 border-b-2 border-stone-900 flex-shrink-0"><h3 id="artist-modal-title" class="text-4xl text-orange-500"></h3><button id="close-artist-modal" class="text-4xl font-bold p-2 leading-none text-stone-500 hover:text-orange-500">×</button></div>
            <div id="artist-modal-body" class="p-6 overflow-y-auto"></div>
        </div>
    </div>
    <div id="genre-modal" class="modal fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-100 border-2 border-stone-900 rounded-sm shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col transform scale-95">
            <div class="flex justify-between items-start p-4 border-b-2 border-stone-900 flex-shrink-0"><h3 id="genre-modal-title" class="text-4xl"></h3><button id="close-genre-modal" class="text-4xl font-bold p-2 leading-none text-stone-500 hover:text-orange-500">×</button></div>
            <div id="genre-modal-body" class="p-6 overflow-y-auto"></div>
        </div>
    </div>

    <!-- Mobile Menu Overlay -->
    <div id="mobile-menu-overlay" class="hidden fixed inset-0 z-50">
        <div id="mobile-menu-bg" class="fixed inset-0 bg-black opacity-50"></div>
        <div id="mobile-menu-panel" class="fixed top-0 right-0 bottom-0 bg-stone-100 w-64 shadow-lg p-4 transform translate-x-full">
            <div class="flex justify-end mb-4"><button id="mobile-menu-close-button" class="p-2 -mr-2 rounded-md text-stone-900 hover:bg-stone-200 focus:outline-none"><svg class="h-8 w-8" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div>
            <nav id="mobile-nav-links" class="flex flex-col space-y-2">
                 <div>
                    <button class="mobile-nav-header w-full text-left text-lg font-bold text-stone-900 hover:text-orange-500">Home</button>
                    <div class="mobile-submenu pl-4 pt-2 space-y-2">
                        <a href="#overview" class="mobile-nav-link block">Overview</a>
                        <a href="#timeline" class="mobile-nav-link block">Timeline</a>
                        <a href="#matrix" class="mobile-nav-link block">Genres</a>
                        <a href="#artists" class="mobile-nav-link block">Artists</a>
                    </div>
                </div>
                 <div>
                    <button class="mobile-nav-header w-full text-left text-lg font-bold text-stone-900 hover:text-orange-500">Legacy</button>
                    <div class="mobile-submenu hidden pl-4 pt-2 space-y-2">
                        <a href="legacy.html#legacy" class="mobile-nav-link block">Path Timeline</a>
                        <a href="legacy.html#artists" class="mobile-nav-link block">Legacy Artists</a>
                    </div>
                </div>
                <a href="reviews.html" class="text-lg font-bold text-stone-900 hover:text-orange-500">Reviews</a>
            </nav>
        </div>
    </div>

    <script id="styleMatrixData" type="application/json">
    {
        "features": ["Harmony", "Rhythm", "Form"],
        "genres": {
            "Bebop": { "profile": "The furious, intellectual, and virtuosic revolution of the 1940s that became the foundation for all modern jazz...", "color": "var(--genre-bebop)", "data": ["Fast-moving, complex chord progressions...", "Blistering tempos...", "Often based on standard song forms..."], "artists": "Charlie Parker, Dizzy Gillespie, Thelonious Monk, Bud Powell", "landmarkAlbums": ["Bird and Diz", "Sonny Side Up", "The Amazing Bud Powell, Vol. 1", "Lester Young with the Oscar Peterson Trio", "Jazz At Massey Hall", "For Musicians Only"] },
            "Hard Bop": { "profile": "Evolving from bebop in the mid-1950s, Hard Bop re-injected the music with the earthy, soulful, and danceable influences of blues and gospel...", "color": "var(--genre-hard-bop)", "data": ["Functional (ii-V-I), blues-based, gospel influences", "Strong, driving swing feel...", "Standard forms (AABA, 12-bar blues)..."], "artists": "Art Blakey, Horace Silver, Clifford Brown, Lee Morgan", "landmarkAlbums": ["Moanin'", "Study in Brown", "Saxophone Colossus", "Monk's Music", "Blue Train", "Giant Steps", "Brilliant Corners", "Song For My Father", "Money Jungle", "Mosaic", "The Sidewinder", "The Blues and the Abstract Truth", "Clifford Brown and Max Roach", "Cool Struttin'", "Soul Station", "The Cooker", "Go", "The Scene Changes"] },
            "Cool Jazz": { "profile": "A reaction to the frenetic energy of bebop, Cool Jazz emerged in the late 1940s and 50s with a more relaxed, subdued, and lyrical approach...", "color": "var(--genre-cool-jazz)", "data": ["More complex, often drawing from classical harmony...", "Relaxed, subtle pulse...", "Often employed complex, contrapuntal arrangements..."], "artists": "Miles Davis (early), Dave Brubeck, Stan Getz, Gerry Mulligan", "landmarkAlbums": ["Birth of the Cool", "Dexter Blows Hot and Cool", "Portrait in Jazz", "Time Out", "Somethin' Else", "Out of the Cool", "'Round About Midnight", "Everybody Digs Bill Evans"] },
            "Modal Jazz": { "profile": "A revolutionary approach pioneered in the late 1950s, Modal Jazz liberated improvisers by focusing on static scales (or modes) for long stretches...", "color": "var(--genre-modal-jazz)", "data": ["Static harmony, based on modes/scales...", "Floating, ambiguous pulse...", "Open-ended, simple structures..."], "artists": "Miles Davis, John Coltrane, Bill Evans", "landmarkAlbums": ["Kind of Blue", "My Favorite Things", "Maiden Voyage", "Waltz for Debby", "Idle Moments", "Africa / Brass", "Olé Coltrane", "Juju", "Miles Smiles", "Milestones"] },
            "Post-Bop": { "profile": "The adventurous middle ground of the 1960s, Post-Bop took the harmonic complexity of bebop and the freedom of modal jazz and fused them with elements of the avant-garde...", "color": "var(--genre-post-bop)", "data": ["Expanded functional harmony...", "Highly interactive, fluid time...", "Modified standard forms..."], "artists": "Miles Davis's 2nd Quintet, Wayne Shorter, Herbie Hancock, Andrew Hill", "landmarkAlbums": ["Mingus Ah Um", "Astigmatic", "Destination... Out!", "Free For All", "Speak No Evil", "Empyrean Isles", "Contours", "Dialogue", "Inner Urge"] },
            "Avant-Garde": { "profile": "The 'Avant-Garde' describes a forward-thinking movement where musicians sought to challenge and expand the conventions of jazz...", "color": "var(--genre-avant-garde)", "data": ["Can include complex, atonal composed sections...", "Ranges from free, pulseless textures...", "Often features through-composed suites..."], "artists": "Eric Dolphy, Andrew Hill, Grachan Moncur III, Sun Ra", "landmarkAlbums": ["The Black Saint and the Sinner Lady", "Out to Lunch!", "The Shape of Jazz to Come", "Point of Departure", "A Love Supreme", "Karma", "We Insist! Max Roach's Freedom Now Suite", "Change of the Century"] },
            "Free Jazz": { "profile": "The most radical departure of the era, Free Jazz, pioneered by artists like Ornette Coleman, often abandoned preset chord changes, tempos, and forms altogether...", "color": "var(--genre-free-jazz)", "data": ["Abandons conventional chord progressions...", "Often abandons a steady pulse...", "Open forms..."], "artists": "Ornette Coleman, Albert Ayler, Cecil Taylor, Pharoah Sanders", "landmarkAlbums": ["Ascension", "Free Jazz", "Spiritual Unity", "Conquistador!", "Eternal Rhythm", "Compulsion!!!!!", "Black Woman", "The Magic of Ju-Ju"] },
            "Jazz Fusion": { "profile": "Emerging in the late 1960s, Jazz Fusion plugged jazz into the amplifier, incorporating the powerful rhythms of rock and funk...", "color": "var(--genre-jazz-fusion)", "data": ["Electric piano (Rhodes, Wurlitzer)...", "Driving, straight-eighth rock and funk grooves...", "Extended, often through-composed forms..."], "artists": "Miles Davis, Herbie Hancock, Weather Report, Mahavishnu Orchestra", "landmarkAlbums": ["In a Silent Way", "Bitches Brew"] }
        }
    }
    </script>
    
    <script>
        const JazzApp = {
            state: {
                albums: [], artistProfiles: {}, artistsData: [], styleMatrix: {}, visibleAlbums: [],
                eras: [
                    { title: "Cool & Bebop Foundations", startYear: 1950, endYear: 1953, color: 'var(--era-cool-light)' },
                    { title: "Hard Bop Explosion", startYear: 1954, endYear: 1956, color: 'var(--era-hard-bop-light)' },
                    { title: "Hard Bop At Its Peak", startYear: 1957, endYear: 1958, color: 'var(--era-bebop-light)' },
                    { title: "Modal and Structural Expansion", startYear: 1959, endYear: 1961, color: 'var(--era-modal-light)' },
                    { title: "Post-Bop Evolution", startYear: 1962, endYear: 1963, color: 'var(--era-post-bop-light)' },
                    { title: "Spiritual Awakening", startYear: 1964, endYear: 1966, color: 'var(--era-free-jazz-light)' },
                    { title: "Search for the Roots", startYear: 1967, endYear: 1968, color: 'var(--era-roots-light)' },
                    { title: "Fusion Breakthrough", startYear: 1969, endYear: 1969, color: 'var(--era-fusion-light)' }
                ],
                currentVisibleAlbumIndex: -1, currentArtistPage: 0, totalArtistPages: 0,
                lastKnownYear: '', lastKnownEraTitle: '', mobileCardSelectedForModal: null, lastHoveredGenre: null,
            },
            elements: {},
            init() {
                this.cacheDOMElements();
                for (const key in this.methods) { this.methods[key] = this.methods[key].bind(this); }
                this.fetchData();
            },
            cacheDOMElements() {
                this.elements = {
                    loader: document.getElementById('loader'), pageContent: document.getElementById('page-content'),
                    timelineContainer: document.getElementById('horizontal-timeline-container'), timelineWrapper: document.getElementById('timeline-wrapper'),
                    timelineCanvas: document.getElementById('timeline-canvas'), scrollLeftBtn: document.getElementById('scroll-left-btn'),
                    scrollRightBtn: document.getElementById('scroll-right-btn'), genreFilterContainer: document.getElementById('genre-filter-container'),
                    stickyYearDisplay: document.getElementById('sticky-year-display'), stickyEraTitle: document.getElementById('sticky-era-title'),
                    albumModal: document.getElementById('album-modal'), artistModal: document.getElementById('artist-modal'),
                    genreModal: document.getElementById('genre-modal'), instrumentFilter: document.getElementById('instrument-filter'),
                    artistSliderTrack: document.getElementById('artist-slider-track'), artistPrevBtn: document.getElementById('artist-prev-btn'),
                    artistNextBtn: document.getElementById('artist-next-btn'), artistPaginationControls: document.getElementById('artist-pagination-controls'),
                    artistPageIndicator: document.getElementById('artist-page-indicator'), matrixContainer: document.getElementById('style-matrix-table'),
                    customScrollbar: document.getElementById('custom-scrollbar'), customScrollbarThumb: document.getElementById('custom-scrollbar-thumb'),
                    customScrollbarMarkers: document.getElementById('custom-scrollbar-markers'), mobileMenuButton: document.getElementById('mobile-menu-button'),
                    mobileMenuOverlay: document.getElementById('mobile-menu-overlay'), mobileMenuPanel: document.getElementById('mobile-menu-panel'),
                    mobileMenuCloseButton: document.getElementById('mobile-menu-close-button'), mobileNavLinks: document.querySelectorAll('.mobile-nav-link'),
                    sections: document.querySelectorAll('main section[id]'), navLinks: document.querySelectorAll('header nav a.nav-link'),
                    footerCopyright: document.getElementById('footer-copyright'), onThisDayContainer: document.getElementById('on-this-day'),
                    mobileNavHeaders: document.querySelectorAll('.mobile-nav-header'),
                };
            },
            fetchData() {
                this.state.styleMatrix = JSON.parse(document.getElementById('styleMatrixData').textContent);
                Promise.all([
                    fetch('database.json').then(res => res.json()),
                    fetch('artists.json').then(res => res.json()),
                ]).then(([dbData, artistProfileData]) => {
                    this.state.albums = dbData.albums;
                    this.state.albums.forEach(album => {
                        if (typeof album.genres === 'string') album.genres = album.genres.split(',').map(g => g.trim());
                        else if (!Array.isArray(album.genres)) album.genres = [];
                    });
                    this.state.artistProfiles = artistProfileData;
                    this.initializeAppUI();
                }).catch(error => {
                    console.error('Error fetching data:', error);
                    this.elements.pageContent.innerHTML = `<div class="text-center p-8"><h2 class="text-2xl font-bold text-red-600">Failed to Load Data</h2><p>Could not fetch required data files.</p></div>`;
                    this.showPage();
                });
            },
            showPage() {
                this.elements.loader.style.display = 'none';
                this.elements.pageContent.classList.remove('content-hidden');
            },
            initializeAppUI() {
                this.methods.processAndSortData();
                this.methods.buildGenreColorMap();
                this.methods.setupFilters();
                this.methods.renderTimeline();
                this.methods.setupTimelineInteraction();
                this.methods.setupModals();
                this.methods.setupArtistSlider();
                this.methods.buildGenreMatrix();
                this.methods.setupMobileMenu();
                this.methods.setupScrollObservers();
                this.methods.setupGeneralEventListeners();
                this.methods.renderScrollbarMarkers();
                this.methods.setupOnThisDayFeature();
                this.showPage();
                setTimeout(() => { if(this.elements.timelineContainer) this.elements.timelineContainer.scrollLeft = 0; }, 0);
            },
            methods: {
                getCanonicalName(name) {
                    if (!name) return '';
                    const trimmedName = name.trim();
                    if (trimmedName === 'Roland Kirk') return 'Rahsaan Roland Kirk';
                    if (trimmedName === 'Anthony Williams') return 'Tony Williams';
                    return trimmedName;
                },
                processAndSortData() {
                    const monthMap = { "January": 0, "February": 1, "March": 2, "April": 3, "May": 4, "June": 5, "July": 6, "August": 7, "September": 8, "October": 9, "November": 10, "December": 11 };
                    const parseDate = (d) => { if (typeof d !== 'string') return null; const p = d.replace(/,/g, '').split(' '); if (p.length === 3) return new Date(p[2], monthMap[p[0]], p[1]); if (p.length === 1) return new Date(p[0], 0, 1); return null; };
                    this.state.albums.forEach(a => { if (a.pivotalTracks && a.pivotalTracks.length > 0) a.firstRecordingDate = a.pivotalTracks.sort((x, y) => parseDate(x.recordingDate) - parseDate(y.recordingDate))[0].recordingDate; });
                    this.state.albums.sort((a, b) => parseDate(a.firstRecordingDate) - parseDate(b.firstRecordingDate));
                    const allTracks = this.state.albums.flatMap(a => a.pivotalTracks.map(t => ({ ...t, year: a.year, artist: a.artist, album: a.albumTitle, cover: a.cover, genre: a.genres })));
                    this.state.artistsData = this.methods.processArtists(allTracks, this.state.artistProfiles);
                },
                processArtists(tracks, profiles) {
                    const artistsMap = new Map();
                    const slugify = (name) => name ? name.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]+/g, '') : '';
                    tracks.forEach(track => {
                        if (!track.lineup) return;
                        const trackArtist = this.methods.getCanonicalName(track.artist);
                        track.lineup.split(/,(?![^()]*\))/).forEach(part => {
                            const match = part.trim().match(/(.+?)\s\((.+)\)/);
                            if (match) {
                                let name = this.methods.getCanonicalName(match[1].trim());
                                if (!artistsMap.has(name)) artistsMap.set(name, { name, instruments: new Set(), albums: new Set(), photo: `images/${slugify(name)}.jpg`, isTimelineBandleader: false, profile: profiles[name] || { name, profile: 'No profile available.'} });
                                const entry = artistsMap.get(name);
                                if (trackArtist.includes(name)) entry.isTimelineBandleader = true;
                                match[2].split(/, | \/ /).forEach(inst => { if (inst.trim() && !/vocals|arranger|reeds/i.test(inst)) entry.instruments.add(inst.trim()); });
                                entry.albums.add(track.album);
                            }
                        });
                    });
                    const artistsArray = Array.from(artistsMap.values());
                    artistsArray.forEach(a => { a.instruments = Array.from(a.instruments); a.albums = Array.from(a.albums); if (a.isTimelineBandleader) a.tier = 1; else if (a.albums.length >= 4) a.tier = 2; else a.tier = 3; });
                    return artistsArray;
                },
                buildGenreColorMap() {
                    const baseColors = this.state.styleMatrix.genres ? Object.entries(this.state.styleMatrix.genres).reduce((acc, [name, data]) => ({ ...acc, [name]: data.color }), {}) : {};
                    this.state.fullGenreColorMap = { ...baseColors, 'Free Jazz': 'var(--genre-free-jazz)', 'Avant-Garde Jazz': 'var(--genre-avant-garde)', 'Jazz Fusion': 'var(--genre-jazz-fusion)' };
                },
                setupFilters() {
                    const { genreFilterContainer } = this.elements;
                    const allGenres = [...new Set(this.state.albums.flatMap(a => a.genres))].filter(g => g && !['Bossa Nova', 'Chamber Jazz', 'Latin Jazz', 'Soul Jazz', 'Spiritual Jazz', 'Afro-Jazz', 'Ambient Jazz', 'Jazz-Funk', 'Third Stream', 'World Jazz', 'Soundtrack', 'Jazz-Rock', 'Progressive Rock', 'ECM Style Jazz', 'Neo-Bop', 'Cape Jazz', 'Vocal Jazz', 'Swing', 'Orchestral Jazz'].includes(g)).sort();
                    genreFilterContainer.innerHTML = `<label class="genre-checkbox-label" style="--genre-color: var(--text-muted);"><input type="checkbox" id="all-genres-checkbox" checked>All Genres</label>` + allGenres.map(g => `<label class="genre-checkbox-label" style="--genre-color: ${this.state.fullGenreColorMap[g] || 'var(--genre-default)'};"><input type="checkbox" data-genre="${g}" checked>${g}</label>`).join('');
                    genreFilterContainer.addEventListener('change', e => {
                        if (e.target.type === 'checkbox') {
                            if (e.target.id === 'all-genres-checkbox') genreFilterContainer.querySelectorAll('input[data-genre]').forEach(cb => cb.checked = e.target.checked);
                            else document.getElementById('all-genres-checkbox').checked = [...genreFilterContainer.querySelectorAll('input[data-genre]')].every(cb => cb.checked);
                            this.methods.filterTimeline();
                        }
                    });
                     this.methods.populateInstrumentFilter(this.state.artistsData);
                },
                renderTimeline() {
                    const { timelineWrapper } = this.elements;
                    timelineWrapper.innerHTML = '';
                    this.state.eras.forEach(era => {
                        const eraAlbums = this.state.albums.filter(album => album.year >= era.startYear && album.year <= era.endYear);
                        if (eraAlbums.length === 0) return;
                        const eraSection = document.createElement('div');
                        eraSection.className = 'era-section';
                        eraSection.style.backgroundColor = era.color;
                        const eraContent = document.createElement('div');
                        eraContent.className = 'era-content';
                        const yearsInEra = [...new Set(eraAlbums.map(a => a.year))].sort();
                        yearsInEra.forEach(year => {
                            const yearSection = document.createElement('div');
                            yearSection.className = 'timeline-year-section';
                            yearSection.id = `year-${year}`;
                            const albumList = document.createElement('div');
                            albumList.className = 'timeline-album-list';
                            eraAlbums.filter(a => a.year === year).forEach(album => {
                                const card = document.createElement('div');
                                card.className = 'timeline-album-card fade-in-element';
                                card.dataset.albumTitle = album.albumTitle;
                                card.dataset.artist = album.artist;
                                card.dataset.genres = album.genres.join(', ');
                                let isLandmark = false, landmarkColor = null;
                                for (const genreName of album.genres) {
                                    const genreData = this.state.styleMatrix.genres[this.methods.normalizeGenreName(genreName)];
                                    if (genreData && genreData.landmarkAlbums && genreData.landmarkAlbums.some(t => t.toLowerCase() === album.albumTitle.toLowerCase())) {
                                        isLandmark = true; landmarkColor = genreData.color; break;
                                    }
                                }
                                if (isLandmark) { card.classList.add('landmark-album'); card.style.setProperty('--landmark-color', landmarkColor); }
                                card.innerHTML = `<img src="${album.cover || ''}" alt="Cover for ${album.albumTitle}" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/200x200/1c1917/f5f5f4?text=No+Image';"><div class="timeline-album-card-info"><h5 class="font-bold truncate">${album.albumTitle}</h5><p class="truncate">${album.artist}</p></div>`;
                                albumList.appendChild(card);
                            });
                            yearSection.appendChild(albumList);
                            eraContent.appendChild(yearSection);
                        });
                        eraSection.appendChild(eraContent);
                        timelineWrapper.appendChild(eraSection);
                    });
                    this.methods.filterTimeline();
                },
                buildGenreMatrix() {
                    const { matrixContainer } = this.elements;
                    const { features, genres } = this.state.styleMatrix;
                    if (!features || !genres) return;
                    matrixContainer.innerHTML = `<thead><tr><th>Genre</th>${features.map(f => `<th>${f}</th>`).join('')}</tr></thead><tbody>${Object.entries(genres).map(([name, data]) => `<tr><th style="background-color:${data.color};"><button class="genre-header-button" data-genre-name="${name}"><span>${name}</span><svg class="info-icon w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg></button></th>${data.data.map(d => `<td>${d}</td>`).join('')}</tr>`).join('')}</tbody>`;
                },
                setupTimelineInteraction() {
                    const { timelineContainer, timelineWrapper, scrollLeftBtn, scrollRightBtn, stickyYearDisplay, stickyEraTitle } = this.elements;
                    scrollLeftBtn.addEventListener('click', () => timelineContainer.scrollBy({ left: -400, behavior: 'smooth' }));
                    scrollRightBtn.addEventListener('click', () => timelineContainer.scrollBy({ left: 400, behavior: 'smooth' }));
                    timelineWrapper.addEventListener('mouseover', e => {
                        if (window.innerWidth < 768) return;
                        const card = e.target.closest('.timeline-album-card');
                        if (card && !card.classList.contains('hidden') && !document.querySelector('.timeline-album-card.clicked')) {
                            const primaryGenre = (card.dataset.genres || '').split(', ')[0];
                            if (primaryGenre !== this.state.lastHoveredGenre) {
                                this.state.lastHoveredGenre = primaryGenre;
                                this.methods.applyHighlights(card);
                            }
                        }
                    });
                    timelineWrapper.addEventListener('click', e => {
                        const card = e.target.closest('.timeline-album-card');
                        if (!card || card.classList.contains('hidden')) return;
                        const { albumTitle, artist } = card.dataset;
                        const albumIndex = this.state.visibleAlbums.findIndex(a => a.albumTitle === albumTitle && a.artist === artist);
                        if (albumIndex !== -1) this.methods.openAlbumModal(this.state.visibleAlbums[albumIndex], albumIndex);
                    });
                    timelineContainer.addEventListener('scroll', () => {
                        let currentYear = '';
                        for (const section of timelineWrapper.querySelectorAll('.timeline-year-section')) {
                            if (section.style.display !== 'none' && section.offsetLeft <= timelineContainer.scrollLeft + 60) currentYear = section.id.replace('year-', '');
                        }
                        if (currentYear && currentYear !== this.state.lastKnownYear) {
                            this.state.lastKnownYear = currentYear;
                            stickyYearDisplay.textContent = currentYear;
                            const currentEra = this.state.eras.find(era => currentYear >= era.startYear && currentYear <= era.endYear);
                            if (currentEra && currentEra.title !== this.state.lastKnownEraTitle) {
                                this.state.lastKnownEraTitle = currentEra.title;
                                stickyEraTitle.textContent = `— ${currentEra.title}`;
                            }
                        }
                        this.methods.updateCustomScrollbar();
                    });
                },
                setupModals() {
                    const { albumModal, artistModal, genreModal, matrixContainer } = this.elements;
                    albumModal.querySelector('#close-modal').addEventListener('click', () => this.methods.closeAlbumModal());
                    albumModal.addEventListener('click', e => { if (e.target.id === 'album-modal') this.methods.closeAlbumModal(); });
                    document.getElementById('prev-album-btn').addEventListener('click', () => { if (this.state.currentVisibleAlbumIndex > 0) this.methods.openAlbumModal(this.state.visibleAlbums[this.state.currentVisibleAlbumIndex - 1], this.state.currentVisibleAlbumIndex - 1); });
                    document.getElementById('next-album-btn').addEventListener('click', () => { if (this.state.currentVisibleAlbumIndex < this.state.visibleAlbums.length - 1) this.methods.openAlbumModal(this.state.visibleAlbums[this.state.currentVisibleAlbumIndex + 1], this.state.currentVisibleAlbumIndex + 1); });
                    artistModal.querySelector('#close-artist-modal').addEventListener('click', () => this.methods.closeArtistModal());
                    artistModal.addEventListener('click', e => { if (e.target.id === 'artist-modal') this.methods.closeArtistModal(); });
                    genreModal.querySelector('#close-genre-modal').addEventListener('click', () => this.methods.closeGenreModal());
                    genreModal.addEventListener('click', e => { if (e.target.id === 'genre-modal') this.methods.closeGenreModal(); });
                    document.addEventListener('keydown', e => { if (e.key === "Escape") { this.methods.closeAlbumModal(); this.methods.closeArtistModal(); this.methods.closeGenreModal(); } });
                    matrixContainer.addEventListener('click', e => { const btn = e.target.closest('.genre-header-button'); if (btn) this.methods.openGenreModal(btn.dataset.genreName); });
                },
                setupArtistSlider() {
                    const { instrumentFilter, artistSliderTrack, artistPaginationControls } = this.elements;
                    const selectedInstrument = instrumentFilter.value;
                    const filteredArtists = (selectedInstrument === 'all' ? [...this.state.artistsData] : this.state.artistsData.filter(a => a.instruments.includes(selectedInstrument))).sort((a, b) => (a.tier - b.tier) || a.name.localeCompare(b.name));
                    artistSliderTrack.innerHTML = '';
                    const pageSize = window.innerWidth >= 768 ? 12 : 6;
                    this.state.totalArtistPages = Math.ceil(filteredArtists.length / pageSize);
                    artistPaginationControls.classList.toggle('hidden', this.state.totalArtistPages <= 1);
                    for (let i = 0; i < this.state.totalArtistPages; i++) {
                        const pageDiv = document.createElement('div');
                        pageDiv.className = 'artist-slider-page';
                        filteredArtists.slice(i * pageSize, (i + 1) * pageSize).forEach(artist => {
                            const card = document.createElement('div');
                            card.className = 'artist-card';
                            if (artist.tier === 1) card.classList.add('bandleader');
                            if (artist.tier === 2) card.classList.add('influential-sideman');
                            card.dataset.artistName = artist.name;
                            card.innerHTML = `<div class="h-56 bg-stone-900"><img src="${artist.photo || ''}" loading="lazy" alt="Photo of ${artist.name}" class="w-full h-full object-cover" onerror="this.onerror=null;this.src='images/artistplaceholder.jpg';"></div><div class="p-3"><h4 class="font-bold text-base truncate">${artist.name}</h4></div>`;
                            pageDiv.appendChild(card);
                        });
                        artistSliderTrack.appendChild(pageDiv);
                    }
                    this.methods.goToArtistPage(0);
                },
                setupMobileMenu() {
                    const { mobileMenuButton, mobileMenuOverlay, mobileMenuCloseButton, mobileNavLinks, mobileNavHeaders } = this.elements;
                    const openMenu = () => mobileMenuOverlay.classList.remove('hidden');
                    const closeMenu = () => mobileMenuOverlay.classList.add('hidden');
                    mobileMenuButton.addEventListener('click', openMenu);
                    mobileMenuCloseButton.addEventListener('click', closeMenu);
                    document.getElementById('mobile-menu-bg').addEventListener('click', closeMenu);
                    mobileNavLinks.forEach(link => {
                        link.addEventListener('click', (e) => {
                            const href = link.getAttribute('href');
                            if (href.startsWith('#')) {
                                e.preventDefault();
                                closeMenu();
                                const targetElement = document.querySelector(href);
                                if (targetElement) setTimeout(() => window.scrollTo({ top: targetElement.offsetTop - 80, behavior: 'smooth' }), 300);
                            }
                        });
                    });
                    mobileNavHeaders.forEach(header => {
                        header.addEventListener('click', () => {
                            header.nextElementSibling.classList.toggle('hidden');
                        });
                    });
                },
                setupScrollObservers() {
                    const fadeObserver = new IntersectionObserver(entries => entries.forEach(e => e.target.classList.toggle('is-visible', e.isIntersecting)), { threshold: 0.1 });
                    document.querySelectorAll('.fade-in-element').forEach(el => fadeObserver.observe(el));
                    const sectionObserver = new IntersectionObserver(entries => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                const id = entry.target.getAttribute('id');
                                this.elements.navLinks.forEach(link => {
                                    link.classList.toggle('active', link.getAttribute('href') === `#${id}`);
                                });
                            }
                        });
                    }, { rootMargin: '0px 0px -50% 0px' });
                    this.elements.sections.forEach(s => sectionObserver.observe(s));
                },
                setupGeneralEventListeners() {
                    this.elements.instrumentFilter.addEventListener('change', () => this.methods.setupArtistSlider());
                    this.elements.artistSliderTrack.addEventListener('click', e => { const card = e.target.closest('.artist-card'); if (card?.dataset.artistName) { const artist = this.state.artistsData.find(a => a.name === card.dataset.artistName); if (artist) this.methods.openArtistModal(artist); } });
                    this.elements.artistPrevBtn.addEventListener('click', () => this.methods.goToArtistPage(this.state.currentArtistPage - 1));
                    this.elements.artistNextBtn.addEventListener('click', () => this.methods.goToArtistPage(this.state.currentArtistPage + 1));
                    window.addEventListener('resize', () => { this.methods.setupArtistSlider(); this.methods.resizeCanvas(); this.methods.updateCustomScrollbar(); this.methods.renderScrollbarMarkers(); });
                    this.elements.footerCopyright.textContent = `© ${new Date().getFullYear()} Controlled Freedom. All Rights Reserved.`;
                    this.methods.setupDraggable(this.elements.timelineContainer);
                    this.methods.setupCustomScrollbarInteraction();
                },
                filterTimeline() {
                    const selectedGenres = [...this.elements.genreFilterContainer.querySelectorAll('input[data-genre]:checked')].map(cb => cb.value);
                    this.state.visibleAlbums = [];
                    document.querySelectorAll('.timeline-album-card').forEach(card => {
                        const cardGenres = (card.dataset.genres || '').split(', ');
                        const isVisible = cardGenres.some(g => selectedGenres.includes(g));
                        card.classList.toggle('hidden', !isVisible);
                        if (isVisible) {
                            const album = this.state.albums.find(a => a.albumTitle === card.dataset.albumTitle && a.artist === card.dataset.artist);
                            if (album) this.state.visibleAlbums.push(album);
                        }
                    });
                    document.querySelectorAll('.timeline-year-section').forEach(section => { section.style.display = section.querySelector('.timeline-album-card:not(.hidden)') ? 'flex' : 'none'; });
                    document.querySelectorAll('.era-section').forEach(section => { section.style.display = section.querySelector('.timeline-year-section:not([style*="display: none"])') ? 'flex' : 'none'; });
                    setTimeout(() => { this.methods.resizeCanvas(); this.methods.renderScrollbarMarkers(); this.methods.updateCustomScrollbar(); }, 0);
                },
                applyHighlights(selectedCard) {
                    document.querySelectorAll('.timeline-album-card').forEach(c => c.classList.remove('dimmed', 'highlighted'));
                    if (!selectedCard) return;
                    document.querySelectorAll('.timeline-album-card').forEach(c => c.classList.add('dimmed'));
                    const primaryGenre = (selectedCard.dataset.genres || '').split(', ')[0];
                    const highlightColor = this.state.fullGenreColorMap[primaryGenre] || 'var(--accent)';
                    document.querySelectorAll('.timeline-album-card:not(.hidden)').forEach(card => {
                        if ((card.dataset.genres || '').includes(primaryGenre)) {
                            card.classList.remove('dimmed');
                            card.classList.add('highlighted');
                            card.style.setProperty('--highlight-color', highlightColor);
                        }
                    });
                },
                openAlbumModal(album, index) {
                    this.state.currentVisibleAlbumIndex = index;
                    const { albumModal } = this.elements;
                    albumModal.querySelector('#modal-title').textContent = album.albumTitle;
                    albumModal.querySelector('#modal-artist').textContent = album.artist;
                    albumModal.querySelector('#modal-album-art').src = album.cover || '';
                    const pivotalTrack = album.pivotalTracks ? album.pivotalTracks[0] : {};
                    const genreTags = (album.genres || []).map(g => `<span class="genre-tag" style="background-color: ${this.state.fullGenreColorMap[g.trim()] || 'var(--genre-default)'}">${g.trim()}</span>`).join(' ');
                    const lineupHtml = (pivotalTrack.lineup || 'N/A').split(/, (?![^()]*\))/).map(p => { const m = p.trim().match(/(.+?)\s\((.+)\)/); return m && this.state.artistsData.some(a => a.name === m[1].trim()) ? `<span class="clickable-link" data-artist-name="${m[1].trim()}">${m[1].trim()}</span> (${m[2]})` : p; }).join(', ');
                    albumModal.querySelector('#modal-album-details').innerHTML = `<h4 class="text-3xl mb-4">Album Details</h4><div class="grid grid-cols-[auto,1fr] gap-x-4 gap-y-2"><strong class="font-bold">Genre:</strong><div class="flex flex-wrap gap-2">${genreTags}</div><strong>Recorded:</strong><span>${pivotalTrack.recordingDate || 'N/A'}</span><strong>Label:</strong><span>${pivotalTrack.label || 'N/A'}</span><strong class="font-bold align-top">Line-Up:</strong><span>${lineupHtml}</span></div>`;
                    const analysisWrapper = albumModal.querySelector('#analysis-wrapper');
                    analysisWrapper.innerHTML = `<div id="modal-analysis-section">${album.pivotalTracks.map(t => `<div class="mb-8 last:mb-0"><div class="flex justify-between items-center gap-4 flex-wrap"><h5 class="text-2xl font-bold text-white flex-1">Key Track: "${t.title}"</h5><div id="player-container-${this.methods.slugify(t.title)}" class="w-full sm:w-52 h-[35px]"><audio id="player-${this.methods.slugify(t.title)}" controls class="styled-player w-full" src="songs/${this.methods.slugify(t.title)}.mp3" preload="none"></audio></div></div><p class="liner-notes-text">${t.analysis}</p></div>`).join('<hr class="border-stone-700 my-8">')}</div>`;
                    album.pivotalTracks.forEach(t => { const p = document.getElementById(`player-${this.methods.slugify(t.title)}`); if (p) { p.onerror = () => document.getElementById(`player-container-${this.methods.slugify(t.title)}`).innerHTML = `<div class="w-full h-full flex items-center justify-center bg-stone-700 text-stone-400 text-sm rounded">Preview N/A</div>`; p.addEventListener('play', () => document.querySelectorAll('audio').forEach(op => { if (op !== p) op.pause(); })); } });
                    document.getElementById('prev-album-btn').disabled = index <= 0;
                    document.getElementById('next-album-btn').disabled = index < 0 || index >= this.state.visibleAlbums.length - 1;
                    albumModal.classList.remove('opacity-0', 'pointer-events-none');
                },
                closeAlbumModal(callback) {
                    const { albumModal } = this.elements;
                    albumModal.classList.add('opacity-0', 'pointer-events-none');
                    albumModal.querySelectorAll('audio').forEach(a => a.pause());
                    if (typeof callback === 'function') setTimeout(callback, 300);
                },
                openArtistModal(artist) {
                    const { artistModal } = this.elements;
                    artistModal.querySelector('#artist-modal-title').textContent = artist.name;
                    const body = artistModal.querySelector('#artist-modal-body');
                    const albumsHtml = artist.albums.map(title => { const album = this.state.albums.find(a => a.albumTitle === title); return album ? `<li class="artist-modal-timeline-item"><strong>${album.year}:</strong> <span class="clickable-link" data-album-title="${album.albumTitle}" data-artist="${album.artist}">${album.albumTitle}</span></li>` : ''; }).join('');
                    body.innerHTML = `<div class="flex flex-col sm:flex-row gap-6"><div class="w-full sm:w-1/3"><img src="${artist.photo || ''}" loading="lazy" class="w-full h-auto rounded-sm border-2 border-stone-900" onerror="this.onerror=null;this.src='images/artistplaceholder.jpg';"><p class="mt-4 text-sm"><strong>Instruments:</strong> ${artist.instruments.join(', ')}</p></div><div class="w-full sm:w-2/3"><h4 class="text-2xl mb-2">Profile</h4><p class="text-base leading-relaxed mb-4">${artist.profile.profile || 'No profile available.'}</p><h4 class="text-2xl mb-3">Album Appearances</h4><ul class="artist-modal-timeline h-48 overflow-y-auto pr-2">${albumsHtml}</ul></div></div>`;
                    artistModal.classList.remove('opacity-0', 'pointer-events-none');
                },
                closeArtistModal(callback) {
                    this.elements.artistModal.classList.add('opacity-0', 'pointer-events-none');
                    if (typeof callback === 'function') setTimeout(callback, 300);
                },
                openGenreModal(genreName) {
                    const { genreModal } = this.elements;
                    const genreData = this.state.styleMatrix.genres[genreName];
                    if (!genreData) return;
                    genreModal.querySelector('#genre-modal-title').textContent = genreName;
                    const body = genreModal.querySelector('#genre-modal-body');
                    const landmarkAlbumsHtml = (genreData.landmarkAlbums || []).map(title => `<li>${title}</li>`).join('');
                    body.innerHTML = `<div class="space-y-6"><div><h4 class="text-2xl font-bold">Overview</h4><p>${genreData.profile}</p></div><div><h4 class="text-2xl font-bold">Key Characteristics</h4><ul class="list-disc list-inside"><li><strong>Harmony:</strong> ${genreData.data[0]}</li><li><strong>Rhythm:</strong> ${genreData.data[1]}</li><li><strong>Form:</strong> ${genreData.data[2]}</li></ul></div><div><h4 class="text-2xl font-bold">Key Artists</h4><p>${genreData.artists}</p></div>${landmarkAlbumsHtml ? `<div><h4 class="text-2xl font-bold">Landmark Albums</h4><ul class="list-disc list-inside">${landmarkAlbumsHtml}</ul></div>` : ''}</div>`;
                    genreModal.classList.remove('opacity-0', 'pointer-events-none');
                },
                closeGenreModal(callback) {
                    this.elements.genreModal.classList.add('opacity-0', 'pointer-events-none');
                    if (typeof callback === 'function') setTimeout(callback, 300);
                },
                populateInstrumentFilter(artists) {
                    const { instrumentFilter } = this.elements;
                    const instruments = new Set();
                    artists.forEach(a => a.instruments.forEach(i => instruments.add(i)));
                    instrumentFilter.innerHTML = '<option value="all">All Instruments</option>';
                    [...instruments].sort().forEach(i => instrumentFilter.innerHTML += `<option value="${i}">${i.charAt(0).toUpperCase() + i.slice(1)}</option>`);
                },
                goToArtistPage(pageIndex) {
                    const { artistSliderTrack, artistPrevBtn, artistNextBtn, artistPageIndicator } = this.elements;
                    this.state.currentArtistPage = Math.max(0, Math.min(pageIndex, this.state.totalArtistPages - 1));
                    artistSliderTrack.style.transform = `translateX(-${this.state.currentArtistPage * 100}%)`;
                    artistPrevBtn.disabled = this.state.currentArtistPage === 0;
                    artistNextBtn.disabled = this.state.currentArtistPage >= this.state.totalArtistPages - 1;
                    if (artistPageIndicator) artistPageIndicator.textContent = `${this.state.currentArtistPage + 1} / ${this.state.totalArtistPages}`;
                },
                resizeCanvas() {
                    const { timelineCanvas, timelineWrapper } = this.elements;
                    timelineCanvas.width = timelineWrapper.scrollWidth;
                    timelineCanvas.height = timelineWrapper.offsetHeight;
                },
                setupDraggable(container) {
                    if (!container) return;
                    let isDown = false, startX, scrollLeft;
                    container.addEventListener('mousedown', e => { isDown = true; container.style.cursor = 'grabbing'; startX = e.pageX - container.offsetLeft; scrollLeft = container.scrollLeft; });
                    container.addEventListener('mouseleave', () => { isDown = false; container.style.cursor = 'grab'; });
                    container.addEventListener('mouseup', () => { isDown = false; container.style.cursor = 'grab'; });
                    container.addEventListener('mousemove', e => { if (isDown) { e.preventDefault(); const x = e.pageX - container.offsetLeft; container.scrollLeft = scrollLeft - (x - startX) * 2; } });
                },
                updateCustomScrollbar() {
                    const { timelineContainer, customScrollbar, customScrollbarThumb } = this.elements;
                    if (!timelineContainer || !customScrollbar || !customScrollbarThumb) return;
                    const scrollableWidth = timelineContainer.scrollWidth - timelineContainer.clientWidth;
                    if (scrollableWidth <= 0) { customScrollbar.style.display = 'none'; return; }
                    customScrollbar.style.display = 'block';
                    const scrollPercentage = timelineContainer.scrollLeft / scrollableWidth;
                    const thumbWidthPercentage = timelineContainer.clientWidth / timelineContainer.scrollWidth;
                    customScrollbarThumb.style.width = `${thumbWidthPercentage * 100}%`;
                    customScrollbarThumb.style.left = `${scrollPercentage * (100 - thumbWidthPercentage * 100)}%`;
                },
                setupCustomScrollbarInteraction() {
                    const { customScrollbar, customScrollbarThumb, timelineContainer } = this.elements;
                    let isDragging = false;
                    customScrollbarThumb.addEventListener('mousedown', () => isDragging = true);
                    document.addEventListener('mouseup', () => isDragging = false);
                    document.addEventListener('mousemove', e => { if (isDragging) { const scrollableWidth = timelineContainer.scrollWidth - timelineContainer.clientWidth; const scrollbarWidth = customScrollbar.clientWidth - customScrollbarThumb.clientWidth; timelineContainer.scrollLeft += e.movementX * (scrollableWidth / scrollbarWidth); } });
                },
                renderScrollbarMarkers() {
                    const { timelineWrapper, customScrollbarMarkers } = this.elements;
                    const years = [...new Set(this.state.albums.map(a => a.year))].sort();
                    customScrollbarMarkers.innerHTML = '';
                    years.forEach(year => {
                        const yearSection = document.getElementById(`year-${year}`);
                        if (yearSection && yearSection.style.display !== 'none') {
                            const percentage = (yearSection.offsetLeft + yearSection.offsetWidth / 2) / timelineWrapper.scrollWidth * 100;
                            customScrollbarMarkers.innerHTML += `<div class="scrollbar-marker" style="left: ${percentage}%" data-year="'${String(year).slice(2)}"></div>`;
                        }
                    });
                },
                setupOnThisDayFeature() {
                    const { onThisDayContainer } = this.elements;
                    if (!onThisDayContainer) return;
                    const today = new Date();
                    const matchingTracks = this.state.albums.flatMap(a => (a.pivotalTracks || []).map(t => ({...t, parentAlbum: a}))).filter(t => {
                        try {
                            const d = new Date(t.recordingDate);
                            return d.getMonth() === today.getMonth() && d.getDate() === today.getDate();
                        } catch (e) { return false; }
                    });
                    if (matchingTracks.length > 0) {
                        const featured = matchingTracks[Math.floor(Math.random() * matchingTracks.length)];
                        const album = featured.parentAlbum;
                        onThisDayContainer.innerHTML = `<div class="p-4 bg-stone-200 border-2 border-stone-900 rounded-sm shadow-[4px_4px_0px_var(--text-main)] cursor-pointer hover:shadow-[6px_6px_0px_var(--accent)] hover:-translate-y-1 transition-all">...</div>`; // Simplified for brevity
                        onThisDayContainer.firstElementChild.addEventListener('click', () => {
                             const albumIndex = this.state.visibleAlbums.findIndex(a => a.albumTitle === album.albumTitle && a.artist === album.artist);
                             this.methods.openAlbumModal(album, albumIndex);
                        });
                    } else {
                        onThisDayContainer.innerHTML = `<div class="p-4 bg-stone-200 border-2 border-stone-900 rounded-sm shadow-[4px_4px_0px_var(--text-main)]"><h4 class="text-2xl text-stone-900 mb-2 transform -rotate-1 inline-block bg-yellow-400 px-2">On This Day In Jazz...</h4><p class="text-center text-stone-600 mt-4">No landmark tracks recorded today.</p></div>`;
                    }
                },
            }
        };
        document.addEventListener('DOMContentLoaded', () => JazzApp.init());
    </script>
</body>
</html>
