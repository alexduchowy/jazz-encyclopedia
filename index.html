<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controlled Freedom: An Interactive Encyclopedia of Jazz</title>
    
    <!-- External Libraries & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;700;900&family=Lora:ital,wght@0,400;0,600;1,400;1,600&display=swap" rel="stylesheet">
    
    <!-- Custom CSS Styling -->
    <style>
        /* Define custom color properties for easy theme management */
        :root {
            --bg-main: #f5f5f4; /* stone-100 */
            --bg-secondary: #e7e5e4; /* stone-200 */
            --bg-dark: #1a1a1a; /* Custom dark gray */
            --text-main: #1c1917; /* stone-900 */
            --text-muted: #57534e; /* stone-600 */
            --accent: #f97316; /* orange-500 */
            --accent-dark: #ea580c; /* orange-600 */

            /* Genre Colors */
            --genre-bebop: #C19A6B; /* Pastel Brown */
            --genre-hard-bop: #d8b4fe; /* purple-300 */
            --genre-cool-jazz: #93c5fd; /* blue-300 */
            --genre-modal-jazz: #a7f3d0; /* emerald-200 */
            --genre-post-bop: #fed7aa; /* orange-200 */
            --genre-free-jazz: #fca5a5; /* red-300 */
            --genre-avant-garde: #fecdd3; /* rose-200 */
            --genre-jazz-fusion: #a5f3fc; /* cyan-200 */
            --genre-default: #e7e5e4; /* stone-200 */
        }

        /* Base body styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
        }
        
        /* Heading font styling with new Bebas Neue font */
        h1, h2, h3, h4, h5 {
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 0.05em;
        }

        /* Navigation link transition effects */
        .nav-link {
            transition: color 0.2s;
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 0.1em;
            font-size: 1.1rem;
        }
        .nav-link:hover, .nav-link.active {
            color: var(--accent);
        }

        /* Section header styling */
        .section-header {
              transform: rotate(-1deg);
              display: inline-block;
              background-color: var(--accent);
              color: var(--bg-main);
              padding: 0.25rem 1rem;
              margin-bottom: 1rem;
        }
        
        /* MODIFICATION: Compact Matrix Styling */
        #genre-matrix-container {
            border: 2px solid var(--text-main);
            border-radius: 0.25rem;
            overflow: auto; /* Enable scrolling */
            max-height: 70vh; /* Set a max height */
            background-color: var(--bg-main);
        }
        .matrix-table {
            border-collapse: collapse;
            width: 100%;
            min-width: 900px; /* Ensure horizontal scroll on smaller screens */
        }
        .matrix-table th, .matrix-table td {
            padding: 1rem;
            border-bottom: 2px solid var(--bg-secondary);
            text-align: left;
            vertical-align: top;
            transition: background-color 0.1s ease-in-out;
        }
        .matrix-table thead th {
            background-color: var(--text-main);
            color: var(--bg-main);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .matrix-table tbody th {
            font-weight: bold;
            font-size: 1.1rem;
            width: 150px;
            position: sticky;
            left: 0;
            z-index: 5;
            border-right: 2px solid var(--bg-secondary);
        }
        .matrix-table tbody tr:last-child th, .matrix-table tbody tr:last-child td {
            border-bottom: none;
        }
        .matrix-table .col-hover, .matrix-table .row-hover > td {
            background-color: var(--highlight-color, rgba(0,0,0,0.05)) !important;
        }
        .matrix-table .row-hover > th {
             background-color: var(--highlight-color-dark, var(--bg-secondary)) !important;
        }


        /* Modal transition styles */
        .modal {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        .modal.opacity-0 .modal-content {
              opacity: 0;
              transform: scale(0.95) translateY(10px);
        }
        
        /* Horizontal draggable timeline container */
        #horizontal-timeline-container {
            position: relative;
            width: 100%;
            overflow-x: auto;
            cursor: grab;
            border: none;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        #horizontal-timeline-container:active {
            cursor: grabbing;
        }
        #horizontal-timeline-container::-webkit-scrollbar {
            display: none;
        }

        /* Canvas for drawing connection lines */
        #timeline-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Allows clicks to pass through to the cards */
            z-index: 1;
        }
        /* Wrapper for all timeline content */
        #timeline-wrapper {
            position: relative;
            display: inline-flex;
            align-items: flex-start;
            padding: 2rem 1rem;
            padding-top: 5rem; /* MODIFIED: Make space for sticky header */
            z-index: 2; /* Ensure cards are above the canvas */
        }
        /* Styling for each year's section in the timeline */
        .timeline-year-section {
            display: flex;
            flex-shrink: 0;
            flex-direction: column;
            align-items: center; /* Center pagination controls */
            border-left: 4px dotted #a8a29e; /* MODIFIED: Darker dotted line (stone-400) */
            padding: 0 2rem;
        }
        .timeline-year-section:first-child {
            border-left: none;
        }
        /* Year header styling */
        .timeline-year-header {
           display: none; /* MODIFIED: Hide the inline headers */
        }
        /* Grid for album cards within a year */
        .timeline-album-list {
            display: grid;
            grid-template-rows: repeat(2, 1fr);
            grid-auto-flow: column;
            gap: 1.5rem;
            min-height: 520px; /* Adjust height to fit two rows of cards + gap */
        }
        /* Individual album card styling */
        .timeline-album-card {
            width: 200px;
            flex-shrink: 0;
            background-color: var(--bg-main);
            border-radius: 0.25rem;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
            box-shadow: 4px 4px 0px var(--text-main);
            border: 2px solid var(--text-main);
            overflow: hidden;
            opacity: 1;
            /* --highlight-color will be set by JS */
        }
        .timeline-album-card:hover {
            transform: translateY(-5px) rotate(2deg);
        }
        .timeline-album-card.dimmed {
            opacity: 0.5;
        }
        .timeline-album-card.highlighted {
            opacity: 1;
            transform: translateY(-5px) rotate(2deg);
            box-shadow: 8px 8px 0px var(--highlight-color, var(--accent));
        }
        /* Style for the card that is currently selected/clicked */
        .timeline-album-card.clicked {
            transform: translateY(-5px) rotate(2deg) scale(1.05);
            box-shadow: 8px 8px 0px var(--accent) !important;
            opacity: 1 !important;
            z-index: 10;
        }
        .timeline-album-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            filter: grayscale(100%);
            transition: filter 0.3s ease;
        }
        .timeline-album-card:hover img, .timeline-album-card.highlighted img, .timeline-album-card.clicked img {
            filter: grayscale(0%);
        }
        .timeline-album-card-info {
            padding: 0.75rem;
        }
        .timeline-album-card-info h5 {
            color: var(--text-main);
            font-size: 1.25rem;
        }
        .timeline-album-card-info p {
            color: var(--text-muted);
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
        }
        /* Artist card styling */
        .artist-card {
            background-color: var(--bg-main);
            border-radius: 0.25rem;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 4px 4px 0px var(--text-main);
            border: 2px solid var(--text-main);
        }
        .artist-card:hover {
            transform: translateY(-5px) rotate(2deg);
            box-shadow: 8px 8px 0px var(--accent) !important; /* Ensure hover always wins */
        }
        .artist-card .artist-photo-container {
              height: 224px;
              width: 100%;
        }
        .artist-card img {
              width: 100%;
              height: 100%;
              object-fit: cover;
              object-position: center;
              filter: grayscale(100%);
              transition: filter 0.3s ease;
        }
         .artist-card:hover img {
            filter: grayscale(0%);
        }
        .artist-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            background-color: #1c1917; /* stone-900 */
        }
        .artist-placeholder svg {
            width: 50%;
            height: 50%;
            color: #a8a29e; /* stone-400 */
        }
        
        /* Artist Grid Styling */
        #artist-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* Mobile: 3 columns for 2 rows of 3 */
            gap: 1.5rem;
            padding-top: 1rem;
        }
        @media (min-width: 768px) { /* Tablet and Web: 6 columns for 2 rows of 6 */
            #artist-grid {
                grid-template-columns: repeat(6, 1fr);
            }
        }
        
        .styled-select select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23f97316' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.7rem center;
            background-size: 1.2em;
        }

        /* Modal Night Mode & Player Styles */
        #modal-analysis-section {
            background-color: var(--bg-dark);
            padding: 1.5rem;
            margin-top: 2rem;
            border: 2px solid var(--text-main);
            box-shadow: 4px 4px 0px var(--text-main);
        }
        #modal-analysis-section h5 {
            color: var(--bg-main);
        }
        
        .liner-notes-text {
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            line-height: 1.6;
            color: #d4d4d2; 
        }
        
        audio.styled-player {
            height: 35px; 
            accent-color: var(--accent);
        }

        /* NEW: Genre Filter Dropdown Styling */
        .genre-dropdown-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            max-height: 250px;
            overflow-y: auto;
        }
        .genre-checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .genre-checkbox-label input {
            appearance: none;
            -webkit-appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 0.25rem;
            margin-right: 0.5rem;
            cursor: pointer;
            position: relative;
            transition: background-color: 0.2s;
            border: 2px solid var(--genre-color, var(--text-main));
        }
        .genre-checkbox-label input:checked {
            background-color: var(--genre-color, var(--accent));
            border-color: var(--text-main);
        }
        .genre-checkbox-label input:checked::after {
            content: '✔';
            position: absolute;
            color: var(--text-main);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.8rem;
        }

        /* Loading indicator styles */
        #loader {
            position: fixed;
            inset: 0;
            background-color: var(--bg-main);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .loader-spinner {
            border: 4px solid var(--bg-secondary);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .content-hidden {
            display: none;
        }
        
        .genre-tag {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-main);
            border: 2px solid var(--text-main);
        }

        .hidden {
            display: none !important;
        }

        /* Style for clickable links in modals */
        .clickable-link {
            cursor: pointer;
            text-decoration: underline;
            text-decoration-color: var(--accent);
            transition: color 0.2s;
        }
        .clickable-link:hover {
            color: var(--accent);
        }

        /* Animation for fade-in on scroll */
        .fade-in-element {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        .fade-in-element.is-visible {
            opacity: 1;
            transform: translateY(0);
        }
        .title-rotate {
            transform: rotate(-1.5deg);
            margin-top: 35px;
        }
        .nav-bar-hidden-behaviour {
            display: flex;
            transform: rotate(-1.5deg);
        }
        @media (max-width: 640px) {
            .nav-bar-hidden-behaviour {
                display: none;
            }
        }

        /* NEW: Nudge animation for scroll buttons */
        @keyframes nudge-right {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(8px); }
        }
        .nudge-animation {
            animation: nudge-right 1.5s ease-in-out 3;
        }

        /* NEW: Mobile Menu Panel Transition */
        #mobile-menu-panel {
            transition: transform 0.3s ease-in-out;
        }
        #mobile-menu-overlay.hidden #mobile-menu-panel {
            transform: translateX(100%);
        }
   
    </style>
</head>
<body class="bg-stone-100 text-stone-900">

    <!-- Full-screen loader -->
    <div id="loader">
        <div class="loader-spinner"></div>
    </div>

    <div id="page-content" class="content-hidden">
        <!-- HEADER -->
        <div class="sticky top-0 z-50 h-24 mb-[-64px]">
              <header class="relative container mx-auto h-full">
                    <!-- This is the crooked background. It is positioned absolutely within the header -->
                    <div class="absolute inset-x-0 top-4 h-20 bg-stone-100 border-2 border-stone-900" style="transform: rotate(-1.5deg); box-shadow: 5px 5px 0px var(--text-main); z-index: 1;"></div>
                    
                    <!-- This is the navigation content. It is NOT rotated and sits on top of the background -->
                    <nav class="relative z-10 flex items-center justify-between h-full px-4 sm:px-6 lg:px-8">
                        <h1 class="title-rotate text-3xl md:text-4xl font-bold text-stone-900 tracking-tight">Controlled Freedom</h1>
                        <div class="nav-bar-hidden-behaviour sm:items-baseline sm:space-x-8">
                            <a href="#overview" class="nav-link px-3 py-2 rounded-md font-medium text-stone-600">Overview</a>
                            <a href="#timeline" class="nav-link px-3 py-2 rounded-md font-medium text-stone-600">Timeline</a>
                            <a href="#matrix" class="nav-link px-3 py-2 rounded-md font-medium text-stone-600">Genres</a>
                            <a href="#artists" class="nav-link px-3 py-2 rounded-md font-medium text-stone-600">Artists</a>
                            <a href="#legacy" class="nav-link px-3 py-2 rounded-md font-medium text-stone-600">Legacy</a>
                        </div>
                        <!-- MODIFICATION: Hamburger Menu Button -->
                        <div class="sm:hidden">
                            <button id="mobile-menu-button" class="p-2 -mr-2 rounded-md text-stone-900 hover:bg-stone-200 focus:outline-none">
                                <svg class="h-8 w-8" stroke="currentColor" fill="none" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                                </svg>
                            </button>
                        </div>
                    </nav>
                </header>
        </div>


        <main>
            <!-- Hero Banner Section -->
            <section id="banner" class="relative w-full h-56 md:h-72 lg:h-[26rem]">
                <img src="images/banner.jpg" alt="Post-bop musicians in a rehearsal space" class="w-full h-full object-cover" onerror="this.onerror=null;this.src='https://images.unsplash.com/photo-1511192336575-5a79af67d629?q=80&w=2074&auto=format&fit=crop';">
                <div class="absolute inset-x-0 bottom-0 h-1/3 bg-gradient-to-t from-stone-100 to-transparent"></div>
            </section>

            <!-- Overview Section -->
            <section id="overview" class="pt-12 pb-16 sm:pb-20">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-4xl text-center">
                        <h2 class="section-header text-5xl">An Encyclopedia of Jazz Evolution</h2>
                    <p class="text-center text-lg text-stone-600 mb-12 italic">Follow the development of modern jazz through the 50s and 60s.</p>
                    <div class="space-y-6 text-base md:text-lg leading-relaxed text-stone-900 text-left">
                        <p>The period between 1950 and 1969 represents the most accelerated and dynamic evolution in jazz history. The decade began with the virtuosic fire of <strong>Bebop</strong> firmly established as the music's cutting edge. From this complex foundation, the music branched into myriad new forms. Some musicians pursued the soulful, blues-drenched energy of <strong>Hard Bop</strong>, while others explored the harmonically rich, restrained arrangements of <strong>Cool Jazz</strong> and resurgent <strong>Big Bands</strong>.</p>
                        <p>At the heart of this era lies the central theme of <strong>"controlled freedom."</strong> This was the philosophy of <strong>Post-Bop</strong>, a movement that sought a middle ground between the dense structures of bebop and the radical abandon of the burgeoning <strong>Free Jazz</strong> and <strong>Avant-Garde</strong> scenes. Musicians began to stretch and deconstruct standard forms, introducing new harmonic ambiguity and rhythmic complexity without completely discarding form and melody. This application provides an interactive journey through this dense, interconnected history, making the evolution of modern jazz accessible and engaging.</p>
                    </div>
                </div>
            </section>

            <!-- Interactive Timeline Section -->
            <section id="timeline" class="py-16 sm:py-20 bg-stone-300 border-y-4 border-stone-900">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center">
                    <h2 class="section-header text-5xl">Timeline Explorer</h2>
                    <p class="text-center text-lg text-stone-600 mb-8 max-w-3xl mx-auto italic">Use the filters to explore a year-by-year breakdown of landmark albums.</p>
                    
                    <!-- Redesigned Filter Controls -->
                    <div id="timeline-controls" class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-8">
                        <!-- Genre Filter Dropdown -->
                        <div class="relative" id="genre-filter-dropdown-container">
                            <button id="genre-filter-btn" class="w-60 text-left font-bold px-4 py-2 bg-stone-100 text-stone-900 border-2 border-stone-900 rounded-sm hover:bg-stone-300 transition-colors flex items-center justify-between">
                                <span>Filter by Genre</span>
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                            </button>
                            <div id="genre-filter-panel" class="hidden absolute top-full left-0 mt-1 w-96 bg-stone-100 border-2 border-stone-900 rounded-sm shadow-lg p-4 z-20">
                                <!-- Checkboxes will be injected here -->
                            </div>
                        </div>

                        <!-- Year Jumper Dropdown -->
                        <div class="relative styled-select w-60">
                             <select id="year-jumper" class="w-full font-bold px-4 py-2 bg-stone-100 text-stone-900 border-2 border-stone-900 rounded-sm hover:bg-stone-300 transition-colors">
                                <!-- Options will be injected here -->
                            </select>
                        </div>
                    </div>

                    <div class="relative group">
                        <!-- Sticky Year Display -->
                        <div id="sticky-year-display" class="absolute top-0 left-1 sm:left-4 font-black text-orange-600 text-6xl transition-opacity duration-200 pointer-events-none z-10"></div>

                        <div id="horizontal-timeline-container" class="min-h-[600px] flex items-center">
                            <canvas id="timeline-canvas"></canvas>
                            <div id="timeline-wrapper"></div>
                        </div>
                        <button id="scroll-left-btn" class="absolute left-0 sm:-left-4 top-1/2 -translate-y-1/2 z-20 p-2 rounded-full bg-stone-900 text-stone-100 hover:bg-orange-500 transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                        </button>
                        <button id="scroll-right-btn" class="absolute right-0 sm:-right-4 top-1/2 -translate-y-1/2 z-20 p-2 rounded-full bg-stone-900 text-stone-100 hover:bg-orange-500 transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                        </button>
                    </div>
                    <!-- MODIFICATION: Custom Scrollbar -->
                    <div class="mt-6">
                        <div id="custom-scrollbar" class="w-full h-3 bg-stone-200 rounded-full cursor-pointer relative">
                            <div id="custom-scrollbar-thumb" class="h-full bg-stone-900 rounded-full absolute top-0 cursor-grab"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- MODIFICATION: Genre Matrix Section -->
            <section id="matrix" class="py-16 sm:py-20">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center">
                    <h2 class="section-header text-5xl">The Genres</h2>
                    <p class="text-center text-lg text-stone-600 mb-12 max-w-3xl mx-auto italic">Compare the characteristics of each major genre.</p>
                    <div id="genre-matrix-container" class="matrix-container max-w-6xl mx-auto">
                        <table id="style-matrix-table" class="matrix-table">
                            <!-- Table content will be generated here -->
                        </table>
                    </div>
                </div>
            </section>

            <!-- Key Artists Grid Section -->
            <section id="artists" class="py-16 sm:py-20 bg-stone-200 border-y-4 border-stone-900">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center">
                        <h2 class="section-header text-5xl">The Architects</h2>
                    <p class="text-center text-lg text-stone-600 mb-12 max-w-3xl mx-auto italic">Explore the musicians who defined the Bop era.</p>
                    
                    <!-- Instrument Filter Dropdown -->
                    <div class="flex justify-center mb-8">
                        <div class="w-full max-w-xs styled-select">
                            <label for="instrument-filter" class="block text-sm font-medium text-stone-600 mb-2 text-center">Filter by Instrument:</label>
                            <select id="instrument-filter" class="block w-full rounded-sm border-2 border-stone-900 bg-stone-100 text-stone-900 py-2 pl-3 pr-10 focus:border-orange-500 focus:outline-none focus:ring-orange-500 font-bold">
                            </select>
                        </div>
                    </div>

                    <!-- Artist Grid Container -->
                    <div id="artist-grid-container" class="min-h-[550px] md:min-h-[580px]">
                        <div id="artist-grid">
                            <!-- Artist cards will be injected here by JavaScript -->
                        </div>
                   </div>

                    <!-- Artist Pagination Controls -->
                    <div id="artist-pagination-controls" class="mt-8 flex justify-center items-center gap-4">
                        <button id="artist-prev-btn" class="px-4 py-2 bg-stone-900 text-stone-100 rounded-sm font-bold hover:bg-orange-500 transition-colors disabled:bg-stone-400 disabled:cursor-not-allowed">Previous</button>
                        <span id="artist-page-indicator" class="px-4 py-2 text-stone-900 font-bold text-lg"></span>
                        <button id="artist-next-btn" class="px-4 py-2 bg-stone-900 text-stone-100 rounded-sm font-bold hover:bg-orange-500 transition-colors disabled:bg-stone-400 disabled:cursor-not-allowed">Next</button>
                   </div>
                </div>
            </section>
            
            <!-- Legacy Section -->
            <section id="legacy" class="py-16 sm:py-20">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-4xl text-center">
                    <h2 class="section-header text-5xl">Legacy</h2>
                    <p class="text-center text-lg text-stone-600 mb-12 italic">How a golden age splintered into new forms, leaving an indelible mark on music.</p>
                    <div class="space-y-6 text-base md:text-lg leading-relaxed text-stone-900 text-left">
                        <p>The golden age of acoustic innovation from 1950 to 1969 was a period of intense, shared creativity. However, by the end of the 1960s, the cohesive center began to dissolve. The death of John Coltrane in 1967 removed a spiritual and musical lodestar for the avant-garde. Simultaneously, Miles Davis, ever the innovator, began incorporating electric instruments and rock-influenced rhythms, paving the way for <strong>Jazz Fusion</strong> with albums like *In a Silent Way* and *Bitches Brew*. This seismic shift created a new mainstream that would dominate the 1970s.</p>
                        <p>Yet, the legacy of this entire two-decade period is profound. The harmonic vocabulary of Bebop, the soulful feel of Hard Bop, the arranging concepts of Cool Jazz, and the structural freedom of Post-Bop became a permanent part of the modern jazz language. In the 1980s, the "Young Lions" movement, led by trumpeter Wynton Marsalis, sparked a revival that looked directly back to the acoustic, small-group aesthetic of this era. This cemented the 1950-1969 period as a classic age, and its language remains the primary foundation for much of the acoustic jazz being played today.</p>
                    </div>
                      <!-- MODIFICATION: Updated Spotify Playlist -->
                      <div class="mt-16 text-left">
                          <h3 class="text-3xl text-stone-900 mb-4">Listen now on Spotify:</h3>
                          <iframe style="border-radius:0; border: 2px solid #1c1917;" src="https://open.spotify.com/embed/playlist/6nFqx9JIZD29Qxccp6mh4N?utm_source=generator" width="100%" height="500" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
                      </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="bg-stone-900 text-stone-200 py-8">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <p class="font-bold">An interactive exploration based on the "Chronological Encyclopedia of Jazz".</p>
                <p class="text-sm text-stone-400 mt-2">Designed to bring music history to life through interactive data visualization.</p>
                <div class="mt-6 border-t border-stone-700 pt-6">
                    <p id="footer-copyright" class="text-xs text-stone-400"></p>
                    <p class="text-xs text-stone-500 mt-2">Disclaimer: All music and images are the property of their respective copyright holders. This is a non-profit project for educational purposes only.</p>
                </div>
            </div>
        </footer>
    </div>
    
    <!-- Modals -->
    <div id="album-modal" class="modal fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div id="modal-content" class="modal-content bg-stone-100 border-2 border-stone-900 rounded-sm shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col transform scale-95">
            <div class="flex justify-between items-start p-4 border-b-2 border-stone-900 flex-shrink-0">
                <div>
                    <h3 id="modal-title" class="text-4xl text-orange-500"></h3>
                    <button id="modal-artist" class="text-xl text-stone-600 bg-transparent border-none p-0"></button>
                </div>
                <button id="close-modal" class="text-4xl font-bold p-2 leading-none text-stone-500 hover:text-orange-500">×</button>
            </div>
            <div id="modal-body" class="p-6 overflow-y-auto">
                <div id="modal-album-main-details" class="flex flex-col md:flex-row gap-6">
                    <div id="modal-album-art-container" class="w-full md:w-1/3 flex-shrink-0">
                        <img id="modal-album-art" src="" class="w-full h-auto rounded-sm border-2 border-stone-900" alt="" loading="lazy">
                    </div>
                    <div id="modal-album-details" class="w-full md:w-2/3"></div>
                </div>
                <div id="analysis-wrapper" class="relative mt-4">
                    <!-- Content injected by JS -->
                </div>
            </div>
             <!-- Modal Navigation Footer -->
            <div id="modal-nav-footer" class="flex justify-between items-center p-4 border-t-2 border-stone-900 flex-shrink-0 bg-stone-200">
                <button id="prev-album-btn" class="px-4 py-2 bg-stone-900 text-stone-100 rounded-sm font-bold hover:bg-orange-500 transition-colors disabled:bg-stone-400 disabled:cursor-not-allowed">Previous Album</button>
                <button id="next-album-btn" class="px-4 py-2 bg-stone-900 text-stone-100 rounded-sm font-bold hover:bg-orange-500 transition-colors disabled:bg-stone-400 disabled:cursor-not-allowed">Next Album</button>
            </div>
        </div>
    </div>
    <div id="artist-modal" class="modal fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-100 border-2 border-stone-900 rounded-sm shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col transform scale-95">
             <div class="flex justify-between items-start p-4 border-b-2 border-stone-900 flex-shrink-0">
                 <h3 id="artist-modal-title" class="text-4xl text-orange-500"></h3>
                 <button id="close-artist-modal" class="text-4xl font-bold p-2 leading-none text-stone-500 hover:text-orange-500">×</button>
             </div>
             <div id="artist-modal-body" class="p-6 overflow-y-auto"></div>
        </div>
    </div>

    <!-- MODIFICATION: Mobile Menu Overlay -->
    <div id="mobile-menu-overlay" class="hidden fixed inset-0 z-50">
        <div id="mobile-menu-bg" class="fixed inset-0 bg-black opacity-50"></div>
        <div id="mobile-menu-panel" class="fixed top-0 right-0 bottom-0 bg-stone-100 w-64 shadow-lg p-4 transform translate-x-full">
            <div class="flex justify-end mb-4">
                <button id="mobile-menu-close-button" class="p-2 -mr-2 rounded-md text-stone-900 hover:bg-stone-200 focus:outline-none">
                     <svg class="h-8 w-8" stroke="currentColor" fill="none" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <nav id="mobile-nav-links" class="flex flex-col space-y-4">
                <a href="#overview" class="mobile-nav-link text-lg font-bold text-stone-900 hover:text-orange-500">Overview</a>
                <a href="#timeline" class="mobile-nav-link text-lg font-bold text-stone-900 hover:text-orange-500">Timeline</a>
                <a href="#matrix" class="mobile-nav-link text-lg font-bold text-stone-900 hover:text-orange-500">Genres</a>
                <a href="#artists" class="mobile-nav-link text-lg font-bold text-stone-900 hover:text-orange-500">Artists</a>
                <a href="#legacy" class="mobile-nav-link text-lg font-bold text-stone-900 hover:text-orange-500">Legacy</a>
            </nav>
        </div>
    </div>


    <!-- Embedded Genre Matrix Data -->
    <script id="styleMatrixData" type="application/json">
    {
        "features": ["Harmony", "Rhythm", "Form", "Key Artists"],
        "genres": {
            "Bebop": {
                "color": "var(--genre-bebop)",
                "data": [
                    "Fast-moving, complex chord progressions (e.g., ii-V-I with substitutions), use of altered chords and extensions.",
                    "Blistering tempos, virtuosic and rhythmically complex solos, 'dropping bombs' with the bass drum.",
                    "Often based on standard song forms (like blues and 'I Got Rhythm' changes) but used as vehicles for extended improvisation.",
                    "Charlie Parker, Dizzy Gillespie, Thelonious Monk, Bud Powell"
                ]
            },
            "Hard Bop": {
                "color": "var(--genre-hard-bop)",
                "data": [
                    "Functional (ii-V-I), blues-based, gospel influences",
                    "Strong, driving swing feel, prominent drumming, danceable grooves",
                    "Standard forms (AABA, 12-bar blues), often with catchy, memorable heads",
                    "Art Blakey, Horace Silver, Clifford Brown, Lee Morgan"
                ]
            },
            "Cool Jazz": {
                "color": "var(--genre-cool-jazz)",
                "data": [
                    "More complex, often drawing from classical harmony, less blues-centric",
                    "Relaxed, subtle pulse, lighter drumming, focus on understatement",
                    "Often employed complex, contrapuntal arrangements and non-standard forms",
                    "Miles Davis (early), Dave Brubeck, Stan Getz, Gerry Mulligan"
                ]
            },
            "Modal Jazz": {
                "color": "var(--genre-modal-jazz)",
                "data": [
                    "Static harmony, based on modes/scales rather than chord progressions",
                    "Floating, ambiguous pulse, less aggressive swing, focus on texture",
                    "Open-ended, simple structures, often just a single mode or vamp",
                    "Miles Davis ('Kind of Blue'), John Coltrane ('My Favorite Things'), Bill Evans"
                ]
            },
            "Post-Bop": {
                "color": "var(--genre-post-bop)",
                "data": [
                    "Expanded functional harmony, non-functional chords, controlled dissonance",
                    "Highly interactive, fluid time, polyrhythms, elastic sense of swing",
                    "Modified standard forms, original compositions with complex, unique structures",
                    "Miles Davis's 2nd Quintet, Wayne Shorter, Herbie Hancock, Andrew Hill"
                ]
            },
            "Avant-Garde": {
                "color": "var(--genre-avant-garde)",
                "data": [
                    "Can include complex, atonal composed sections alongside free improvisation.",
                    "Ranges from free, pulseless textures to complex, composed rhythmic cycles.",
                    "Often features through-composed suites, blending written material with free improvisation.",
                    "Eric Dolphy, Andrew Hill, Grachan Moncur III, Sun Ra"
                ]
            },
            "Free Jazz": {
                "color": "var(--genre-free-jazz)",
                "data": [
                    "Abandons conventional chord progressions; focuses on texture and collective improvisation.",
                    "Often abandons a steady pulse; uses 'energy playing' and textural drumming.",
                    "Open forms, often based on a brief theme or motive, or completely improvised.",
                    "Ornette Coleman, Albert Ayler, Cecil Taylor, Pharoah Sanders"
                ]
            },
            "Jazz Fusion": {
                "color": "var(--genre-jazz-fusion)",
                "data": [
                    "Electric piano (Rhodes, Wurlitzer), synthesizers; post-bop harmony mixed with simpler rock/funk vamps.",
                    "Driving, straight-eighth rock and funk grooves, complex polyrhythms, high-energy drumming.",
                    "Extended, often through-composed forms, long open improvisations over vamps.",
                    "Miles Davis (late), Herbie Hancock, Weather Report, Mahavishnu Orchestra"
                ]
            }
        }
    }
    </script>
    
    <!-- Main Application Script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Get genre matrix data from the embedded script tag
            const styleMatrixDataEl = document.getElementById('styleMatrixData');
            const styleMatrixData = JSON.parse(styleMatrixDataEl.textContent);

            // Fetch the rest of the data from the external file
            fetch('database.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(dbData => {
                    // Initialize the application with both data sources
                    initializeAppUI({ ...dbData, styleMatrix: styleMatrixData });
                    
                    // Show the page and hide loader
                    document.getElementById('loader').style.display = 'none';
                    document.getElementById('page-content').classList.remove('content-hidden');
                    
                    // FIX: Ensure timeline starts at the beginning after rendering
                    setTimeout(() => {
                        document.getElementById('horizontal-timeline-container').scrollLeft = 0;
                    }, 0);
                })
                .catch(error => {
                    console.error('Error fetching or parsing database.json:', error);
                    // Display an informative error message to the user on the page
                    const pageContent = document.getElementById('page-content');
                    pageContent.innerHTML = `<div class="text-center p-8">
                        <h2 class="text-2xl font-bold text-red-600">Failed to Load Data</h2>
                        <p class="text-stone-600 mt-2">Could not fetch album/artist data. Please ensure 'database.json' is available.</p>
                        <p class="text-sm text-stone-500 mt-4">Error: ${error.message}</p>
                    </div>`;
                    document.getElementById('loader').style.display = 'none';
                    pageContent.classList.remove('content-hidden');
                });
        });

        function initializeAppUI(data) {
            
            // Destructure data from the fetched JSON
            let { albums, styleMatrix: styleMatrixData, artistProfiles } = data;
            let artistsData = []; // Will be populated by processArtists

            // Global state for album navigation
            let currentAlbumIndex = -1;
            
            const monthMap = { "January": 0, "February": 1, "March": 2, "April": 3, "May": 4, "June": 5, "July": 6, "August": 7, "September": 8, "October": 9, "November": 10, "December": 11 };
            
            // [FIX] More robust date parsing function
            function parseDate(dateString) {
                if (typeof dateString !== 'string') return null;

                // Handle circa dates like "c. late 1958" or "c. Fall 1965"
                if (dateString.toLowerCase().startsWith('c.')) {
                    const yearMatch = dateString.match(/\d{4}/);
                    if (yearMatch) {
                        const year = parseInt(yearMatch[0]);
                        return new Date(year, 11, 31); // Assume end of year
                    }
                }

                const parts = dateString.replace(/,/g, '').split(' ');
                
                // Handle "Month Day, Year" e.g., "August 4, 1952"
                if (parts.length === 3 && monthMap.hasOwnProperty(parts[0])) {
                    return new Date(parts[2], monthMap[parts[0]], parts[1]);
                }
                
                // Handle "Month Year" e.g., "August 1960"
                if (parts.length === 2 && monthMap.hasOwnProperty(parts[0])) {
                    return new Date(parts[1], monthMap[parts[0]], 1);
                }

                // Handle "Year" only e.g., "1958"
                if (parts.length === 1 && !isNaN(parts[0])) {
                    return new Date(parts[0], 0, 1);
                }

                return null; // Return null if no format matches
            }
            
            // Helper to format names for audio file paths
            const slugify = (name) => {
                if (!name) return '';
                return name.toLowerCase()
                    .replace(/\s+/g, '-') // Replace spaces with -
                    .replace(/[^\w-]+/g, '') // Remove all non-word chars
                    .replace(/--+/g, '-') // Replace multiple - with single -
                    .replace(/^-+/, '') // Trim - from start of text
                    .replace(/-+$/, ''); // Trim - from end of text
            }

            // Sort albums by their first recording date
            albums.forEach(album => {
                if (album.pivotalTracks && album.pivotalTracks.length > 0) {
                    // Sort tracks within the album first
                    album.pivotalTracks.sort((a,b) => parseDate(a.recordingDate) - parseDate(b.recordingDate));
                    // Assign the first date to the album for sorting
                    album.firstRecordingDate = album.pivotalTracks[0].recordingDate;
                }
            });
            albums.sort((a,b) => parseDate(a.firstRecordingDate) - parseDate(b.firstRecordingDate));
            
            const years = [...new Set(albums.map(album => album.year))].sort();
            const groupedByYear = years.reduce((acc, year) => {
                acc[year] = albums.filter(d => d.year === year);
                return acc;
            }, {});

            const timelineContainer = document.getElementById('horizontal-timeline-container');
            const timelineWrapper = document.getElementById('timeline-wrapper');
            const timelineCanvas = document.getElementById('timeline-canvas');
            const ctx = timelineCanvas.getContext('2d');
            const scrollLeftBtn = document.getElementById('scroll-left-btn');
            const scrollRightBtn = document.getElementById('scroll-right-btn');
            
            // --- DYNAMIC GENRE and COLOR MAP CREATION ---
            const baseGenreColors = styleMatrixData.genres ? Object.keys(styleMatrixData.genres).reduce((acc, genre) => {
                acc[genre] = styleMatrixData.genres[genre].color;
                return acc;
            }, {}) : {};
            
            const fullGenreColorMap = { ...baseGenreColors };
            // Manually add colors for specific genres not in the matrix
            fullGenreColorMap['Free Jazz'] = 'var(--genre-free-jazz)';
            fullGenreColorMap['Avant-Garde Jazz'] = 'var(--genre-avant-garde)'; 
            fullGenreColorMap['Jazz Fusion'] = 'var(--genre-jazz-fusion)';


            albums.forEach(album => {
                if(album.genres) {
                    album.genres.split(', ').forEach(genre => {
                        if (!fullGenreColorMap[genre]) {
                           fullGenreColorMap[genre] = 'var(--genre-default)';
                        }
                    });
                }
            });

            // Dynamically create the list of filterable genres from the data
            const allGenresInDB = new Set();
            albums.forEach(album => {
                if (album.genres) {
                    album.genres.split(', ').forEach(genre => allGenresInDB.add(genre.trim()));
                }
            });
            
            // Define genres to exclude from the filter list
            const excludedGenres = ['Bossa Nova', 'Chamber Jazz', 'Latin Jazz', 'Soul Jazz', 'Spiritual Jazz', 'Afro-Jazz', 'Ambient Jazz', 'Jazz-Funk', 'Third Stream', 'World Jazz'];

            // Create the final list of genres to display in the filter
            const filterableGenres = Array.from(allGenresInDB)
                .filter(genre => !excludedGenres.includes(genre))
                .sort();

            
            // --- Redesigned Filter Logic ---

            const genreFilterBtn = document.getElementById('genre-filter-btn');
            const genreFilterPanel = document.getElementById('genre-filter-panel');
            const yearJumper = document.getElementById('year-jumper');
            const stickyYearDisplay = document.getElementById('sticky-year-display');

            // Populate Genre Filter Dropdown
            const genrePanelContent = document.createElement('div');
            genrePanelContent.className = 'genre-dropdown-panel';

            const allCheckboxLabel = document.createElement('label');
            allCheckboxLabel.className = 'genre-checkbox-label col-span-2'; // Span across two columns
            allCheckboxLabel.style.setProperty('--genre-color', 'var(--text-muted)');
            const allCheckbox = document.createElement('input');
            allCheckbox.type = 'checkbox';
            allCheckbox.id = 'all-genres-checkbox';
            allCheckbox.checked = true;
            allCheckboxLabel.appendChild(allCheckbox);
            allCheckboxLabel.append('All Genres');
            genrePanelContent.appendChild(allCheckboxLabel);

            filterableGenres.forEach(genre => {
                const label = document.createElement('label');
                label.className = 'genre-checkbox-label';
                label.style.setProperty('--genre-color', fullGenreColorMap[genre] || 'var(--genre-default)');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = genre;
                checkbox.dataset.genre = genre;
                checkbox.checked = true;
                label.appendChild(checkbox);
                label.append(genre);
                genrePanelContent.appendChild(label);
            });
            genreFilterPanel.appendChild(genrePanelContent);
            
            const allGenreCheckboxes = genreFilterPanel.querySelectorAll('input[data-genre]');

            function updateGenreButtonText() {
                const selectedCount = genreFilterPanel.querySelectorAll('input[data-genre]:checked').length;
                const buttonSpan = genreFilterBtn.querySelector('span');
                if (selectedCount === allGenreCheckboxes.length) {
                    buttonSpan.textContent = 'All Genres Selected';
                } else if (selectedCount === 0) {
                    buttonSpan.textContent = 'No Genres Selected';
                } else {
                    buttonSpan.textContent = `${selectedCount} Genre(s) Selected`;
                }
            }

            allCheckbox.addEventListener('change', () => {
                allGenreCheckboxes.forEach(cb => {
                    cb.checked = allCheckbox.checked;
                });
                filterTimeline();
                updateGenreButtonText();
            });

            genreFilterPanel.addEventListener('change', (e) => {
                if (e.target.matches('input[type="checkbox"]')) {
                    if(e.target.id !== 'all-genres-checkbox') {
                        const allChecked = Array.from(allGenreCheckboxes).every(cb => cb.checked);
                        allCheckbox.checked = allChecked;
                    }
                    filterTimeline();
                    updateGenreButtonText();
                }
            });

            genreFilterBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                genreFilterPanel.classList.toggle('hidden');
            });

            document.addEventListener('click', (e) => {
                if (!document.getElementById('genre-filter-dropdown-container').contains(e.target)) {
                    genreFilterPanel.classList.add('hidden');
                }
            });

            // Populate Year Jumper
            yearJumper.innerHTML = `<option value="">Jump to Year</option>`;
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearJumper.appendChild(option);
            });

            yearJumper.addEventListener('change', () => {
                const year = yearJumper.value;
                if (year) {
                    const yearSection = document.getElementById(`year-${year}`);
                    if (yearSection) {
                        timelineContainer.scrollTo({ left: yearSection.offsetLeft - 30, behavior: 'smooth' });
                    }
                }
            });
            
            // Corrected Filter Logic
            function filterTimeline() {
                const selectedGenres = Array.from(genreFilterPanel.querySelectorAll('input[data-genre]:checked')).map(input => input.value);

                document.querySelectorAll('.timeline-album-card').forEach(card => {
                    const cardGenres = card.dataset.genres.split(', ');
                    
                    const isVisible = cardGenres.some(genre => selectedGenres.includes(genre));
                    
                    if (isVisible) {
                        card.classList.remove('hidden');
                    } else {
                        card.classList.add('hidden');
                    }
                });

                document.querySelectorAll('.timeline-year-section').forEach(yearSection => {
                    const visibleCards = yearSection.querySelectorAll('.timeline-album-card:not(.hidden)');
                    yearSection.style.display = visibleCards.length > 0 ? 'flex' : 'none';
                });
                
                const allChecked = selectedGenres.length === allGenreCheckboxes.length;
                allCheckbox.checked = allChecked;
            }
            
            updateGenreButtonText(); // Initial text


            // --- Timeline Rendering ---
            timelineWrapper.innerHTML = '';
            if (years.length > 0) {
                // Add a spacer element to create a visual buffer on the left
                const spacer = document.createElement('div');
                spacer.style.width = '1px'; 
                spacer.style.flexShrink = '0';
                timelineWrapper.appendChild(spacer);
                
                years.forEach(year => {
                    const yearSection = document.createElement('div');
                    yearSection.className = 'timeline-year-section';
                    yearSection.id = `year-${year}`;
                    
                    const yearHeader = document.createElement('div');
                    yearHeader.className = 'timeline-year-header';
                    yearHeader.textContent = year;
                    yearSection.appendChild(yearHeader);
                    
                    const albumList = document.createElement('div');
                    albumList.className = 'timeline-album-list';
                    albumList.id = `album-list-${year}`;
                    
                    groupedByYear[year].forEach(album => {
                        const card = document.createElement('div');
                        card.className = 'timeline-album-card fade-in-element';
                        card.dataset.albumTitle = album.albumTitle;
                        card.dataset.artist = album.artist;
                        card.dataset.genres = album.genres;
                        card.innerHTML = `<img src="${album.cover || ''}" alt="Cover for ${album.albumTitle}" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/200x200/1c1917/f5f5f4?text=No+Image';"><div class="timeline-album-card-info"><h5 class="font-bold truncate">${album.albumTitle}</h5><p class="truncate">${album.artist}</p></div>`;
                        albumList.appendChild(card);
                    });

                    yearSection.appendChild(albumList);
                    timelineWrapper.appendChild(yearSection);
                });
                
                // Initial Filter
                filterTimeline();
            } else {
                 timelineWrapper.innerHTML = '<p class="text-stone-500">No timeline data available.</p>';
            }

            const scrollAmount = 400;
            scrollLeftBtn.addEventListener('click', () => timelineContainer.scrollBy({ left: -scrollAmount, behavior: 'smooth' }));
            scrollRightBtn.addEventListener('click', () => timelineContainer.scrollBy({ left: scrollAmount, behavior: 'smooth' }));

            const albumModal = document.getElementById('album-modal');
            const albumModalContent = albumModal.querySelector('.modal-content');
            
            let mobileCardSelectedForModal = null;

            // --- Desktop Hover Effects ---
            timelineWrapper.addEventListener('mouseover', (e) => {
                if (window.innerWidth < 768) return; // Desktop only

                const card = e.target.closest('.timeline-album-card');
                if (card && !card.classList.contains('hidden') && !document.querySelector('.timeline-album-card.clicked')) {
                    applyHighlights(card);
                }
            });

            timelineWrapper.addEventListener('mouseout', (e) => {
                if (window.innerWidth < 768) return; // Desktop only

                const card = e.target.closest('.timeline-album-card');
                if (card && !document.querySelector('.timeline-album-card.clicked')) {
                    applyHighlights(null);
                }
            });

            // --- Unified Click Handler for Mobile and Desktop ---
            timelineWrapper.addEventListener('click', e => {
                const card = e.target.closest('.timeline-album-card');
                const isMobile = window.innerWidth < 768;

                if (!card) {
                    if (isMobile && mobileCardSelectedForModal) {
                        applyHighlights(null);
                        mobileCardSelectedForModal = null;
                    }
                    return;
                }

                if (!card.classList.contains('hidden')) {
                    if (isMobile) {
                        if (mobileCardSelectedForModal === card) {
                            const { albumTitle, artist } = card.dataset;
                            const albumIndex = albums.findIndex(a => a.albumTitle === albumTitle && a.artist === artist);
                            if (albumIndex !== -1) {
                                applyHighlights(null);
                                openAlbumModal(albums[albumIndex], albumIndex);
                            }
                            mobileCardSelectedForModal = null;
                        } else {
                            applyHighlights(card);
                            mobileCardSelectedForModal = card;
                        }
                    } else {
                        const { albumTitle, artist } = card.dataset;
                        const albumIndex = albums.findIndex(a => a.albumTitle === albumTitle && a.artist === artist);
                        if (albumIndex !== -1) {
                            openAlbumModal(albums[albumIndex], albumIndex);
                        }
                    }
                }
            });


            function openAlbumModal(album, index) {
                currentAlbumIndex = index;

                const previouslyClicked = document.querySelector('.timeline-album-card.clicked');
                if (previouslyClicked) {
                    previouslyClicked.classList.remove('clicked');
                }
                const safeAlbumTitle = album.albumTitle.replace(/"/g, '\\"');
                const safeArtist = album.artist.replace(/"/g, '\\"');
                const cardToHighlight = document.querySelector(`.timeline-album-card[data-album-title="${safeAlbumTitle}"][data-artist="${safeArtist}"]`);
                if (cardToHighlight) {
                    cardToHighlight.classList.add('clicked');
                }
                
                albumModal.querySelector('#modal-title').textContent = album.albumTitle;
                
                const artistBtn = albumModal.querySelector('#modal-artist');
                artistBtn.textContent = album.artist;
                artistBtn.dataset.artistName = album.artist;
                artistBtn.className = 'text-xl text-stone-600 bg-transparent border-none p-0 clickable-link';

                const modalImg = albumModal.querySelector('#modal-album-art');
                modalImg.src = album.cover || '';
                modalImg.alt = `Cover for ${album.albumTitle}`;
                modalImg.onerror = function() { this.onerror=null; this.src='https://placehold.co/400x400/1c1917/f5f5f4?text=No+Image'; };
                const firstTrack = album.pivotalTracks[0] || {};
                
                const genreTags = album.genres.split(', ').map(genre => {
                    const colorVar = fullGenreColorMap[genre] || 'var(--genre-default)';
                    return `<span class="genre-tag" style="background-color: ${colorVar}">${genre}</span>`;
                }).join(' ');
                
                const lineupHtml = firstTrack.lineup ? firstTrack.lineup.split(/, (?![^()]*\))/).map(personnel => {
                    const match = personnel.trim().match(/(.+?)\s\((.+)\)/);
                    if (match) {
                        const name = match[1].trim();
                        const instrument = match[2];
                        const artistExists = artistsData.some(a => a.name === name);
                        if (artistExists) {
                            return `<span class="clickable-link" data-artist-name="${name}">${name}</span> (${instrument})`;
                        }
                    }
                    return personnel;
                }).join(', ') : 'N/A';


                const detailsContainer = albumModal.querySelector('#modal-album-details');
                 detailsContainer.innerHTML = `
                                  <h4 class="text-3xl text-stone-900 mb-4">Album Details</h4>
                                  <div class="grid grid-cols-[auto,1fr] gap-x-4 gap-y-2 text-base text-stone-900">
                                      <strong class="font-bold">Genre:</strong> <div class="flex flex-wrap gap-2">${genreTags}</div>
                                      <strong class="font-bold">Recorded:</strong> <span>${firstTrack.recordingDate || 'N/A'}</span>
                                      <strong class="font-bold">Label:</strong> <span>${firstTrack.label || 'N/A'}</span>
                                      <strong class="font-bold align-top">Line-Up:</strong> <span>${lineupHtml}</span>
                                  </div>`;

                const analysisWrapper = albumModal.querySelector('#analysis-wrapper');
                analysisWrapper.innerHTML = '';
                
                const analysisContainer = document.createElement('div');
                analysisContainer.id = 'modal-analysis-section';
                
                const pivotalTracksHtml = album.pivotalTracks.map(track => {
                    const songFileName = slugify(track.title) + '.mp3';
                     return `
                                     <div class="mb-8 last:mb-0">
                                         <div class="flex justify-between items-center gap-4 mb-4 flex-wrap">
                                             <h5 class="text-2xl font-bold text-white flex-1 min-w-0">Key Track: "<span class="underline decoration-orange-500 decoration-2 underline-offset-4">${track.title}</span>"</h5>
                                             <audio controls class="styled-player w-full sm:w-52" src="songs/${songFileName}" preload="none"></audio>
                                         </div>
                                         <p class="liner-notes-text">${track.analysis}</p>
                                     </div>
                                 `;
                }).join('<hr class="border-stone-700 my-8">');

                analysisContainer.innerHTML = pivotalTracksHtml;
                analysisWrapper.appendChild(analysisContainer);
                
                const audioPlayers = analysisContainer.querySelectorAll('audio');
                audioPlayers.forEach(player => {
                    player.addEventListener('play', () => {
                        audioPlayers.forEach(otherPlayer => {
                            if (otherPlayer !== player) {
                                otherPlayer.pause();
                            }
                        });
                    });
                });

                const prevBtn = document.getElementById('prev-album-btn');
                const nextBtn = document.getElementById('next-album-btn');
                prevBtn.disabled = currentAlbumIndex === 0;
                nextBtn.disabled = currentAlbumIndex === albums.length - 1;

                albumModal.classList.remove('opacity-0', 'pointer-events-none');
                albumModalContent.classList.remove('scale-95');
                albumModal.querySelector('#modal-body').scrollTop = 0;
            }
            
            function closeAlbumModal() {
                albumModal.classList.add('opacity-0', 'pointer-events-none');
                albumModalContent.classList.add('scale-95');
                albumModal.querySelectorAll('audio').forEach(audio => audio.pause());
                const clickedCard = document.querySelector('.timeline-album-card.clicked');
                if (clickedCard) {
                    clickedCard.classList.remove('clicked');
                }
            }
            albumModal.querySelector('#close-modal').addEventListener('click', closeAlbumModal);
            albumModal.addEventListener('click', e => { if (e.target.id === 'album-modal') closeAlbumModal(); });

            document.getElementById('prev-album-btn').addEventListener('click', () => {
                if (currentAlbumIndex > 0) {
                    openAlbumModal(albums[currentAlbumIndex - 1], currentAlbumIndex - 1);
                }
            });
             document.getElementById('next-album-btn').addEventListener('click', () => {
                if (currentAlbumIndex < albums.length - 1) {
                    openAlbumModal(albums[currentAlbumIndex + 1], currentAlbumIndex + 1);
                }
            });

            const allTracks = albums.flatMap(album =>
                album.pivotalTracks.map(track => ({
                    ...track,
                    year: album.year,
                    artist: album.artist,
                    album: album.albumTitle,
                    cover: album.cover,
                    genre: album.genres
                }))
            );
            artistsData = processArtists(allTracks, artistProfiles);
            
            const instrumentFilter = document.getElementById('instrument-filter');
            const artistGrid = document.getElementById('artist-grid');
            const artistPrevBtn = document.getElementById('artist-prev-btn');
            const artistNextBtn = document.getElementById('artist-next-btn');
            const artistPageIndicator = document.getElementById('artist-page-indicator');
            const artistPaginationControls = document.getElementById('artist-pagination-controls');

            let currentArtistPage = 1;
            let filteredArtists = [];
            let pageSize = window.innerWidth >= 768 ? 12 : 6;
            
            function processArtists(tracks, profiles) {
                const artistsMap = new Map();
                
                tracks.forEach(track => {
                    if (!track.lineup) return;
                    const lineupParts = track.lineup.split(/,(?![^()]*\))/);

                    lineupParts.forEach(part => {
                        const match = part.trim().match(/(.+?)\s\((.+)\)/);
                        if (match) {
                            let name = match[1].trim();
                            if (name === 'Anthony Williams') {
                                name = 'Tony Williams';
                            }
                            const instrumentsString = match[2];
                            if (!artistsMap.has(name)) {
                                artistsMap.set(name, { 
                                    name: name, 
                                    instruments: new Set(), 
                                    albums: new Set(), 
                                    photo: `images/${slugify(name)}.jpg`,
                                    isBandleader: false,
                                    profile: ''
                                });
                            }
                            const artistEntry = artistsMap.get(name);
                            if (track.artist && track.artist.includes(name)) {
                                artistEntry.isBandleader = true;
                            }
                            if (profiles && profiles[name]) {
                                artistEntry.profile = profiles[name];
                            }
                            instrumentsString.split(/, | \/ /).forEach(inst => {
                                const trimmedInst = inst.trim();
                                if (trimmedInst && !/vocals|arranger|reeds/i.test(trimmedInst)) {
                                    artistEntry.instruments.add(trimmedInst);
                                }
                            });
                            artistEntry.albums.add(track.album);
                        }
                    });
                });
                
                const artistsArray = Array.from(artistsMap.values());
                artistsArray.forEach(artist => {
                    artist.instruments = Array.from(artist.instruments);
                    artist.albums = Array.from(artist.albums);
                });
                return artistsArray;
            }

            function populateInstrumentFilter(artists) {
                const relevantInstruments = new Set([
                    'alto saxophone', 'baritone saxophone', 'bass', 'bass clarinet', 'cornet', 
                    'drums', 'flugelhorn', 'flute', 'guitar', 'organ', 'piano', 
                    'soprano saxophone', 'tenor saxophone', 'trombone', 'trumpet', 'tuba', 'vibraphone', 'congas'
                ]);
                
                const instrumentsInDataset = new Set();
                artists.forEach(artist => {
                    artist.instruments.forEach(instrument => {
                        if (relevantInstruments.has(instrument)) {
                           instrumentsInDataset.add(instrument);
                        }
                    });
                });
                
                const sortedInstruments = Array.from(instrumentsInDataset).sort();

                instrumentFilter.innerHTML = '<option value="all">All Instruments</option>';
                sortedInstruments.forEach(instrument => {
                    const option = document.createElement('option');
                    option.value = instrument;
                    option.textContent = instrument.charAt(0).toUpperCase() + instrument.slice(1);
                    instrumentFilter.appendChild(option);
                });
            }

            function renderArtistGridPage(artistsToRender) {
                artistGrid.innerHTML = ''; 

                if (artistsToRender.length === 0) {
                    artistGrid.innerHTML = `<div class="w-full text-center p-8 text-stone-500 col-span-full">No artists found.</div>`;
                    return;
                }
                
                artistsToRender.forEach(artist => {
                    const card = document.createElement('div');
                    card.className = 'artist-card';
                    
                    if (artist.isBandleader) {
                        card.style.boxShadow = `4px 4px 0px var(--accent)`;
                    }
                    
                    card.dataset.artistName = artist.name;
                    
                    card.innerHTML = `
                        <div class="h-56 bg-stone-900 artist-photo-container">
                            <img src="${artist.photo || ''}" loading="lazy" alt="Photo of ${artist.name}" class="w-full h-full object-cover" onerror="this.onerror=null;this.src='images/artistplaceholder.jpg';">
                        </div>
                        <div class="p-3">
                            <h4 class="font-bold text-base text-stone-900 truncate">${artist.name}</h4>
                        </div>`;

                    card.addEventListener('click', () => openArtistModal(artist));
                    artistGrid.appendChild(card);
                });
            }

            function updateArtistPagination() {
                pageSize = window.innerWidth >= 768 ? 12 : 6;
                const totalPages = Math.ceil(filteredArtists.length / pageSize);

                if (currentArtistPage > totalPages) currentArtistPage = totalPages > 0 ? totalPages : 1;
                if (currentArtistPage < 1) currentArtistPage = 1;

                const startIndex = (currentArtistPage - 1) * pageSize;
                const endIndex = startIndex + pageSize;
                const artistsForPage = filteredArtists.slice(startIndex, endIndex);

                renderArtistGridPage(artistsForPage);

                if (totalPages <= 1) {
                    artistPaginationControls.classList.add('hidden');
                } else {
                    artistPaginationControls.classList.remove('hidden');
                    artistPageIndicator.textContent = `Page ${currentArtistPage} of ${totalPages}`;
                    artistPrevBtn.disabled = currentArtistPage === 1;
                    artistNextBtn.disabled = currentArtistPage === totalPages;
                }
            }

            function filterAndPaginateArtists() {
                currentArtistPage = 1;
                const selectedInstrument = instrumentFilter.value;
                
                filteredArtists = selectedInstrument === 'all'
                    ? [...artistsData]
                    : artistsData.filter(artist => artist.instruments.includes(selectedInstrument));
                
                filteredArtists.sort((a, b) => {
                    if (a.isBandleader !== b.isBandleader) return a.isBandleader ? -1 : 1;
                    return a.name.localeCompare(b.name);
                });

                updateArtistPagination();
            }

            const artistModal = document.getElementById('artist-modal');
            const artistModalContent = artistModal.querySelector('.modal-content');
            
            function openArtistModal(artist) {
                artistModal.querySelector('#artist-modal-title').textContent = artist.name;
                const body = artistModal.querySelector('#artist-modal-body');
                
                const albumListHtml = artist.albums.map(albumTitle => {
                    const albumData = albums.find(a => a.albumTitle === albumTitle);
                    if (!albumData) return `<li>${albumTitle}</li>`; // Fallback if album not found
                    return `<li class="clickable-link" data-album-title="${albumData.albumTitle}" data-artist="${albumData.artist}">${albumTitle}</li>`;
                }).join('');

                body.innerHTML = `
                <div class="flex flex-col sm:flex-row gap-6">
                    <div class="w-full sm:w-1/3 flex-shrink-0 artist-photo-container">
                        <img src="${artist.photo || ''}" loading="lazy" class="w-full h-auto rounded-sm border-2 border-stone-900" onerror="this.onerror=null;this.src='images/artistplaceholder.jpg';">
                    </div>
                    <div class="w-full sm:w-2/3">
                        <h4 class="text-3xl text-stone-900 mb-3">Details</h4>
                        <p class="mb-4 text-stone-900"><strong class="font-bold">Instruments:</strong> ${artist.instruments.join(', ')}</p>
                        <h4 class="text-3xl text-stone-900 mb-3">Album Appearances</h4>
                        <ul class="list-disc list-inside text-sm space-y-1 text-stone-900 h-32 overflow-y-auto">${albumListHtml}</ul>
                    </div>
                </div>
                ${artist.profile ? `<div class="mt-6 pt-4 border-t-2 border-stone-200">
                        <h4 class="text-2xl text-stone-900 mb-2">Profile</h4>
                        <p class="text-base text-stone-700 leading-relaxed">${artist.profile}</p>
                    </div>` : ''}
                `;
                artistModal.classList.remove('opacity-0', 'pointer-events-none');
                artistModalContent.classList.remove('scale-95');
            }

            function closeArtistModal() {
                artistModal.classList.add('opacity-0', 'pointer-events-none');
                artistModalContent.classList.add('scale-95');
            }
            
            artistModal.querySelector('#close-artist-modal').addEventListener('click', closeArtistModal);
            artistModal.addEventListener('click', e => { if (e.target.id === 'artist-modal') closeArtistModal(); });
            document.addEventListener('keydown', e => { if (e.key === "Escape") { closeAlbumModal(); closeArtistModal(); } });
            
            document.getElementById('modal-artist').addEventListener('click', (e) => {
                const artistName = e.target.dataset.artistName;
                if (!artistName) return;
                const artist = artistsData.find(a => a.name === artistName);
                if (artist) {
                    closeAlbumModal();
                    setTimeout(() => openArtistModal(artist), 250);
                }
            });

            document.getElementById('artist-modal-body').addEventListener('click', (e) => {
                if (e.target.matches('.clickable-link[data-album-title]')) {
                    const albumTitle = e.target.dataset.albumTitle;
                    const artistName = e.target.dataset.artist;
                    const albumIndex = albums.findIndex(a => a.albumTitle === albumTitle && a.artist === artistName);
                    if (albumIndex !== -1) {
                        closeArtistModal();
                        setTimeout(() => openAlbumModal(albums[albumIndex], albumIndex), 250);
                    }
                }
            });
            
            document.getElementById('modal-album-details').addEventListener('click', (e) => {
                if (e.target.matches('.clickable-link[data-artist-name]')) {
                    const artistName = e.target.dataset.artistName;
                    const artist = artistsData.find(a => a.name === artistName);
                    if (artist) {
                        closeAlbumModal();
                        setTimeout(() => openArtistModal(artist), 250);
                    }
                }
            });

            populateInstrumentFilter(artistsData);
            instrumentFilter.addEventListener('change', filterAndPaginateArtists);
            
            artistPrevBtn.addEventListener('click', () => {
                if (currentArtistPage > 1) {
                    currentArtistPage--;
                    updateArtistPagination();
                }
            });

            artistNextBtn.addEventListener('click', () => {
                const totalPages = Math.ceil(filteredArtists.length / pageSize);
                if (currentArtistPage < totalPages) {
                    currentArtistPage++;
                    updateArtistPagination();
                }
            });
            
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    updateArtistPagination();
                    resizeCanvas();
                }, 200);
            });
            
            filterAndPaginateArtists();


            // --- MODIFICATION: Build the new genre matrix ---
            const matrixContainer = document.getElementById('style-matrix-table');
            if (styleMatrixData.features && styleMatrixData.genres) {
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                headerRow.innerHTML = `<th class="p-4 font-bold text-2xl w-48 text-left">Genre</th>`;
                styleMatrixData.features.forEach(feature => {
                    headerRow.innerHTML += `<th class="p-4 font-bold text-2xl text-center">${feature}</th>`;
                });
                thead.appendChild(headerRow);
                matrixContainer.appendChild(thead);

                const tbody = document.createElement('tbody');
                Object.keys(styleMatrixData.genres).forEach(genreName => {
                    const genreData = styleMatrixData.genres[genreName];
                    const row = document.createElement('tr');
                    
                    let rowHtml = `<th style="background-color:${genreData.color};">${genreName}</th>`;
                    
                    genreData.data.forEach(dataPoint => {
                        rowHtml += `<td>${dataPoint}</td>`;
                    });
                    row.innerHTML = rowHtml;
                    tbody.appendChild(row);
                });
                matrixContainer.appendChild(tbody);
                 // Add cross-hover effect logic
                const table = document.getElementById('style-matrix-table');
                if (table) {
                    table.addEventListener('mouseover', (e) => {
                        if (e.target.tagName === 'TD' || e.target.tagName === 'TH') {
                             // Clear previous highlights first
                            table.querySelectorAll('.row-hover, .col-hover').forEach(el => {
                                el.classList.remove('row-hover', 'col-hover');
                            });

                            const cell = e.target;
                            const row = cell.parentElement;
                            const cellIndex = cell.cellIndex;
                            const headerCell = row.querySelector('th');
                            const baseRgb = window.getComputedStyle(headerCell).backgroundColor;
                            
                            const highlightColor = baseRgb.replace('rgb', 'rgba').replace(')', ', 0.2)');
                            const highlightColorDark = baseRgb.replace('rgb', 'rgba').replace(')', ', 0.4)');

                            table.style.setProperty('--highlight-color', highlightColor);
                            table.style.setProperty('--highlight-color-dark', highlightColorDark);

                            // Add row highlight
                            row.classList.add('row-hover');

                            // Add column highlight
                            table.querySelectorAll('tr').forEach(r => {
                                if (r.cells[cellIndex]) {
                                    r.cells[cellIndex].classList.add('col-hover');
                                }
                            });
                        }
                    });

                    table.addEventListener('mouseleave', () => {
                        table.querySelectorAll('.row-hover, .col-hover').forEach(el => {
                            el.classList.remove('row-hover', 'col-hover');
                        });
                    });
                }
            } else {
                document.getElementById('genre-matrix-container').innerHTML = '<p class="text-center p-4 text-stone-500">No genre data available.</p>';
            }
            
            // --- Mobile Menu Logic ---
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
            const mobileMenuPanel = document.getElementById('mobile-menu-panel');
            const mobileMenuCloseButton = document.getElementById('mobile-menu-close-button');
            const mobileNavLinks = document.querySelectorAll('#mobile-nav-links a');

            function openMobileMenu() {
                mobileMenuOverlay.classList.remove('hidden');
                setTimeout(() => {
                    mobileMenuPanel.style.transform = 'translateX(0)';
                }, 10);
            }

            function closeMobileMenu() {
                mobileMenuPanel.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    mobileMenuOverlay.classList.add('hidden');
                }, 300);
            }

            mobileMenuButton.addEventListener('click', openMobileMenu);
            mobileMenuCloseButton.addEventListener('click', closeMobileMenu);
            document.getElementById('mobile-menu-bg').addEventListener('click', closeMobileMenu);

            mobileNavLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    closeMobileMenu();
                    const targetId = link.getAttribute('href');
                    const targetElement = document.querySelector(targetId);
                    if (targetElement) {
                         setTimeout(() => {
                             window.scrollTo({
                                top: targetElement.offsetTop - 80,
                                behavior: 'smooth'
                            });
                         }, 300); // Wait for menu to close
                    }
                });
            });
            
            function setupDraggable(container) {
                if (!container) return;
                let isDown = false;
                let startX;
                let scrollLeft;
                container.addEventListener('mousedown', (e) => {
                    isDown = true;
                    container.style.cursor = 'grabbing';
                    startX = e.pageX - container.offsetLeft;
                    scrollLeft = container.scrollLeft;
                });
                container.addEventListener('mouseleave', () => { isDown = false; container.style.cursor = 'grab'; });
                container.addEventListener('mouseup', () => { isDown = false; container.style.cursor = 'grab'; });
                container.addEventListener('mousemove', (e) => {
                    if(!isDown) return;
                    e.preventDefault();
                    const x = e.pageX - container.offsetLeft;
                    const walk = (x - startX) * 2;
                    container.scrollLeft = scrollLeft - walk;
                });
            }

            setupDraggable(timelineContainer);

            function resizeCanvas() {
                timelineCanvas.width = timelineWrapper.scrollWidth;
                timelineCanvas.height = timelineWrapper.offsetHeight;
            }

            function applyHighlights(selectedCard) {
                document.querySelectorAll('.timeline-album-card').forEach(c => {
                    c.classList.remove('dimmed', 'highlighted');
                    c.style.removeProperty('--highlight-color');
                });

                if (!selectedCard) {
                    return;
                }

                document.querySelectorAll('.timeline-album-card').forEach(c => c.classList.add('dimmed'));
                selectedCard.classList.remove('dimmed');
                selectedCard.classList.add('highlighted');

                const selectedGenres = selectedCard.dataset.genres.split(', ');
                const primaryGenre = selectedGenres[0];
                const highlightColor = fullGenreColorMap[primaryGenre] || 'var(--accent)';
                selectedCard.style.setProperty('--highlight-color', highlightColor);

                const otherCards = Array.from(document.querySelectorAll('.timeline-album-card:not(.hidden)'));
                
                otherCards.forEach(card => {
                    if (card === selectedCard) return;

                    const cardGenres = card.dataset.genres.split(', ');
                    const hasConnection = cardGenres.includes(primaryGenre);

                    if (hasConnection) {
                        card.classList.remove('dimmed');
                        card.classList.add('highlighted');
                        card.style.setProperty('--highlight-color', highlightColor);
                    }
                });
            }

            // Sticky Header Scroll Logic
            let lastKnownYear = '';
            timelineContainer.addEventListener('scroll', () => {
                let currentYear = '';
                const scrollLeft = timelineContainer.scrollLeft;
                const containerWidth = timelineContainer.offsetWidth;

                // Find the current year based on what's visible
                for (const year of years) {
                    const section = document.getElementById(`year-${year}`);
                    if (section && section.style.display !== 'none') {
                         if (section.offsetLeft <= scrollLeft + 60) { // 60px offset
                            currentYear = year;
                        }
                    }
                }
                
                if (currentYear && currentYear !== lastKnownYear) {
                    lastKnownYear = currentYear;
                    
                    stickyYearDisplay.style.opacity = '0';
                    setTimeout(() => {
                        stickyYearDisplay.textContent = currentYear;
                        stickyYearDisplay.style.opacity = '1'; // Make it fully visible
                    }, 150);
                }

                if(yearJumper.value !== currentYear) {
                    yearJumper.value = currentYear;
                }
            });

            // Set initial sticky year
            if (years.length > 0) {
                stickyYearDisplay.textContent = years[0];
                lastKnownYear = years[0];
            }
            
            resizeCanvas();
            new ResizeObserver(resizeCanvas).observe(timelineWrapper);
            
            const fadeElements = document.querySelectorAll('.fade-in-element');
            const scrollObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('is-visible');
                        scrollObserver.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.1 });

            fadeElements.forEach(el => scrollObserver.observe(el));
            
            const sections = document.querySelectorAll('main section[id]');
            const navLinks = document.querySelectorAll('header nav a');
            
            const observerOptions = {
                root: null,
                rootMargin: '0px 0px -50% 0px', 
                threshold: 0
            };

            const sectionObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.getAttribute('id');
                        navLinks.forEach(link => {
                            link.classList.remove('active');
                            if (link.getAttribute('href') === `#${id}`) {
                                link.classList.add('active');
                            }
                        });
                        mobileNavLinks.forEach(link => {
                            link.classList.remove('text-orange-500');
                            if (link.getAttribute('href') === `#${id}`) {
                                link.classList.add('text-orange-500');
                            }
                        });
                    }
                });
            }, observerOptions);

            sections.forEach(section => {
                if (section.id) {
                    sectionObserver.observe(section);
                }
            });

            document.getElementById('footer-copyright').textContent = `© ${new Date().getFullYear()} Controlled Freedom. All Rights Reserved.`;

            const scrollRightButton = document.getElementById('scroll-right-btn');
            if (scrollRightButton) {
                scrollRightButton.classList.add('nudge-animation');
            }
        }
    </script>
</body>
</html>
