<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controlled Freedom: An Interactive Jazz Encyclopedia</title>
    
    <!-- External Libraries & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Righteous&family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- Custom CSS Styling -->
    <style>
        /* Define custom color properties for easy theme management */
        :root {
            --bg-main: #111827; /* gray-900 */
            --bg-secondary: #1f2937; /* gray-800 */
            --bg-light: #374151; /* gray-700 */
            --text-main: #f3f4f6; /* gray-200 */
            --text-muted: #9ca3af; /* gray-400 */
            --accent: #fb923c; /* orange-400 */
            --accent-dark: #f97316; /* orange-500 */
            --yellow-accent: #facc15; /* yellow-400 */

            /* Genre Colors */
            --genre-bebop: #C19A6B;
            --genre-hard-bop: #d8b4fe;
            --genre-cool-jazz: #93c5fd;
            --genre-modal-jazz: #a7f3d0;
            --genre-post-bop: #fed7aa;
            --genre-free-jazz: #fca5a5;
            --genre-avant-garde: #fecdd3;
            --genre-jazz-fusion: #a5f3fc;
            --genre-default: #e7e5e4;
        }

        /* Base body styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
        }
        
        /* Heading font styling with new Righteous font */
        h1, h2, h3, h4, h5 {
            font-family: 'Righteous', sans-serif;
            letter-spacing: 0.02em;
        }

        /* Header styling */
        #main-header {
            transition: background-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }
        #main-header.scrolled {
            background-color: rgba(17, 24, 39, 0.8); /* gray-900 with opacity */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        /* Navigation link transition effects */
        .nav-link {
            position: relative;
            transition: color 0.2s;
            font-family: 'Righteous', sans-serif;
            letter-spacing: 0.05em;
            font-size: 1.1rem;
        }
        .nav-link::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--accent);
            transition: width 0.3s ease;
        }
        .nav-link:hover, .nav-link.active {
            color: var(--accent);
        }
        .nav-link:hover::after, .nav-link.active::after {
            width: 100%;
        }

        /* Section header styling */
        .section-header {
            color: var(--accent);
            border-bottom: 2px solid var(--accent);
            display: inline-block;
            padding-bottom: 0.25rem;
        }
        
        /* Album card styling */
        .timeline-album-card {
            width: 200px;
            flex-shrink: 0;
            background-color: var(--bg-secondary);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease, opacity 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 1px solid var(--bg-light);
            overflow: hidden;
            opacity: 1;
        }
        .timeline-album-card:hover {
            transform: translateY(-8px) scale(1.03);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.2), 0 8px 10px -6px rgb(0 0 0 / 0.2);
        }
        .timeline-album-card.dimmed {
            opacity: 0.3;
            filter: grayscale(80%);
        }
        .timeline-album-card.highlighted {
            opacity: 1;
            filter: grayscale(0%);
            box-shadow: 0 0 20px 0px var(--highlight-color, var(--accent));
        }
        .timeline-album-card.clicked {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 0 25px 5px var(--accent) !important;
            opacity: 1 !important;
            z-index: 10;
        }
        .timeline-album-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            transition: filter 0.3s ease;
        }
        
        /* Artist card styling */
        .artist-card {
            background-color: var(--bg-secondary);
            border-radius: 0.5rem;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid var(--bg-light);
        }
        .artist-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.2), 0 4px 6px -4px rgb(0 0 0 / 0.2);
        }
        .artist-card img {
            filter: grayscale(50%);
            transition: filter 0.3s ease;
        }
         .artist-card:hover img {
            filter: grayscale(0%);
        }
        
        /* Modal Styling */
        .modal {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            background-color: var(--bg-secondary);
            border: 1px solid var(--bg-light);
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        .modal.opacity-0 .modal-content {
              opacity: 0;
              transform: scale(0.95) translateY(10px);
        }
        #modal-analysis-section {
            background-color: var(--bg-main);
            border: 1px solid var(--bg-light);
            box-shadow: none;
        }
        #modal-analysis-section h5 {
            color: var(--text-main);
        }
        .liner-notes-text {
            color: var(--text-muted);
        }
        .modal-body-section {
            border-bottom: 1px solid var(--bg-light);
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
        .modal-body-section:last-child {
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 0;
        }

        /* Legacy Section: Influence Galaxy */
        #influence-web-container {
            position: relative;
            height: 750px;
            overflow: hidden;
            user-select: none;
        }
        #influence-web-canvas {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }
        .influence-node {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 10;
            transform: translate(-50%, -50%);
        }
        .influence-node:hover {
            transform: translate(-50%, -50%) scale(1.1) !important;
            z-index: 20;
        }
        .influence-node .node-image {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            border: 3px solid var(--bg-light);
            object-fit: cover;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            background-color: var(--bg-dark);
        }
        .influence-node.sub-genre .node-image {
            width: 70px;
            height: 70px;
            border-width: 2px;
        }
        .influence-node .node-label {
            margin-top: 8px;
            font-weight: bold;
            font-size: 1rem;
            color: var(--text-main);
            background-color: rgba(17, 24, 39, 0.6); /* bg-main with transparency */
            padding: 4px 8px;
            border-radius: 4px;
        }
        .influence-node.sub-genre .node-label {
            font-size: 0.8rem;
            margin-top: 6px;
        }
        .influence-node .node-info {
            display: none;
        }
        #influence-web-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }
        #influence-web-svg line, #influence-web-svg polygon {
            stroke: var(--bg-light);
            stroke-width: 2;
        }
        #influence-web-svg polygon {
            fill: none;
            stroke-dasharray: 8 8;
        }

        /* Other styles from previous version (abridged for brevity) */
        .timeline-year-section { display: flex; flex-shrink: 0; flex-direction: column; align-items: center; border-left: 4px dotted #44403c; padding: 0 2rem; }
        .timeline-year-section:first-child { border-left: none; }
        .timeline-album-list { display: grid; grid-template-rows: repeat(2, 1fr); grid-auto-flow: column; gap: 1.5rem; min-height: 520px; }
        .artist-slider-page { width: 100%; flex-shrink: 0; padding: 0 0.5rem; display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; }
        @media (min-width: 768px) { .artist-slider-page { grid-template-columns: repeat(6, 1fr); } }
        .styled-select select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23f97316' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.7rem center; background-size: 1.2em; }
        .loader-spinner { border: 4px solid var(--bg-secondary); border-top: 4px solid var(--accent); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .content-hidden { display: none; }
        .hidden { display: none !important; }
        .clickable-link { cursor: pointer; text-decoration: underline; text-decoration-color: var(--accent); transition: color 0.2s; }
        .clickable-link:hover { color: var(--accent); }
        .fade-in-element { opacity: 0; transform: translateY(20px); transition: opacity 0.5s ease-out, transform 0.5s ease-out; }
        .fade-in-element.is-visible { opacity: 1; transform: translateY(0); }
        #mobile-menu-panel { transition: transform 0.3s ease-in-out; }
        #mobile-menu-overlay.hidden #mobile-menu-panel { transform: translateX(100%); }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <!-- Full-screen loader -->
    <div id="loader" class="fixed inset-0 bg-gray-900 flex items-center justify-content-center z-50">
        <div class="loader-spinner"></div>
    </div>

    <div id="page-content" class="content-hidden">
        <!-- HEADER -->
        <header id="main-header" class="fixed top-0 w-full z-50">
            <nav class="container mx-auto flex items-center justify-between h-24 px-4 sm:px-6 lg:px-8">
                <a href="#" class="flex-shrink-0">
                    <img src="images/logo-light.svg" alt="Controlled Freedom Logo" class="h-16">
                </a>
                <div class="hidden sm:flex sm:items-center sm:space-x-8">
                    <a href="#overview" class="nav-link px-3 py-2 rounded-md font-medium text-gray-400">Overview</a>
                    <a href="#timeline" class="nav-link px-3 py-2 rounded-md font-medium text-gray-400">Timeline</a>
                    <a href="#matrix" class="nav-link px-3 py-2 rounded-md font-medium text-gray-400">Genres</a>
                    <a href="#artists" class="nav-link px-3 py-2 rounded-md font-medium text-gray-400">Artists</a>
                    <a href="#legacy" class="nav-link px-3 py-2 rounded-md font-medium text-gray-400">Legacy</a>
                </div>
                <div class="sm:hidden">
                    <button id="mobile-menu-button" class="p-2 -mr-2 rounded-md text-gray-300 hover:bg-gray-800 focus:outline-none">
                        <svg class="h-8 w-8" stroke="currentColor" fill="none" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                </div>
            </nav>
        </header>

        <main>
            <!-- Hero Section -->
            <section id="banner" class="relative w-full h-screen min-h-[600px] flex items-center justify-center text-center">
                <div class="absolute inset-0 bg-black opacity-50 z-10"></div>
                <img src="images/banner.jpg" alt="Post-bop musicians in a rehearsal space" class="w-full h-full object-cover absolute inset-0" loading="lazy" onerror="this.onerror=null;this.src='https://images.unsplash.com/photo-1511192336575-5a79af67d629?q=80&w=2074&auto=format&fit=crop';">
                <div class="relative z-20 px-4">
                    <h1 class="text-6xl md:text-8xl lg:text-9xl text-white font-black tracking-wider leading-tight" style="text-shadow: 2px 2px 8px rgba(0,0,0,0.7);">Controlled Freedom</h1>
                    <p class="mt-4 text-xl md:text-2xl text-orange-400 max-w-3xl mx-auto" style="text-shadow: 1px 1px 4px rgba(0,0,0,0.8);">An Interactive Encyclopedia of Jazz Evolution (1950-1969)</p>
                </div>
            </section>

            <!-- Overview Section -->
            <section id="overview" class="py-20 sm:py-28 bg-gray-900">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-6xl">
                    <div class="grid md:grid-cols-5 gap-12 items-center">
                        <div class="md:col-span-3 space-y-6 text-lg leading-relaxed text-gray-300 text-left">
                            <h2 class="section-header text-5xl">A Pivotal Era</h2>
                            <p>The period between 1950 and 1969 represents the most accelerated and dynamic evolution in jazz history. From the virtuosic fire of <strong>Bebop</strong>, the music branched into myriad new forms. Some musicians pursued the soulful, blues-drenched energy of <strong>Hard Bop</strong>, while others explored the harmonically rich, restrained arrangements of <strong>Cool Jazz</strong>.</p>
                            <p>At the heart of this era lies the central theme of <strong class="text-orange-400">"controlled freedom."</strong> The philosophy of <strong>Post-Bop</strong> sought a middle ground between dense structures and the radical abandon of the burgeoning <strong>Free Jazz</strong> and <strong>Avant-Garde</strong> scenes, introducing new harmonic and rhythmic complexity while still retaining elements of form and melody.</p>
                            <p>This application provides an interactive journey through this interconnected history, ordered by recording date—not release date—to understand the influence exercised between all these musicians and <strong>reveal the authentic path of jazz evolution as it happened.</strong></p>
                        </div>
                        <div class="md:col-span-2 mt-8 md:mt-0">
                            <div id="on-this-day" class="mb-8"></div>
                            <iframe style="border-radius:12px" src="https://open.spotify.com/embed/playlist/6nFqx9JIZD29Qxccp6mh4N?utm_source=generator&theme=0" width="100%" height="352" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Angled Section Divider -->
            <div class="bg-gray-800" style="height: 150px; overflow: hidden; position: relative;">
                <svg viewBox="0 0 500 150" preserveAspectRatio="none" style="height: 100%; width: 100%;"><path d="M0,150 L500,0 L500,150 L0,150 Z" style="stroke: none; fill: #111827;"></path></svg>
            </div>

            <!-- Interactive Timeline Section -->
            <section id="timeline" class="py-20 sm:py-28 bg-gray-800">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center">
                    <h2 class="section-header text-5xl">Timeline Explorer</h2>
                    <p class="text-center text-lg text-gray-400 mb-8 max-w-3xl mx-auto italic">Use the filters to explore a year-by-year breakdown of landmark albums.</p>
                    
                    <div id="timeline-controls" class="flex flex-col items-center justify-center gap-4 mb-8">
                        <div id="genre-filter-container" class="flex flex-wrap justify-center gap-x-4 gap-y-3"></div>
                    </div>

                    <div class="relative group">
                        <div id="sticky-header-display" class="absolute top-4 left-1 sm:left-4 flex items-end gap-x-3 pointer-events-none z-10">
                            <div id="sticky-year-display" class="font-black text-orange-400 text-5xl leading-none transition-opacity duration-150"></div>
                            <h3 id="sticky-era-title" class="font-black text-gray-500 text-3xl leading-tight pb-1 transition-opacity duration-300"></h3>
                        </div>

                        <div id="horizontal-timeline-container" class="min-h-[600px] flex items-center">
                            <canvas id="timeline-canvas"></canvas>
                            <div id="timeline-wrapper"></div>
                        </div>
                        <button id="scroll-left-btn" class="absolute left-0 sm:-left-4 top-1/2 -translate-y-1/2 z-20 p-2 rounded-full bg-gray-900 text-gray-200 hover:bg-orange-500 transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                        </button>
                        <button id="scroll-right-btn" class="absolute right-0 sm:-right-4 top-1/2 -translate-y-1/2 z-20 p-2 rounded-full bg-gray-900 text-gray-200 hover:bg-orange-500 transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                        </button>
                    </div>
                    <div class="mt-6">
                        <div id="custom-scrollbar" class="w-full h-3 bg-gray-700 rounded-full cursor-pointer relative">
                            <div id="custom-scrollbar-markers"></div>
                            <div id="custom-scrollbar-thumb" class="h-full bg-gray-300 rounded-full absolute top-0 cursor-grab"></div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Angled Section Divider -->
            <div class="bg-gray-900" style="height: 150px; overflow: hidden; position: relative;">
                 <svg viewBox="0 0 500 150" preserveAspectRatio="none" style="height: 100%; width: 100%;"><path d="M0,0 L500,150 L0,150 Z" style="stroke: none; fill: #1f2937;"></path></svg>
            </div>

            <!-- Genre Matrix Section -->
            <section id="matrix" class="py-20 sm:py-28 bg-gray-900">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center">
                    <h2 class="section-header text-5xl">The Genres</h2>
                    <p class="text-center text-lg text-gray-400 mb-12 max-w-3xl mx-auto italic">Compare the main aspects of each style.</p>
                    <div id="genre-matrix-container" class="matrix-container max-w-6xl mx-auto">
                        <table id="style-matrix-table" class="matrix-table"></table>
                    </div>
                </div>
            </section>

            <!-- Angled Section Divider -->
            <div class="bg-gray-800" style="height: 150px; overflow: hidden; position: relative;">
                 <svg viewBox="0 0 500 150" preserveAspectRatio="none" style="height: 100%; width: 100%;"><path d="M0,150 L500,0 L500,150 L0,150 Z" style="stroke: none; fill: #111827;"></path></svg>
            </div>

            <!-- Key Artists Grid Section -->
            <section id="artists" class="py-20 sm:py-28 bg-gray-800">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center">
                    <h2 class="section-header text-5xl">The Architects</h2>
                    <p class="text-center text-lg text-gray-400 mb-12 max-w-3xl mx-auto italic">Explore the musicians who defined an era.</p>
                    
                    <div class="flex justify-center mb-8">
                        <div class="w-full max-w-xs styled-select">
                            <label for="instrument-filter" class="block text-sm font-medium text-gray-400 mb-2 text-center">Filter by Instrument:</label>
                            <select id="instrument-filter" class="block w-full rounded-md border-2 border-gray-600 bg-gray-700 text-gray-200 py-2 pl-3 pr-10 focus:border-orange-500 focus:outline-none focus:ring-orange-500 font-bold"></select>
                        </div>
                    </div>

                    <div id="artist-slider-wrapper" class="relative">
                        <div id="artist-slider-container" class="min-h-[550px] md:min-h-[580px]">
                            <div id="artist-slider-track"></div>
                        </div>
                        <div id="artist-pagination-controls" class="absolute inset-x-0 -bottom-12 flex justify-center items-center gap-4">
                            <button id="artist-prev-btn" class="pointer-events-auto p-2 rounded-full bg-gray-900 text-gray-200 hover:bg-orange-500 transition-all disabled:opacity-25 disabled:cursor-not-allowed">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                            </button>
                            <span id="artist-page-indicator" class="font-bold text-lg text-gray-200 pointer-events-auto"></span>
                            <button id="artist-next-btn" class="pointer-events-auto p-2 rounded-full bg-gray-900 text-gray-200 hover:bg-orange-500 transition-all disabled:opacity-25 disabled:cursor-not-allowed">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                            </button>
                       </div>
                    </div>
                </div>
            </section>
            
            <!-- Angled Section Divider -->
            <div class="bg-gray-900" style="height: 150px; overflow: hidden; position: relative;">
                 <svg viewBox="0 0 500 150" preserveAspectRatio="none" style="height: 100%; width: 100%;"><path d="M0,0 L500,150 L0,150 Z" style="stroke: none; fill: #1f2937;"></path></svg>
            </div>

            <!-- UPDATED Legacy Section -->
            <section id="legacy" class="py-20 sm:py-28 bg-gray-900">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-6xl text-center">
                    <h2 class="section-header text-5xl">Legacy</h2>
                    <p class="text-center text-lg text-gray-400 mb-16 italic">How a golden age splintered into new forms, leaving an indelible mark on music.</p>

                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-x-12 gap-y-10 items-start text-left mb-20">
                        <div class="fade-in-element">
                            <h3 class="text-3xl font-bold mb-4" style="color: var(--genre-jazz-fusion);">The Electric Path</h3>
                            <p class="text-gray-400 leading-relaxed text-sm">Led by <strong class="clickable-link" data-artist-name="Miles Davis">Miles Davis</strong>, this path embraced electric instruments and the powerful rhythms of funk and rock, creating the high-energy sound of Jazz Fusion.</p>
                        </div>
                        <div class="fade-in-element">
                            <h3 class="text-3xl font-bold mb-4" style="color: var(--genre-free-jazz);">The Spiritual Path</h3>
                            <p class="text-gray-400 leading-relaxed text-sm">Following <strong class="clickable-link" data-artist-name="John Coltrane">John Coltrane</strong>, this movement explored music as a form of transcendence and spiritual expression.</p>
                        </div>
                        <div class="fade-in-element">
                            <h3 class="text-3xl font-bold mb-4" style="color: var(--genre-avant-garde);">The Avant-Garde Path</h3>
                            <p class="text-gray-400 leading-relaxed text-sm">Pioneered by <strong class="clickable-link" data-artist-name="Ornette Coleman">Ornette Coleman</strong>, this path deconstructed the rules of jazz, focusing on pure melodic invention.</p>
                        </div>
                        <div class="fade-in-element">
                            <h3 class="text-3xl font-bold mb-4" style="color: var(--genre-cool-jazz);">The Melodic Path</h3>
                             <p class="text-gray-400 leading-relaxed text-sm">Evolving from Cool Jazz, this path emphasized space, atmosphere, and pristine production, defining the ECM Style and influencing Ambient Jazz.</p>
                        </div>
                        <div class="fade-in-element">
                            <h3 class="text-3xl font-bold mb-4" style="color: var(--genre-hard-bop);">The Afro-Jazz Path</h3>
                            <p class="text-gray-400 leading-relaxed text-sm">Visionaries like <strong class="clickable-link" data-artist-name="Sun Ra">Sun Ra</strong> and the Art Ensemble of Chicago forged a path rooted in the African diaspora, blending free improv with ancient rhythms and a cosmic philosophy.</p>
                        </div>
                        <div class="fade-in-element">
                            <h3 class="text-3xl font-bold mb-4" style="color: var(--genre-bebop);">The Neo-Bop Path</h3>
                            <p class="text-gray-400 leading-relaxed text-sm">In the 1980s, the "Young Lions" movement, led by <strong class="clickable-link" data-artist-name="Wynton Marsalis">Wynton Marsalis</strong>, championed a return to the acoustic, straight-ahead, bop-oriented traditions of the 50s and 60s.</p>
                        </div>
                    </div>

                    <div class="text-left mb-16 fade-in-element">
                        <h3 class="text-3xl font-bold mb-2 text-center">A Living Tradition</h3>
                        <p class="text-center text-gray-400 mb-8 max-w-3xl mx-auto">The harmonic sophistication of Bebop, the soulful grammar of Hard Bop, and the expansive freedom of Modal and Post-Bop were codified into a shared musical playbook. This legacy remains the bedrock for contemporary jazz education and performance worldwide. Click a planet to explore its legacy.</p>
                        <div id="influence-web-container" class="relative bg-gray-800 border border-gray-700 rounded-lg p-4 shadow-inner">
                            <div id="influence-web-canvas">
                               <svg id="influence-web-svg"></svg>
                               <!-- Nodes will be injected here by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-900 text-gray-400 py-8 border-t border-gray-800">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <p class="font-bold text-gray-300">An interactive exploration based on the "Chronological Encyclopedia of Jazz".</p>
                <p class="text-sm mt-2">Designed to bring music history to life through interactive data visualization.</p>
                <div class="mt-6 border-t border-gray-700 pt-6">
                    <p id="footer-copyright" class="text-xs"></p>
                    <p class="text-xs text-gray-500 mt-2">Disclaimer: All music and images are the property of their respective copyright holders. This is a non-profit project for educational purposes only.</p>
                </div>
            </div>
        </footer>
    </div>
    
    <!-- Modals -->
    <div id="album-modal" class="modal fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div id="modal-content" class="modal-content rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col transform scale-95">
            <div class="flex justify-between items-start p-4 border-b border-gray-700 flex-shrink-0">
                <div>
                    <h3 id="modal-title" class="text-4xl text-orange-400"></h3>
                    <button id="modal-artist" class="text-xl text-gray-400 bg-transparent border-none p-0"></button>
                </div>
                <button id="close-modal" class="text-4xl font-bold p-2 leading-none text-gray-500 hover:text-orange-400">×</button>
            </div>
            <div id="modal-body" class="p-6 overflow-y-auto">
                <div id="modal-album-main-details" class="flex flex-col md:flex-row gap-6">
                    <div id="modal-album-art-container" class="w-full md:w-1/3 flex-shrink-0">
                        <img id="modal-album-art" src="" class="w-full h-auto rounded-md border border-gray-700" alt="" loading="lazy">
                    </div>
                    <div id="modal-album-details" class="w-full md:w-2/3"></div>
                </div>
                <div id="analysis-wrapper" class="relative mt-4"></div>
            </div>
            <div id="modal-nav-footer" class="flex justify-between items-center p-4 border-t border-gray-700 flex-shrink-0 bg-gray-800">
                <button id="prev-album-btn" class="px-4 py-2 bg-gray-700 text-gray-200 rounded-md font-bold hover:bg-orange-500 transition-colors disabled:bg-gray-600 disabled:cursor-not-allowed">Previous Album</button>
                <button id="next-album-btn" class="px-4 py-2 bg-gray-700 text-gray-200 rounded-md font-bold hover:bg-orange-500 transition-colors disabled:bg-gray-600 disabled:cursor-not-allowed">Next Album</button>
            </div>
        </div>
    </div>
    <div id="artist-modal" class="modal fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div class="modal-content rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col transform scale-95">
             <div class="flex justify-between items-start p-4 border-b border-gray-700 flex-shrink-0">
                 <h3 id="artist-modal-title" class="text-4xl text-orange-400"></h3>
                 <button id="close-artist-modal" class="text-4xl font-bold p-2 leading-none text-gray-500 hover:text-orange-400">×</button>
             </div>
             <div id="artist-modal-body" class="p-6 overflow-y-auto"></div>
        </div>
    </div>
    <div id="genre-modal" class="modal fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div class="modal-content rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col transform scale-95">
             <div class="flex justify-between items-start p-4 border-b border-gray-700 flex-shrink-0">
                 <h3 id="genre-modal-title" class="text-4xl"></h3>
                 <button id="close-genre-modal" class="text-4xl font-bold p-2 leading-none text-gray-500 hover:text-orange-400">×</button>
             </div>
             <div id="genre-modal-body" class="p-6 overflow-y-auto"></div>
        </div>
    </div>
    <!-- NEW: Path Info Modal -->
    <div id="path-modal" class="modal fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div class="modal-content rounded-lg shadow-2xl w-full max-w-md max-h-[90vh] flex flex-col transform scale-95">
             <div class="flex justify-between items-start p-4 border-b border-gray-700 flex-shrink-0">
                 <h3 id="path-modal-title" class="text-4xl"></h3>
                 <button id="close-path-modal" class="text-4xl font-bold p-2 leading-none text-gray-500 hover:text-orange-400">×</button>
             </div>
             <div id="path-modal-body" class="p-6 overflow-y-auto"></div>
        </div>
    </div>

    <!-- Mobile Menu Overlay -->
    <div id="mobile-menu-overlay" class="hidden fixed inset-0 z-50">
        <div id="mobile-menu-bg" class="fixed inset-0 bg-black opacity-50"></div>
        <div id="mobile-menu-panel" class="fixed top-0 right-0 bottom-0 bg-gray-900 w-64 shadow-lg p-4 transform translate-x-full">
            <div class="flex justify-end mb-4">
                <button id="mobile-menu-close-button" class="p-2 -mr-2 rounded-md text-gray-300 hover:bg-gray-800 focus:outline-none">
                     <svg class="h-8 w-8" stroke="currentColor" fill="none" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <nav id="mobile-nav-links" class="flex flex-col space-y-4">
                <a href="#overview" class="mobile-nav-link text-lg font-bold text-gray-300 hover:text-orange-400">Overview</a>
                <a href="#timeline" class="mobile-nav-link text-lg font-bold text-gray-300 hover:text-orange-400">Timeline</a>
                <a href="#matrix" class="mobile-nav-link text-lg font-bold text-gray-300 hover:text-orange-400">Genres</a>
                <a href="#artists" class="mobile-nav-link text-lg font-bold text-gray-300 hover:text-orange-400">Artists</a>
                <a href="#legacy" class="mobile-nav-link text-lg font-bold text-gray-300 hover:text-orange-400">Legacy</a>
            </nav>
        </div>
    </div>


    <!-- Embedded Genre Matrix Data -->
    <script id="styleMatrixData" type="application/json">
    {
        "features": ["Harmony", "Rhythm", "Form"],
        "genres": {
            "Bebop": {
                "profile": "The furious, intellectual, and virtuosic revolution of the 1940s that became the foundation for all modern jazz. Bebop emphasized complex melodies over sophisticated chord progressions at blistering tempos, shifting jazz from dance music to a high art form for dedicated listeners.",
                "color": "var(--genre-bebop)",
                "data": [
                    "Fast-moving, complex chord progressions (e.g., ii-V-I with substitutions), use of altered chords and extensions.",
                    "Blistering tempos, virtuosic and rhythmically complex solos, 'dropping bombs' with the bass drum.",
                    "Often based on standard song forms (like blues and 'I Got Rhythm' changes) but used as vehicles for extended improvisation."
                ],
                "artists": "Charlie Parker, Dizzy Gillespie, Thelonious Monk, Bud Powell",
                "landmarkAlbums": ["Bird and Diz", "Sonny Side Up", "The Amazing Bud Powell, Vol. 1", "Lester Young with the Oscar Peterson Trio", "Jazz At Massey Hall", "For Musicians Only"]
            },
            "Hard Bop": {
                "profile": "Evolving from bebop in the mid-1950s, Hard Bop re-injected the music with the earthy, soulful, and danceable influences of blues and gospel. With its strong backbeat, memorable melodies, and fiery solos, it became one of the most popular and enduring styles of the era.",
                "color": "var(--genre-hard-bop)",
                "data": [
                    "Functional (ii-V-I), blues-based, gospel influences",
                    "Strong, driving swing feel, prominent drumming, danceable grooves",
                    "Standard forms (AABA, 12-bar blues), often with catchy, memorable heads"
                ],
                "artists": "Art Blakey, Horace Silver, Clifford Brown, Lee Morgan",
                "landmarkAlbums": ["Moanin'", "Study in Brown", "Saxophone Colossus", "Monk's Music", "Blue Train", "Giant Steps", "Brilliant Corners", "Song For My Father", "Money Jungle", "Mosaic", "The Sidewinder", "The Blues and the Abstract Truth", "Clifford Brown and Max Roach", "Cool Struttin'", "Soul Station", "The Cooker", "Go", "The Scene Changes"]
            },
            "Cool Jazz": {
                "profile": "A reaction to the frenetic energy of bebop, Cool Jazz emerged in the late 1940s and 50s with a more relaxed, subdued, and lyrical approach. It often featured more complex, written arrangements, softer tones, and influences from classical music, creating a sound of understated elegance.",
                "color": "var(--genre-cool-jazz)",
                "data": [
                    "More complex, often drawing from classical harmony, less blues-centric",
                    "Relaxed, subtle pulse, lighter drumming, focus on understatement",
                    "Often employed complex, contrapuntal arrangements and non-standard forms"
                ],
                 "artists": "Miles Davis (early), Dave Brubeck, Stan Getz, Gerry Mulligan",
                 "landmarkAlbums": ["Birth of the Cool", "Dexter Blows Hot and Cool", "Portrait in Jazz", "Time Out", "Somethin' Else", "Out of the Cool", "'Round About Midnight", "Everybody Digs Bill Evans"]
            },
            "Modal Jazz": {
                "profile": "A revolutionary approach pioneered in the late 1950s, Modal Jazz liberated improvisers by focusing on static scales (or modes) for long stretches, rather than rapidly changing chord progressions. This created a more spacious, meditative, and harmonically open soundscape, famously explored on Miles Davis's 'Kind of Blue'.",
                "color": "var(--genre-modal-jazz)",
                "data": [
                    "Static harmony, based on modes/scales rather than chord progressions",
                    "Floating, ambiguous pulse, less aggressive swing, focus on texture",
                    "Open-ended, simple structures, often just a single mode or vamp"
                ],
                "artists": "Miles Davis, John Coltrane, Bill Evans",
                "landmarkAlbums": ["Kind of Blue", "My Favorite Things", "Maiden Voyage", "Waltz for Debby", "Idle Moments", "Africa / Brass", "Olé Coltrane", "Juju", "Miles Smiles", "Milestones"]
            },
            "Post-Bop": {
                "profile": "The adventurous middle ground of the 1960s, Post-Bop took the harmonic complexity of bebop and the freedom of modal jazz and fused them with elements of the avant-garde. It's defined by its intricate original compositions, highly interactive rhythm sections, and 'controlled freedom,' where musicians stretch the boundaries of harmony and form without abandoning them completely.",
                "color": "var(--genre-post-bop)",
                "data": [
                    "Expanded functional harmony, non-functional chords, controlled dissonance",
                    "Highly interactive, fluid time, polyrhythms, elastic sense of swing",
                    "Modified standard forms, original compositions with complex, unique structures"
                ],
                "artists": "Miles Davis's 2nd Quintet, Wayne Shorter, Herbie Hancock, Andrew Hill",
                "landmarkAlbums": ["Mingus Ah Um", "Astigmatic", "Destination... Out!", "Free For All", "Speak No Evil", "Empyrean Isles", "Contours", "Dialogue", "Inner Urge"]
            },
            "Avant-Garde": {
                 "profile": "The 'Avant-Garde' describes a forward-thinking movement where musicians sought to challenge and expand the conventions of jazz. This often involved complex, unconventional compositions, unusual instrumentation, and a blend of structured sections with free improvisation, pushing the music into uncharted intellectual and textural territory.",
                "color": "var(--genre-avant-garde)",
                "data": [
                    "Can include complex, atonal composed sections alongside free improvisation.",
                    "Ranges from free, pulseless textures to complex, composed rhythmic cycles.",
                    "Often features through-composed suites, blending written material with free improvisation."
                ],
                "artists": "Eric Dolphy, Andrew Hill, Grachan Moncur III, Sun Ra",
                "landmarkAlbums": ["The Black Saint and the Sinner Lady", "Out to Lunch!", "The Shape of Jazz to Come", "Point of Departure", "A Love Supreme", "Karma", "We Insist! Max Roach's Freedom Now Suite", "Change of the Century"]
            },
            "Free Jazz": {
                "profile": "The most radical departure of the era, Free Jazz, pioneered by artists like Ornette Coleman, often abandoned preset chord changes, tempos, and forms altogether. The focus shifted to collective, spontaneous improvisation, prioritizing raw energy, texture, and pure sonic expression over traditional musical rules.",
                "color": "var(--genre-free-jazz)",
                "data": [
                    "Abandons conventional chord progressions; focuses on texture and collective improvisation.",
                    "Often abandons a steady pulse; uses 'energy playing' and textural drumming.",
                    "Open forms, often based on a brief theme or motive, or completely improvised."
                ],
                "artists": "Ornette Coleman, Albert Ayler, Cecil Taylor, Pharoah Sanders",
                "landmarkAlbums": ["Ascension", "Free Jazz", "Spiritual Unity", "Conquistador!", "Eternal Rhythm", "Compulsion!!!!!", "Black Woman", "The Magic of Ju-Ju"]
            },
            "Jazz Fusion": {
                "profile": "Emerging in the late 1960s, Jazz Fusion plugged jazz into the amplifier, incorporating the powerful rhythms of rock and funk, and the new textures of electric instruments like the Fender Rhodes piano and electric guitar. Led by Miles Davis, this movement created a dynamic, high-energy sound that would define the next decade of jazz.",
                "color": "var(--genre-jazz-fusion)",
                "data": [
                    "Electric piano (Rhodes, Wurlitzer), synthesizers; post-bop harmony mixed with simpler rock/funk vamps.",
                    "Driving, straight-eighth rock and funk grooves, complex polyrhythms, high-energy drumming.",
                    "Extended, often through-composed forms, long open improvisations over vamps."
                ],
                "artists": "Miles Davis, Herbie Hancock, Weather Report, Mahavishnu Orchestra",
                 "landmarkAlbums": ["In a Silent Way", "Bitches Brew"]
            }
        }
    }
    </script>
    
    <!-- Main Application Script -->
    <script>
        const JazzApp = {
            // Application State
            state: {
                albums: [],
                artistProfiles: {},
                artistsData: [],
                styleMatrix: {},
                visibleAlbums: [],
                eras: [
                    { title: "Cool & Bebop Foundations", startYear: 1950, endYear: 1953, color: 'var(--era-cool-light)' },
                    { title: "Hard Bop Explosion", startYear: 1954, endYear: 1956, color: 'var(--era-hard-bop-light)' },
                    { title: "Hard Bop At Its Peak", startYear: 1957, endYear: 1958, color: 'var(--era-bebop-light)' },
                    { title: "Modal and Structural Expansion", startYear: 1959, endYear: 1961, color: 'var(--era-modal-light)' },
                    { title: "Post-Bop Evolution", startYear: 1962, endYear: 1963, color: 'var(--era-post-bop-light)' },
                    { title: "Spiritual Awakening", startYear: 1964, endYear: 1966, color: 'var(--era-free-jazz-light)' },
                    { title: "Search for the Roots", startYear: 1967, endYear: 1968, color: 'var(--era-roots-light)' },
                    { title: "Fusion Breakthrough", startYear: 1969, endYear: 1969, color: 'var(--era-fusion-light)' }
                ],
                currentVisibleAlbumIndex: -1,
                currentArtistPage: 0,
                totalArtistPages: 0,
                lastKnownYear: '',
                lastKnownEraTitle: '',
                mobileCardSelectedForModal: null,
                lastHoveredGenre: null,
                influenceWebState: {
                    scale: 1,
                    panX: 0,
                    panY: 0,
                    isPanning: false,
                    startPos: { x: 0, y: 0 }
                },
                pathData: {
                    electric: {
                        title: "The Electric Path",
                        affinity: "Jazz Fusion, Jazz-Funk, Jazz-Rock",
                        albums: [
                            { title: "The Inner Mounting Flame", artist: "The Mahavishnu Orchestra", year: 1971 },
                            { title: "Head Hunters", artist: "Herbie Hancock", year: 1973 },
                            { title: "Get Up With It", artist: "Miles Davis", year: 1974 },
                            { title: "Lanquidity", artist: "Sun Ra", year: 1978 },
                            { title: "Naked City", artist: "John Zorn", year: 1990 },
                            { title: "Fearless Movement", artist: "Kamasi Washington", year: 2024 },
                        ]
                    },
                    spiritual: {
                        title: "The Spiritual Path",
                        affinity: "Spiritual Jazz, Free Jazz",
                        albums: [
                           { title: "Journey in Satchidananda", artist: "Alice Coltrane", year: 1971 },
                           { title: "Black Unity", artist: "Pharoah Sanders", year: 1972 },
                           { title: "Enlightenment", artist: "McCoy Tyner", year: 1974 },
                           { title: "Black Saint", artist: "Billy Harper", year: 1975 },
                           { title: "Don Cherry", artist: "Don Cherry", year: 1977 },
                           { title: "Godspelized", artist: "David S. Ware Quartet", year: 1997 },
                        ]
                    },
                    avantGarde: {
                        title: "The Avant-Garde Path",
                        affinity: "Avant-Garde Jazz, Modern Creative, Third Stream",
                        albums: [
                            { title: "Science Fiction", artist: "Ornette Coleman", year: 1972 },
                            { title: "Variations in Dream-Time", artist: "Anthony Davis", year: 1983 },
                            { title: "Willisau (Quartet)", artist: "Anthony Braxton", year: 1991 },
                            { title: "Ask the Ages", artist: "Sonny Sharrock", year: 1991 },
                            { title: "Hanging Gardens", artist: "The Necks", year: 1999 },
                            { title: "Coin Coin Chapter One", artist: "Matana Roberts", year: 2011 },
                        ]
                    },
                    melodic: {
                        title: "The Melodic Path",
                        affinity: "ECM Style Jazz, Smooth Jazz, Ambient Jazz",
                        albums: [
                            { title: "Return to Forever", artist: "Chick Corea", year: 1972 },
                            { title: "Open, to Love", artist: "Paul Bley", year: 1973 },
                            { title: "The Jewel in the Lotus", artist: "Bennie Maupin", year: 1974 },
                            { title: "Belonging", artist: "Jan Garbarek & Keith Jarrett", year: 1974 },
                            { title: "The Köln Concert", artist: "Keith Jarrett", year: 1975 },
                            { title: "Pat Metheny Group", artist: "Pat Metheny Group", year: 1978 },
                        ]
                    },
                    afroJazz: {
                        title: "The Afro-Jazz Path",
                        affinity: "Afro-Jazz, Cape Jazz",
                        albums: [
                           { title: "Blackstone Legacy", artist: "Woody Shaw", year: 1971 },
                           { title: "King of Kings", artist: "The Pyramids", year: 1974 },
                           { title: "Song for Biko", artist: "Johnny Dyani Quartet", year: 1979 },
                           { title: "Bap-Tizum", artist: "The Art Ensemble of Chicago", year: 1972 },
                           { title: "Your Queen is a Reptile", artist: "Sons of Kemet", year: 2018 },
                           { title: "We Are Sent Here by History", artist: "Shabaka and the Ancestors", year: 2020 },
                        ]
                    },
                    neoBop: {
                        title: "The Neo-Bop Path",
                        affinity: "Hard Bop, Post-Bop, Soul Jazz",
                        albums: [
                           { title: "Scenery", artist: "Ryo Fukui", year: 1976 },
                           { title: "Eastern Rebellion", artist: "Cedar Walton", year: 1976 },
                           { title: "Black Codes (From the Underground)", artist: "Wynton Marsalis", year: 1985 },
                           { title: "Sail Away", artist: "Tom Harrell", year: 1989 },
                           { title: "Moonswing", artist: "Joshua Redman", year: 1994 },
                           { title: "Songbook", artist: "Kenny Garrett", year: 1997 },
                        ]
                    }
                }
            },

            // DOM Elements
            elements: {},

            // Initialization
            init() {
                this.cacheDOMElements();
                // Bind all methods to the JazzApp context once
                for (const key in this.methods) {
                    if (typeof this.methods[key] === 'function') {
                        this.methods[key] = this.methods[key].bind(this);
                    }
                }
                this.fetchData();
            },
            
            cacheDOMElements() {
                this.elements = {
                    loader: document.getElementById('loader'),
                    pageContent: document.getElementById('page-content'),
                    timelineContainer: document.getElementById('horizontal-timeline-container'),
                    timelineWrapper: document.getElementById('timeline-wrapper'),
                    timelineCanvas: document.getElementById('timeline-canvas'),
                    scrollLeftBtn: document.getElementById('scroll-left-btn'),
                    scrollRightBtn: document.getElementById('scroll-right-btn'),
                    genreFilterContainer: document.getElementById('genre-filter-container'),
                    stickyYearDisplay: document.getElementById('sticky-year-display'),
                    stickyEraTitle: document.getElementById('sticky-era-title'),
                    albumModal: document.getElementById('album-modal'),
                    artistModal: document.getElementById('artist-modal'),
                    genreModal: document.getElementById('genre-modal'),
                    pathModal: document.getElementById('path-modal'),
                    instrumentFilter: document.getElementById('instrument-filter'),
                    artistSliderTrack: document.getElementById('artist-slider-track'),
                    artistPrevBtn: document.getElementById('artist-prev-btn'),
                    artistNextBtn: document.getElementById('artist-next-btn'),
                    artistPaginationControls: document.getElementById('artist-pagination-controls'),
                    artistPageIndicator: document.getElementById('artist-page-indicator'),
                    matrixContainer: document.getElementById('style-matrix-table'),
                    customScrollbar: document.getElementById('custom-scrollbar'),
                    customScrollbarThumb: document.getElementById('custom-scrollbar-thumb'),
                    customScrollbarMarkers: document.getElementById('custom-scrollbar-markers'),
                    mobileMenuButton: document.getElementById('mobile-menu-button'),
                    mobileMenuOverlay: document.getElementById('mobile-menu-overlay'),
                    mobileMenuPanel: document.getElementById('mobile-menu-panel'),
                    mobileMenuCloseButton: document.getElementById('mobile-menu-close-button'),
                    mobileNavLinks: document.querySelectorAll('#mobile-nav-links a'),
                    sections: document.querySelectorAll('main section[id]'),
                    navLinks: document.querySelectorAll('header nav a'),
                    footerCopyright: document.getElementById('footer-copyright'),
                    onThisDayContainer: document.getElementById('on-this-day'),
                    influenceWebContainer: document.getElementById('influence-web-container'),
                    influenceWebCanvas: document.getElementById('influence-web-canvas'),
                };
            },

            fetchData() {
                const styleMatrixDataEl = document.getElementById('styleMatrixData');
                if(styleMatrixDataEl) {
                  this.state.styleMatrix = JSON.parse(styleMatrixDataEl.textContent);
                }

                Promise.all([
                    fetch('database.json').then(res => res.json()),
                    fetch('artists.json').then(res => res.json())
                ])
                .then(([dbData, artistProfileData]) => {
                    this.state.albums = dbData.albums;
                    this.state.artistProfiles = artistProfileData;
                    this.initializeAppUI();
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    this.elements.pageContent.innerHTML = `<div class="text-center p-8">
                        <h2 class="text-2xl font-bold text-red-600">Failed to Load Data</h2>
                        <p class="text-stone-600 mt-2">Could not fetch database files. Please ensure 'database.json' and 'artists.json' are available.</p>
                        <p class="text-sm text-stone-500 mt-4">Error: ${error.message}</p>
                    </div>`;
                    this.showPage();
                });
            },
            
            showPage() {
                this.elements.loader.style.display = 'none';
                this.elements.pageContent.classList.remove('content-hidden');
            },

            initializeAppUI() {
                this.methods.processAndSortData();
                this.methods.buildGenreColorMap();
                this.methods.setupFilters();
                this.methods.renderTimeline();
                this.methods.setupTimelineInteraction();
                this.methods.setupModals();
                this.methods.setupArtistSlider();
                this.methods.buildGenreMatrix();
                this.methods.renderInfluenceWeb(); 
                this.methods.setupMobileMenu();
                this.methods.setupScrollObservers();
                this.methods.setupGeneralEventListeners();
                this.methods.renderScrollbarMarkers();
                this.methods.setupOnThisDayFeature();
                this.showPage();
                setTimeout(() => { this.elements.timelineContainer.scrollLeft = 0; }, 0);
            },

            // Methods Object
            methods: {
                // --- DATA PROCESSING ---
                getCanonicalName(name) {
                    if (!name) return '';
                    const trimmedName = name.trim();
                    if (trimmedName === 'Roland Kirk') return 'Rahsaan Roland Kirk';
                    if (trimmedName === 'Anthony Williams') return 'Tony Williams';
                    return trimmedName;
                },

                processAndSortData() {
                    const monthMap = { "January": 0, "February": 1, "March": 2, "April": 3, "May": 4, "June": 5, "July": 6, "August": 7, "September": 8, "October": 9, "November": 10, "December": 11 };
                    
                    const parseDate = (dateString) => {
                        if (typeof dateString !== 'string') return null;
                        if (dateString.toLowerCase().startsWith('c.')) {
                            const yearMatch = dateString.match(/\d{4}/);
                            if (yearMatch) return new Date(parseInt(yearMatch[0]), 11, 31);
                        }
                        const parts = dateString.replace(/,/g, '').split(' ');
                        if (parts.length === 3 && monthMap.hasOwnProperty(parts[0])) return new Date(parts[2], monthMap[parts[0]], parts[1]);
                        if (parts.length === 2 && monthMap.hasOwnProperty(parts[0])) return new Date(parts[1], monthMap[parts[0]], 1);
                        if (parts.length === 1 && !isNaN(parts[0])) return new Date(parts[0], 0, 1);
                        return null;
                    };

                    this.state.albums.forEach(album => {
                        if (album.pivotalTracks && album.pivotalTracks.length > 0) {
                            album.pivotalTracks.sort((a,b) => parseDate(a.recordingDate) - parseDate(b.recordingDate));
                            album.firstRecordingDate = album.pivotalTracks[0].recordingDate;
                        }
                    });
                    this.state.albums.sort((a,b) => parseDate(a.firstRecordingDate) - parseDate(b.firstRecordingDate));
                    
                    const allTracks = this.state.albums.flatMap(album =>
                        album.pivotalTracks.map(track => ({ ...track, year: album.year, artist: album.artist, album: album.albumTitle, cover: album.cover, genre: album.genres }))
                    );
                    this.state.artistsData = this.methods.processArtists(allTracks, this.state.artistProfiles);
                },

                processArtists(tracks, profiles) {
                    const artistsMap = new Map();
                    const slugify = this.methods.slugify;
                    const getCanonicalName = this.methods.getCanonicalName;

                    tracks.forEach(track => {
                        if (!track.lineup) return;
                        
                        const trackArtist = getCanonicalName(track.artist);

                        const lineupParts = track.lineup.split(/,(?![^()]*\))/);
                        lineupParts.forEach(part => {
                            const match = part.trim().match(/(.+?)\s\((.+)\)/);
                            if (match) {
                                let name = getCanonicalName(match[1].trim());
                                const instrumentsString = match[2];

                                if (!artistsMap.has(name)) {
                                    artistsMap.set(name, { 
                                        name: name, 
                                        instruments: new Set(), 
                                        albums: new Set(), 
                                        photo: `images/${slugify(name)}.jpg`, 
                                        isBandleader: false, 
                                        profile: profiles[name] || { name: name, profile: 'No profile available.'} 
                                    });
                                }
                                const artistEntry = artistsMap.get(name);
                                
                                if (trackArtist.includes(name)) {
                                    artistEntry.isBandleader = true;
                                }
                                
                                instrumentsString.split(/, | \/ /).forEach(inst => {
                                    const trimmedInst = inst.trim();
                                    if (trimmedInst && !/vocals|arranger|reeds/i.test(trimmedInst)) {
                                        artistEntry.instruments.add(trimmedInst);
                                    }
                                });
                                artistEntry.albums.add(track.album);
                            }
                        });
                    });
                    
                    const artistsArray = Array.from(artistsMap.values());
                    artistsArray.forEach(artist => {
                        artist.instruments = Array.from(artist.instruments);
                        artist.albums = Array.from(artist.albums);
                        // Assign tier
                        if (artist.isBandleader) {
                            artist.tier = 1;
                        } else if (artist.albums.length >= 4) {
                            artist.tier = 2;
                        } else {
                            artist.tier = 3;
                        }
                    });
                    return artistsArray;
                },

                buildGenreColorMap() {
                    const baseGenreColors = this.state.styleMatrix.genres ? Object.keys(this.state.styleMatrix.genres).reduce((acc, genre) => {
                        acc[genre] = this.state.styleMatrix.genres[genre].color;
                        return acc;
                    }, {}) : {};
                    this.state.fullGenreColorMap = { ...baseGenreColors };
                    this.state.fullGenreColorMap['Free Jazz'] = 'var(--genre-free-jazz)';
                    this.state.fullGenreColorMap['Avant-Garde Jazz'] = 'var(--genre-avant-garde)'; 
                    this.state.fullGenreColorMap['Jazz Fusion'] = 'var(--genre-jazz-fusion)';
                    this.state.albums.forEach(album => {
                        if(album.genres) {
                            album.genres.split(', ').forEach(genre => {
                                if (!this.state.fullGenreColorMap[genre]) this.state.fullGenreColorMap[genre] = 'var(--genre-default)';
                            });
                        }
                    });
                },

                // --- UI SETUP & RENDERING ---
                setupFilters() {
                    const { genreFilterContainer, instrumentFilter } = this.elements;
                    const allGenresInDB = new Set();
                    this.state.albums.forEach(album => {
                        if (album.genres) album.genres.split(', ').forEach(genre => allGenresInDB.add(genre.trim()));
                    });
                    const excludedGenres = ['Bossa Nova', 'Chamber Jazz', 'Latin Jazz', 'Soul Jazz', 'Spiritual Jazz', 'Afro-Jazz', 'Ambient Jazz', 'Jazz-Funk', 'Third Stream', 'World Jazz', 'Soundtrack', 'Jazz-Rock', 'Progressive Rock'];
                    const filterableGenres = Array.from(allGenresInDB).filter(genre => !excludedGenres.includes(genre)).sort();
                    
                    genreFilterContainer.innerHTML = ''; // Clear previous
                    
                    const allCheckboxLabel = document.createElement('label');
                    allCheckboxLabel.className = 'genre-checkbox-label';
                    allCheckboxLabel.style.setProperty('--genre-color', 'var(--text-muted)');
                    const allCheckbox = document.createElement('input');
                    allCheckbox.type = 'checkbox';
                    allCheckbox.id = 'all-genres-checkbox';
                    allCheckbox.checked = true;
                    allCheckboxLabel.appendChild(allCheckbox);
                    allCheckboxLabel.append('All Genres');
                    genreFilterContainer.appendChild(allCheckboxLabel);
                    
                    filterableGenres.forEach(genre => {
                        const label = document.createElement('label');
                        label.className = 'genre-checkbox-label';
                        label.style.setProperty('--genre-color', this.state.fullGenreColorMap[genre] || 'var(--genre-default)');
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.value = genre;
                        checkbox.dataset.genre = genre;
                        checkbox.checked = true;
                        label.appendChild(checkbox);
                        label.append(genre);
                        genreFilterContainer.appendChild(label);
                    });
                    
                    const allGenreCheckboxes = genreFilterContainer.querySelectorAll('input[data-genre]');
                    
                    allCheckbox.addEventListener('change', () => {
                        allGenreCheckboxes.forEach(cb => { cb.checked = allCheckbox.checked; });
                        this.methods.filterTimeline();
                    });

                    genreFilterContainer.addEventListener('change', (e) => {
                        if (e.target.matches('input[type="checkbox"]')) {
                            if(e.target.id !== 'all-genres-checkbox') {
                                allCheckbox.checked = Array.from(allGenreCheckboxes).every(cb => cb.checked);
                            }
                            this.methods.filterTimeline();
                        }
                    });
                    
                    this.methods.populateInstrumentFilter(this.state.artistsData);
                },

                renderTimeline() {
                    const { timelineWrapper } = this.elements;
                    const eras = this.state.eras;

                    timelineWrapper.innerHTML = '';
                    const spacer = document.createElement('div');
                    spacer.style.width = '1px'; 
                    spacer.style.flexShrink = '0';
                    timelineWrapper.appendChild(spacer);

                    eras.forEach(era => {
                        const eraAlbums = this.state.albums.filter(album => album.year >= era.startYear && album.year <= era.endYear);
                        if (eraAlbums.length === 0) return;

                        const eraSection = document.createElement('div');
                        eraSection.className = 'era-section';
                        eraSection.style.backgroundColor = era.color;

                        const eraTitle = document.createElement('h3');
                        eraTitle.className = 'era-title';
                        eraTitle.textContent = era.title;
                        eraSection.appendChild(eraTitle);

                        const eraContent = document.createElement('div');
                        eraContent.className = 'era-content';

                        const yearsInEra = [...new Set(eraAlbums.map(album => album.year))].sort();
                        const groupedByYear = yearsInEra.reduce((acc, year) => {
                            acc[year] = eraAlbums.filter(d => d.year === year);
                            return acc;
                        }, {});

                        yearsInEra.forEach(year => {
                            const yearSection = document.createElement('div');
                            yearSection.className = 'timeline-year-section';
                            yearSection.id = `year-${year}`;
                            const yearHeader = document.createElement('div');
                            yearHeader.className = 'timeline-year-header';
                            yearHeader.textContent = year;
                            yearSection.appendChild(yearHeader);
                            const albumList = document.createElement('div');
                            albumList.className = 'timeline-album-list';
                            albumList.id = `album-list-${year}`;
                            groupedByYear[year].forEach(album => {
                                const card = document.createElement('div');
                                card.className = 'timeline-album-card fade-in-element';
                                card.dataset.albumTitle = album.albumTitle;
                                card.dataset.artist = album.artist;
                                card.dataset.genres = album.genres;

                                const albumGenres = album.genres.split(', ');
                                let isLandmark = false;
                                let landmarkColor = null;

                                for (const genreName of albumGenres) {
                                    const normalizedGenre = this.methods.normalizeGenreName(genreName);
                                    const genreData = this.state.styleMatrix.genres[normalizedGenre];
                                    if (genreData && genreData.landmarkAlbums && genreData.landmarkAlbums.some(title => title.toLowerCase() === album.albumTitle.toLowerCase())) {
                                        isLandmark = true;
                                        landmarkColor = genreData.color;
                                        break; 
                                    }
                                }

                                if (isLandmark) {
                                    card.classList.add('landmark-album');
                                    card.style.setProperty('--landmark-color', landmarkColor);
                                }

                                card.innerHTML = `<img src="${album.cover || ''}" alt="Cover for ${album.albumTitle}" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/200x200/1c1917/f5f5f4?text=No+Image';"><div class="timeline-album-card-info"><h5 class="font-bold truncate">${album.albumTitle}</h5><p class="truncate">${album.artist}</p></div>`;
                                albumList.appendChild(card);
                            });
                            yearSection.appendChild(albumList);
                            eraContent.appendChild(yearSection);
                        });
                        eraSection.appendChild(eraContent);
                        timelineWrapper.appendChild(eraSection);
                    });

                    this.methods.filterTimeline();
                },
                
                buildGenreMatrix() {
                    const { matrixContainer } = this.elements;
                    const { styleMatrix } = this.state;
                    if (styleMatrix.features && styleMatrix.genres) {
                        const thead = document.createElement('thead');
                        const headerRow = document.createElement('tr');
                        headerRow.innerHTML = `<th class="p-4 font-bold text-2xl w-48 text-left">Genre</th>`;
                        styleMatrix.features.forEach(feature => {
                            headerRow.innerHTML += `<th class="p-4 font-bold text-2xl text-center">${feature}</th>`;
                        });
                        thead.appendChild(headerRow);
                        matrixContainer.innerHTML = ''; // Clear previous content
                        matrixContainer.appendChild(thead);

                        const tbody = document.createElement('tbody');
                        Object.keys(styleMatrix.genres).forEach(genreName => {
                            const genreData = styleMatrix.genres[genreName];
                            const row = document.createElement('tr');
                            row.innerHTML = `<th style="background-color:${genreData.color};">
                                <button class="genre-header-button" data-genre-name="${genreName}">
                                    <span>${genreName}</span>
                                    <svg class="info-icon w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                                </button>
                            </th>` + genreData.data.map(dp => `<td>${dp}</td>`).join('');
                            tbody.appendChild(row);
                        });
                        matrixContainer.appendChild(tbody);
                    } else {
                        matrixContainer.parentElement.innerHTML = '<p class="text-center p-4 text-stone-500">No genre data available.</p>';
                    }
                },
                
                // --- EVENT LISTENERS & INTERACTIONS ---
                setupTimelineInteraction() {
                    const { timelineContainer, timelineWrapper, scrollLeftBtn, scrollRightBtn, stickyYearDisplay, stickyEraTitle } = this.elements;
                    const scrollAmount = 400;
                    scrollLeftBtn.addEventListener('click', () => timelineContainer.scrollBy({ left: -scrollAmount, behavior: 'smooth' }));
                    scrollRightBtn.addEventListener('click', () => timelineContainer.scrollBy({ left: scrollAmount, behavior: 'smooth' }));

                    timelineWrapper.addEventListener('mouseover', (e) => {
                        if (window.innerWidth < 768) return; // Desktop only
                        const card = e.target.closest('.timeline-album-card');

                        if (card && !card.classList.contains('hidden') && !document.querySelector('.timeline-album-card.clicked')) {
                            const primaryGenre = card.dataset.genres.split(', ')[0];
                            if (primaryGenre === this.state.lastHoveredGenre) {
                                return; // Same genre, do nothing
                            }
                            this.state.lastHoveredGenre = primaryGenre;
                            this.methods.applyHighlights(card);
                        }
                    });

                    timelineWrapper.addEventListener('click', e => {
                        const card = e.target.closest('.timeline-album-card');
                        const isMobile = window.innerWidth < 768;
                        if (!card) {
                            if (isMobile && this.state.mobileCardSelectedForModal) {
                                this.methods.applyHighlights(null);
                                this.state.mobileCardSelectedForModal = null;
                            }
                            return;
                        }
                        if (!card.classList.contains('hidden')) {
                            const { albumTitle, artist } = card.dataset;
                            const albumIndexInVisible = this.state.visibleAlbums.findIndex(a => a.albumTitle === albumTitle && a.artist === artist);
                            
                            if (isMobile) {
                                if (this.state.mobileCardSelectedForModal === card) {
                                    if (albumIndexInVisible !== -1) {
                                        this.methods.openAlbumModal(this.state.visibleAlbums[albumIndexInVisible], albumIndexInVisible);
                                    }
                                    this.state.mobileCardSelectedForModal = null;
                                } else {
                                    this.methods.applyHighlights(card);
                                    this.state.mobileCardSelectedForModal = card;
                                }
                            } else {
                                if (albumIndexInVisible !== -1) this.methods.openAlbumModal(this.state.visibleAlbums[albumIndexInVisible], albumIndexInVisible);
                            }
                        }
                    });
                    
                    timelineContainer.addEventListener('scroll', () => {
                        let currentYear = '';
                        const yearSections = timelineWrapper.querySelectorAll('.timeline-year-section');
                        for (const section of yearSections) {
                            if (section.style.display !== 'none' && section.offsetLeft <= timelineContainer.scrollLeft + 60) {
                                currentYear = section.id.replace('year-', '');
                            }
                        }

                        if (currentYear && currentYear !== this.state.lastKnownYear) {
                            this.state.lastKnownYear = currentYear;
                            stickyYearDisplay.style.opacity = '0';
                            setTimeout(() => {
                                stickyYearDisplay.textContent = currentYear;
                                stickyYearDisplay.style.opacity = '1';
                            }, 150);

                            const currentEra = this.state.eras.find(era => currentYear >= era.startYear && currentYear <= era.endYear);
                            if (currentEra && currentEra.title !== this.state.lastKnownEraTitle) {
                                this.state.lastKnownEraTitle = currentEra.title;
                                stickyEraTitle.style.opacity = '0';
                                setTimeout(() => {
                                    stickyEraTitle.textContent = `— ${currentEra.title}`;
                                    stickyEraTitle.style.opacity = '1';
                                }, 150);
                            }
                        }
                        this.methods.updateCustomScrollbar();
                    });

                    // Set initial state
                    const firstYearSection = timelineWrapper.querySelector('.timeline-year-section:not([style*="display: none"])');
                    if (firstYearSection) {
                        const firstYear = firstYearSection.id.replace('year-', '');
                        stickyYearDisplay.textContent = firstYear;
                        this.state.lastKnownYear = firstYear;
                        const firstEra = this.state.eras.find(era => firstYear >= era.startYear && firstYear <= era.endYear);
                        if (firstEra) {
                            stickyEraTitle.textContent = `— ${firstEra.title}`;
                            this.state.lastKnownEraTitle = firstEra.title;
                        }
                    }
                },
                
                setupModals() {
                    const { albumModal, artistModal, genreModal, pathModal, matrixContainer } = this.elements;
                    albumModal.querySelector('#close-modal').addEventListener('click', () => this.methods.closeAlbumModal());
                    albumModal.addEventListener('click', e => { 
                        if (e.target.id === 'album-modal') this.methods.closeAlbumModal();
                        
                        const target = e.target;
                        if (target.matches('.clickable-link[data-artist-name]')) {
                            const artistName = target.dataset.artistName;
                            const artist = this.state.artistsData.find(a => a.name === artistName);
                            if (artist) {
                                this.methods.closeAlbumModal(() => this.methods.openArtistModal(artist));
                            }
                        } else if (target.matches('.clickable-link[data-genre-name]')) {
                            const genreName = target.dataset.genreName;
                            if (this.state.styleMatrix.genres[genreName]) {
                                this.methods.closeAlbumModal(() => this.methods.openGenreModal(genreName));
                            }
                        }
                    });
                    document.getElementById('prev-album-btn').addEventListener('click', () => {
                        if (this.state.currentVisibleAlbumIndex > 0) {
                            const newIndex = this.state.currentVisibleAlbumIndex - 1;
                            this.methods.openAlbumModal(this.state.visibleAlbums[newIndex], newIndex);
                        }
                    });
                    document.getElementById('next-album-btn').addEventListener('click', () => {
                        if (this.state.currentVisibleAlbumIndex < this.state.visibleAlbums.length - 1) {
                            const newIndex = this.state.currentVisibleAlbumIndex + 1;
                            this.methods.openAlbumModal(this.state.visibleAlbums[newIndex], newIndex);
                        }
                    });

                    artistModal.querySelector('#close-artist-modal').addEventListener('click', () => this.methods.closeArtistModal());
                    artistModal.addEventListener('click', e => { 
                        if (e.target.id === 'artist-modal') this.methods.closeArtistModal(); 
                        
                        const collaboratorCard = e.target.closest('.collaborator-card');
                        if (collaboratorCard && collaboratorCard.dataset.artistName) {
                            const collaboratorName = collaboratorCard.dataset.artistName;
                            const collaborator = this.state.artistsData.find(a => a.name === collaboratorName);
                            if (collaborator) {
                                this.methods.closeArtistModal(() => this.methods.openArtistModal(collaborator));
                            }
                        }
                    });
                    
                    genreModal.querySelector('#close-genre-modal').addEventListener('click', () => this.methods.closeGenreModal());
                    genreModal.addEventListener('click', e => { if (e.target.id === 'genre-modal') this.methods.closeGenreModal(); });

                    pathModal.querySelector('#close-path-modal').addEventListener('click', () => this.methods.closePathModal());
                    pathModal.addEventListener('click', e => { if (e.target.id === 'path-modal') this.methods.closePathModal(); });
                    
                    document.addEventListener('keydown', e => { if (e.key === "Escape") { this.methods.closeAlbumModal(); this.methods.closeArtistModal(); this.methods.closeGenreModal(); this.methods.closePathModal(); } });
                    
                    artistModal.addEventListener('click', (e) => {
                        if (e.target.matches('.clickable-link[data-album-title]')) {
                            const { albumTitle, artist } = e.target.dataset;
                            const visibleAlbum = this.state.visibleAlbums.find(a => a.albumTitle === albumTitle && a.artist === artist);
                            if (visibleAlbum) {
                                const indexInVisible = this.state.visibleAlbums.indexOf(visibleAlbum);
                                this.methods.closeArtistModal(() => this.methods.openAlbumModal(visibleAlbum, indexInVisible));
                            }
                        }
                    });

                    matrixContainer.addEventListener('click', (e) => {
                        const button = e.target.closest('.genre-header-button');
                        if(button) {
                            const genreName = button.dataset.genreName;
                            this.methods.openGenreModal(genreName);
                        }
                    });
                    
                    genreModal.addEventListener('click', (e) => {
                        const target = e.target.closest('.clickable-link');
                        if (!target) return;

                        if (target.dataset.artistName) {
                            const artistName = target.dataset.artistName;
                            const artist = this.state.artistsData.find(a => a.name === name);
                            if (artist) {
                                this.methods.closeGenreModal(() => this.methods.openArtistModal(artist));
                            }
                        } else if (target.dataset.albumTitle) {
                            const { albumTitle, artist } = target.dataset;
                            const visibleAlbum = this.state.visibleAlbums.find(a => a.albumTitle === albumTitle && a.artist === artist);
                             if (visibleAlbum) {
                                const indexInVisible = this.state.visibleAlbums.indexOf(visibleAlbum);
                                this.methods.closeGenreModal(() => this.methods.openAlbumModal(visibleAlbum, indexInVisible));
                            }
                        }
                    });
                },

                setupArtistSlider() {
                    const { instrumentFilter, artistSliderTrack, artistPaginationControls, artistPageIndicator } = this.elements;
                    const selectedInstrument = instrumentFilter.value;
                    const filteredArtists = (selectedInstrument === 'all' ? [...this.state.artistsData] : this.state.artistsData.filter(artist => artist.instruments.includes(selectedInstrument)))
                        .sort((a, b) => {
                            if (a.tier !== b.tier) return a.tier - b.tier;
                            return a.name.localeCompare(b.name);
                        });

                    artistSliderTrack.innerHTML = '';
                    const pageSize = window.innerWidth >= 768 ? 12 : 6;
                    this.state.totalArtistPages = Math.ceil(filteredArtists.length / pageSize);

                    if (this.state.totalArtistPages <= 1) {
                        artistPaginationControls.classList.add('hidden');
                    } else {
                        artistPaginationControls.classList.remove('hidden');
                    }

                    for (let i = 0; i < this.state.totalArtistPages; i++) {
                        const pageDiv = document.createElement('div');
                        pageDiv.className = 'artist-slider-page';
                        const pageArtists = filteredArtists.slice(i * pageSize, (i + 1) * pageSize);
                        pageArtists.forEach(artist => {
                            const card = document.createElement('div');
                            card.className = 'artist-card';
                            if (artist.tier === 1) card.classList.add('bandleader');
                            if (artist.tier === 2) card.classList.add('influential-sideman');
                            card.dataset.artistName = artist.name;
                            card.innerHTML = `
                                <div class="h-56 bg-stone-900 artist-photo-container">
                                    <img src="${artist.photo || ''}" loading="lazy" alt="Photo of ${artist.name}" class="w-full h-full object-cover" onerror="this.onerror=null;this.src='images/artistplaceholder.jpg';">
                                </div>
                                <div class="p-3">
                                    <h4 class="font-bold text-base text-stone-900 truncate">${artist.name}</h4>
                                </div>`;
                            pageDiv.appendChild(card);
                        });
                        artistSliderTrack.appendChild(pageDiv);
                    }
                    this.methods.goToArtistPage(this.state.currentArtistPage);
                },
                
                setupMobileMenu() {
                    const { mobileMenuButton, mobileMenuOverlay, mobileMenuPanel, mobileMenuCloseButton, mobileNavLinks } = this.elements;
                    const openMenu = () => {
                        mobileMenuOverlay.classList.remove('hidden');
                        setTimeout(() => { mobileMenuPanel.style.transform = 'translateX(0)'; }, 10);
                    };
                    const closeMenu = () => {
                        mobileMenuPanel.style.transform = 'translateX(100%)';
                        setTimeout(() => { mobileMenuOverlay.classList.add('hidden'); }, 300);
                    };
                    mobileMenuButton.addEventListener('click', openMenu);
                    mobileMenuCloseButton.addEventListener('click', closeMenu);
                    document.getElementById('mobile-menu-bg').addEventListener('click', closeMenu);
                    mobileNavLinks.forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            closeMenu();
                            const targetId = link.getAttribute('href');
                            const targetElement = document.querySelector(targetId);
                            if (targetElement) {
                                setTimeout(() => { window.scrollTo({ top: targetElement.offsetTop - 80, behavior: 'smooth' }); }, 300);
                            }
                        });
                    });
                },

                setupScrollObservers() {
                    const fadeElements = document.querySelectorAll('.fade-in-element');
                    const scrollObserver = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                entry.target.classList.add('is-visible');
                            }
                        });
                    }, { threshold: 0.1 });
                    fadeElements.forEach(el => scrollObserver.observe(el));

                    const observerOptions = { root: null, rootMargin: '0px 0px -50% 0px', threshold: 0 };
                    const sectionObserver = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                const id = entry.target.getAttribute('id');
                                this.elements.navLinks.forEach(link => {
                                    link.classList.remove('active');
                                    if (link.getAttribute('href') === `#${id}`) link.classList.add('active');
                                });
                                this.elements.mobileNavLinks.forEach(link => {
                                    link.classList.remove('text-orange-500');
                                    if (link.getAttribute('href') === `#${id}`) link.classList.add('text-orange-500');
                                });
                            }
                        });
                    }, observerOptions);
                    this.elements.sections.forEach(section => { if (section.id) sectionObserver.observe(section); });
                },

                setupGeneralEventListeners() {
                    this.elements.instrumentFilter.addEventListener('change', () => {
                        this.state.currentArtistPage = 0; // Reset page on filter change
                        this.methods.setupArtistSlider();
                    });
                    
                    this.elements.artistSliderTrack.addEventListener('click', (e) => {
                        const card = e.target.closest('.artist-card');
                        if (card && card.dataset.artistName) {
                            const artist = this.state.artistsData.find(a => a.name === card.dataset.artistName);
                            if (artist) this.methods.openArtistModal(artist);
                        }
                    });

                    this.elements.artistPrevBtn.addEventListener('click', () => this.methods.goToArtistPage(this.state.currentArtistPage - 1));
                    this.elements.artistNextBtn.addEventListener('click', () => this.methods.goToArtistPage(this.state.currentArtistPage + 1));
                    
                    let resizeTimeout;
                    window.addEventListener('resize', () => {
                        clearTimeout(resizeTimeout);
                        resizeTimeout = setTimeout(() => {
                            const currentPage = this.state.currentArtistPage;
                            this.methods.setupArtistSlider();
                            this.methods.goToArtistPage(currentPage); // Restore current page
                            this.methods.resizeCanvas();
                            this.methods.updateCustomScrollbar();
                            this.methods.renderScrollbarMarkers();
                            this.methods.renderInfluenceWeb(); // Re-render the web on resize
                        }, 200);
                    });
                    
                    this.elements.footerCopyright.textContent = `© ${new Date().getFullYear()} Controlled Freedom. All Rights Reserved.`;
                    if (this.elements.scrollRightBtn) this.elements.scrollRightBtn.classList.add('nudge-animation');
                    
                    this.methods.setupDraggable(this.elements.timelineContainer);
                    this.methods.setupCustomScrollbarInteraction();

                    // Add a global click listener for clickable links
                    document.body.addEventListener('click', e => {
                        const target = e.target;
                        if (target.matches('.clickable-link[data-artist-name]')) {
                            const artistName = target.dataset.artistName;
                            const artist = this.state.artistsData.find(a => a.name === artistName);
                            if (artist) {
                                this.methods.openArtistModal(artist);
                            }
                        }
                    });
                },
                
                // --- HELPER METHODS ---
                slugify(name) {
                    if (!name) return '';
                    return name.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]+/g, '').replace(/--+/g, '-').replace(/^-+/, '').replace(/-+$/, '');
                },
                
                normalizeGenreName(genreName) {
                    if (genreName === "Avant-Garde Jazz") return "Avant-Garde";
                    return genreName;
                },

                filterTimeline() {
                    const selectedGenres = Array.from(this.elements.genreFilterContainer.querySelectorAll('input[data-genre]:checked')).map(input => input.value);
                    this.state.visibleAlbums = [];
                    document.querySelectorAll('.timeline-album-card').forEach(card => {
                        const cardGenres = card.dataset.genres.split(', ');
                        const isVisible = cardGenres.some(genre => selectedGenres.includes(genre));
                        card.classList.toggle('hidden', !isVisible);
                        if(isVisible) {
                            const album = this.state.albums.find(a => a.albumTitle === card.dataset.albumTitle && a.artist === card.dataset.artist);
                            if (album) this.state.visibleAlbums.push(album);
                        }
                    });
                    document.querySelectorAll('.timeline-year-section').forEach(yearSection => {
                        const visibleCards = yearSection.querySelectorAll('.timeline-album-card:not(.hidden)');
                        yearSection.style.display = visibleCards.length > 0 ? 'flex' : 'none';
                    });
                    document.querySelectorAll('.era-section').forEach(eraSection => {
                        const visibleYears = eraSection.querySelectorAll('.timeline-year-section:not([style*="display: none"])');
                        eraSection.style.display = visibleYears.length > 0 ? 'flex' : 'none';
                    });

                    this.elements.genreFilterContainer.querySelector('#all-genres-checkbox').checked = selectedGenres.length === this.elements.genreFilterContainer.querySelectorAll('input[data-genre]').length;
                    
                    setTimeout(() => {
                        this.methods.resizeCanvas();
                        this.methods.renderScrollbarMarkers();
                        this.methods.updateCustomScrollbar();
                    }, 0);
                },

                applyHighlights(selectedCard) {
                    document.querySelectorAll('.timeline-album-card').forEach(c => {
                        c.classList.remove('dimmed', 'highlighted');
                        c.style.removeProperty('--highlight-color');
                    });
                    if (!selectedCard) return;
                    document.querySelectorAll('.timeline-album-card').forEach(c => c.classList.add('dimmed'));
                    const selectedGenres = selectedCard.dataset.genres.split(', ');
                    const primaryGenre = selectedGenres[0];
                    const highlightColor = this.state.fullGenreColorMap[primaryGenre] || 'var(--accent)';
                    const allCards = Array.from(document.querySelectorAll('.timeline-album-card:not(.hidden)'));
                    allCards.forEach(card => {
                        const cardGenres = card.dataset.genres.split(', ');
                        if (cardGenres.includes(primaryGenre)) {
                            card.classList.remove('dimmed');
                            card.classList.add('highlighted');
                            card.style.setProperty('--highlight-color', highlightColor);
                        }
                    });
                },
                
                openAlbumModal(album, indexInVisibleList) {
                    this.state.currentVisibleAlbumIndex = indexInVisibleList;
                    const { albumModal } = this.elements;
                    
                    this.methods.applyHighlights(null);
                    this.state.lastHoveredGenre = null;

                    const previouslyClicked = document.querySelector('.timeline-album-card.clicked');
                    if (previouslyClicked) previouslyClicked.classList.remove('clicked');
                    const safeAlbumTitle = album.albumTitle.replace(/"/g, '\\"');
                    const safeArtist = album.artist.replace(/"/g, '\\"');
                    const cardToHighlight = document.querySelector(`.timeline-album-card[data-album-title="${safeAlbumTitle}"][data-artist="${safeArtist}"]`);
                    if (cardToHighlight) cardToHighlight.classList.add('clicked');
                    
                    albumModal.querySelector('#modal-title').textContent = album.albumTitle;
                    const artistBtn = albumModal.querySelector('#modal-artist');
                    artistBtn.textContent = album.artist;
                    artistBtn.dataset.artistName = album.artist;
                    artistBtn.className = 'text-xl text-gray-400 bg-transparent border-none p-0 clickable-link';

                    const modalImg = albumModal.querySelector('#modal-album-art');
                    modalImg.src = album.cover || '';
                    modalImg.alt = `Cover for ${album.albumTitle}`;
                    modalImg.onerror = function() { this.onerror=null; this.src='https://placehold.co/400x400/1c1917/f5f5f4?text=No+Image'; };
                    const firstTrack = album.pivotalTracks[0] || {};
                    const genreTags = album.genres.split(', ').map(genre => `<span class="genre-tag clickable-link" style="background-color: ${this.state.fullGenreColorMap[genre] || 'var(--genre-default)'}" data-genre-name="${genre}">${genre}</span>`).join(' ');
                    
                    let lineupString = firstTrack.lineup || 'N/A';
                    if (lineupString !== 'N/A') {
                        lineupString = lineupString.replace(/Roland Kirk/g, 'Rahsaan Roland Kirk');
                    }
                    const lineupHtml = lineupString !== 'N/A' ? lineupString.split(/, (?![^()]*\))/).map(personnel => {
                        const match = personnel.trim().match(/(.+?)\s\((.+)\)/);
                        if (match && this.state.artistsData.some(a => a.name === match[1].trim())) {
                            return `<span class="clickable-link" data-artist-name="${match[1].trim()}">${match[1].trim()}</span> (${match[2]})`;
                        }
                        return personnel;
                    }).join(', ') : 'N/A';

                    albumModal.querySelector('#modal-album-details').innerHTML = `<h4 class="text-3xl text-gray-200 mb-4">Album Details</h4><div class="grid grid-cols-[auto,1fr] gap-x-4 gap-y-2 text-base text-gray-300"><strong class="font-bold">Genre:</strong> <div class="flex flex-wrap gap-2">${genreTags}</div><strong class="font-bold">Recorded:</strong> <span>${firstTrack.recordingDate || 'N/A'}</span><strong class="font-bold">Label:</strong> <span>${firstTrack.label || 'N/A'}</span><strong class="font-bold align-top">Line-Up:</strong> <span>${lineupHtml}</span></div>`;
                    
                    const analysisWrapper = albumModal.querySelector('#analysis-wrapper');
                    const pivotalTracksHtml = album.pivotalTracks.map(track => {
                        const songFileName = this.methods.slugify(track.title);
                        return `<div class="mb-8 last:mb-0">
                                    <div class="flex justify-between items-center gap-4 flex-wrap">
                                        <h5 class="text-2xl font-bold text-white flex-1 min-w-0">Key Track: "<span class="underline decoration-orange-400 decoration-2 underline-offset-4">${track.title}</span>"</h5>
                                        <div id="player-container-${songFileName}" class="w-full sm:w-52 h-[35px]">
                                            <audio id="player-${songFileName}" controls class="styled-player w-full" src="songs/${songFileName}.mp3" preload="none"></audio>
                                        </div>
                                    </div>
                                    <p class="liner-notes-text">${track.analysis}</p>
                                </div>`;
                    }).join('<hr class="border-gray-700 my-8">');

                    analysisWrapper.innerHTML = `<div id="modal-analysis-section">${pivotalTracksHtml}</div>`;
                    
                    album.pivotalTracks.forEach(track => {
                        const songFileName = this.methods.slugify(track.title);
                        const player = document.getElementById(`player-${songFileName}`);
                        const playerContainer = document.getElementById(`player-container-${songFileName}`);

                        if (player) {
                            player.onerror = () => {
                                if (playerContainer) {
                                    playerContainer.innerHTML = `<div class="w-full h-full flex items-center justify-center bg-gray-700 text-gray-400 text-sm rounded">Preview Not Available</div>`;
                                }
                            };
                            
                            player.addEventListener('play', () => {
                                document.querySelectorAll('audio').forEach(otherPlayer => {
                                    if (otherPlayer !== player) {
                                        otherPlayer.pause();
                                    }
                                });
                            });
                        }
                    });


                    document.getElementById('prev-album-btn').disabled = indexInVisibleList <= 0;
                    document.getElementById('next-album-btn').disabled = indexInVisibleList < 0 || indexInVisibleList >= this.state.visibleAlbums.length - 1;

                    albumModal.classList.remove('opacity-0', 'pointer-events-none');
                    albumModal.querySelector('.modal-content').classList.remove('scale-95');
                    albumModal.querySelector('#modal-body').scrollTop = 0;
                },

                closeAlbumModal(callback) {
                    const { albumModal } = this.elements;
                    albumModal.classList.add('opacity-0', 'pointer-events-none');
                    albumModal.querySelector('.modal-content').classList.add('scale-95');
                    albumModal.querySelectorAll('audio').forEach(audio => audio.pause());
                    const clickedCard = document.querySelector('.timeline-album-card.clicked');
                    if (clickedCard) clickedCard.classList.remove('clicked');
                    this.methods.applyHighlights(null);
                    this.state.lastHoveredGenre = null;
                    if (typeof callback === 'function') setTimeout(callback, 300);
                },

                openArtistModal(artist) {
                    const { artistModal } = this.elements;
                    const artistProfile = artist.profile || {};
                    artistModal.querySelector('#artist-modal-title').textContent = artist.name;
                    const body = artistModal.querySelector('#artist-modal-body');

                    const artistAlbumsWithYear = artist.albums
                        .map(albumTitle => this.state.albums.find(a => a.albumTitle === albumTitle))
                        .filter(Boolean)
                        .sort((a, b) => a.year - b.year);
                    
                    const isLandmark = (albumTitle) => {
                        for (const genreName in this.state.styleMatrix.genres) {
                            const genreData = this.state.styleMatrix.genres[genreName];
                            if (genreData.landmarkAlbums && genreData.landmarkAlbums.some(title => title.toLowerCase() === albumTitle.toLowerCase())) {
                                return true;
                            }
                        }
                        return false;
                    };

                    const albumTimelineHtml = artistAlbumsWithYear.map(album => {
                        const landmarkIcon = isLandmark(album.albumTitle) ? '<span class="landmark-star">★</span>' : '';
                        return `<li class="artist-modal-timeline-item">
                                    <strong class="text-gray-400">${album.year}:</strong> 
                                    <span class="clickable-link" data-album-title="${album.albumTitle}" data-artist="${album.artist}">
                                        ${album.albumTitle}
                                    </span>
                                    ${landmarkIcon}
                                </li>`;
                    }).join('');

                    const topCollaborators = this.methods.getTopCollaborators(artist.name);
                    let collaboratorsHtml = '';
                    if (topCollaborators.length > 0) {
                        const collaboratorCards = topCollaborators.map(name => {
                            const collaborator = this.state.artistsData.find(a => a.name === name);
                            if (!collaborator) return '';
                            return `
                                <div class="collaborator-card text-center" data-artist-name="${collaborator.name}">
                                    <img src="${collaborator.photo || ''}" alt="${collaborator.name}" class="w-24 h-24 object-cover rounded-full mx-auto border-4 border-gray-800 shadow-md" onerror="this.onerror=null;this.src='images/artistplaceholder.jpg';">
                                    <p class="mt-2 text-sm font-bold text-gray-300">${collaborator.name}</p>
                                </div>
                            `;
                        }).join('');

                        collaboratorsHtml = `
                            <div class="mt-6 pt-4 border-t-2 border-gray-800">
                                <h4 class="text-2xl text-gray-200 mb-4 text-center">Top Collaborators</h4>
                                <div class="grid grid-cols-3 gap-4">
                                    ${collaboratorCards}
                                </div>
                            </div>
                        `;
                    }

                    body.innerHTML = `
                        <div class="flex flex-col sm:flex-row gap-6">
                            <div class="w-full sm:w-1/3 flex-shrink-0">
                                <div class="artist-photo-container">
                                    <img src="${artist.photo || ''}" loading="lazy" class="w-full h-auto rounded-md border-2 border-gray-700" onerror="this.onerror=null;this.src='images/artistplaceholder.jpg';">
                                </div>
                                <p class="mt-4 text-gray-300 text-sm"><strong class="font-bold">Instruments:</strong> ${artist.instruments.join(', ')}</p>
                                ${artistProfile.knownFor ? `<div class="mt-6"><h4 class="text-xl text-gray-200 mb-2 transform -rotate-1">Known For...</h4><div class="known-for-box">${artistProfile.knownFor}</div></div>` : ''}
                            </div>
                            <div class="w-full sm:w-2/3">
                                ${artistProfile.profile && artistProfile.profile !== 'No profile available.' ? `<h4 class="text-2xl text-gray-200 mb-2">Profile</h4><p class="text-base text-gray-400 leading-relaxed mb-4">${artistProfile.profile}</p>` : ''}
                                <h4 class="text-2xl text-gray-200 mb-3">Album Appearances</h4>
                                <ul class="artist-modal-timeline h-48 overflow-y-auto pr-2">${albumTimelineHtml}</ul>
                            </div>
                        </div>
                        ${collaboratorsHtml}
                    `;
                    
                    artistModal.classList.remove('opacity-0', 'pointer-events-none');
                    artistModal.querySelector('.modal-content').classList.remove('scale-95');
                },


                closeArtistModal(callback) {
                    const { artistModal } = this.elements;
                    artistModal.classList.add('opacity-0', 'pointer-events-none');
                    artistModal.querySelector('.modal-content').classList.add('scale-95');
                    if (typeof callback === 'function') setTimeout(callback, 300);
                },
                
                openGenreModal(genreName) {
                    const { genreModal } = this.elements;
                    const genreData = this.state.styleMatrix.genres[genreName];
                    if (!genreData) return;

                    const titleEl = genreModal.querySelector('#genre-modal-title');
                    titleEl.textContent = genreName;
                    titleEl.style.color = genreData.color.startsWith('var') ? `var(--accent)` : genreData.color;

                    const bodyEl = genreModal.querySelector('#genre-modal-body');
                    
                    const landmarkAlbums = (genreData.landmarkAlbums || []).map(title => {
                        return this.state.albums.find(a => a.albumTitle.toLowerCase() === title.toLowerCase());
                    }).filter(Boolean);
                    
                    const initialArtists = new Set(genreData.artists.split(', ').map(name => name.trim()));
                    landmarkAlbums.forEach(album => initialArtists.add(album.artist.trim()));
                    
                    const keyArtistsHtml = Array.from(initialArtists).sort()
                        .filter(name => this.state.artistsData.some(a => a.name === name))
                        .map(name => `<span class="clickable-link" data-artist-name="${name}">${name}</span>`)
                        .join(', ');

                    const landmarkAlbumsHtml = landmarkAlbums.map(album => 
                        `<li><span class="clickable-link" data-album-title="${album.albumTitle}" data-artist="${album.artist}">${album.albumTitle}</span></li>`
                    ).join('');

                    let bodyHtml = `<div class="space-y-6">
                        <div>
                            <h4 class="text-2xl font-bold text-gray-200 mb-2">Overview</h4>
                            <p class="text-base text-gray-400 leading-relaxed">${genreData.profile || 'No profile available.'}</p>
                        </div>
                        <div>
                            <h4 class="text-2xl font-bold text-gray-200 mb-2">Key Characteristics</h4>
                            <ul class="list-disc list-inside space-y-1 text-gray-400">
                                <li><strong>Harmony:</strong> ${genreData.data[0]}</li>
                                <li><strong>Rhythm:</strong> ${genreData.data[1]}</li>
                                <li><strong>Form:</strong> ${genreData.data[2]}</li>
                            </ul>
                        </div>
                        <div>
                            <h4 class="text-2xl font-bold text-gray-200 mb-2">Key Artists</h4>
                            <p class="text-base text-gray-400 leading-relaxed">${keyArtistsHtml}</p>
                        </div>
                        ${landmarkAlbums.length > 0 ? `
                        <div>
                            <h4 class="text-2xl font-bold text-gray-200 mb-2">Landmark Albums</h4>
                            <ul class="list-disc list-inside space-y-1 landmark-album-list">${landmarkAlbumsHtml}</ul>
                        </div>` : ''}
                    </div>`;
                    
                    bodyEl.innerHTML = bodyHtml;

                    genreModal.classList.remove('opacity-0', 'pointer-events-none');
                    genreModal.querySelector('.modal-content').classList.remove('scale-95');
                },

                closeGenreModal(callback) {
                    const { genreModal } = this.elements;
                    genreModal.classList.add('opacity-0', 'pointer-events-none');
                    genreModal.querySelector('.modal-content').classList.add('scale-95');
                    if (typeof callback === 'function') setTimeout(callback, 300);
                },

                openPathModal(pathId) {
                    const { pathModal } = this.elements;
                    const data = this.state.pathData[pathId];
                    if (!data) return;

                    const titleEl = pathModal.querySelector('#path-modal-title');
                    titleEl.textContent = data.title;
                    const mainNode = document.querySelector(`#node-${pathId}`);
                    const color = mainNode ? mainNode.querySelector('.node-label').style.backgroundColor : 'var(--accent)';
                    titleEl.style.color = color;
                    
                    const bodyEl = pathModal.querySelector('#path-modal-body');
                    const albumsHtml = data.albums.map(album => 
                        `<li class="text-sm"><strong>${album.year}</strong> - ${album.title} by ${album.artist}</li>`
                    ).join('');

                    bodyEl.innerHTML = `
                        <div class="space-y-4">
                            <div>
                                <h4 class="text-lg font-bold text-gray-200">Genre Affinity</h4>
                                <p class="text-base text-gray-400">${data.affinity}</p>
                            </div>
                            <div>
                                <h4 class="text-lg font-bold text-gray-200">Key Albums</h4>
                                <ul class="list-disc list-inside space-y-1 text-gray-400">${albumsHtml}</ul>
                            </div>
                        </div>
                    `;

                    pathModal.classList.remove('opacity-0', 'pointer-events-none');
                    pathModal.querySelector('.modal-content').classList.remove('scale-95');
                },

                closePathModal() {
                    const { pathModal } = this.elements;
                    pathModal.classList.add('opacity-0', 'pointer-events-none');
                    pathModal.querySelector('.modal-content').classList.add('scale-95');
                },
                
                populateInstrumentFilter(artists) {
                    const { instrumentFilter } = this.elements;
                    const relevantInstruments = new Set(['alto saxophone', 'baritone saxophone', 'bass', 'bass clarinet', 'cornet', 'drums', 'flugelhorn', 'flute', 'guitar', 'organ', 'piano', 'soprano saxophone', 'tenor saxophone', 'trombone', 'trumpet', 'tuba', 'vibraphone', 'congas']);
                    const instrumentsInDataset = new Set();
                    artists.forEach(artist => artist.instruments.forEach(inst => { if (relevantInstruments.has(inst)) instrumentsInDataset.add(inst); }));
                    instrumentFilter.innerHTML = '<option value="all">All Instruments</option>';
                    Array.from(instrumentsInDataset).sort().forEach(instrument => {
                        const option = document.createElement('option');
                        option.value = instrument;
                        option.textContent = instrument.charAt(0).toUpperCase() + instrument.slice(1);
                        instrumentFilter.appendChild(option);
                    });
                },
                
                goToArtistPage(pageIndex) {
                    const { artistSliderTrack, artistPrevBtn, artistNextBtn, artistPageIndicator } = this.elements;
                    this.state.currentArtistPage = Math.max(0, Math.min(pageIndex, this.state.totalArtistPages - 1));
                    artistSliderTrack.style.transform = `translateX(-${this.state.currentArtistPage * 100}%)`;
                    artistPrevBtn.disabled = this.state.currentArtistPage === 0;
                    artistNextBtn.disabled = this.state.currentArtistPage >= this.state.totalArtistPages - 1;
                    if (artistPageIndicator) {
                        if (this.state.totalArtistPages > 0) {
                            artistPageIndicator.textContent = `${this.state.currentArtistPage + 1} / ${this.state.totalArtistPages}`;
                        } else {
                            artistPageIndicator.textContent = '';
                        }
                    }
                },
                
                resizeCanvas() {
                    const { timelineCanvas, timelineWrapper } = this.elements;
                    timelineCanvas.width = timelineWrapper.scrollWidth;
                    timelineCanvas.height = timelineWrapper.offsetHeight;
                },
                
                setupDraggable(container) {
                    if (!container) return;
                    let isDown = false, startX, scrollLeft;
                    container.addEventListener('mousedown', (e) => { isDown = true; container.style.cursor = 'grabbing'; startX = e.pageX - container.offsetLeft; scrollLeft = container.scrollLeft; });
                    container.addEventListener('mouseleave', () => { isDown = false; container.style.cursor = 'grab'; });
                    container.addEventListener('mouseup', () => { isDown = false; container.style.cursor = 'grab'; });
                    container.addEventListener('mousemove', (e) => {
                        if(!isDown) return;
                        e.preventDefault();
                        const x = e.pageX - container.offsetLeft;
                        const walk = (x - startX) * 2;
                        container.scrollLeft = scrollLeft - walk;
                    });
                },
                
                updateCustomScrollbar() {
                    const { timelineContainer, customScrollbar, customScrollbarThumb } = this.elements;
                    if (!timelineContainer || !customScrollbar || !customScrollbarThumb) return;
                    const scrollableWidth = timelineContainer.scrollWidth - timelineContainer.clientWidth;
                    if (scrollableWidth <= 0) {
                        customScrollbar.style.display = 'none';
                        return;
                    }
                    customScrollbar.style.display = 'block';
                    const scrollPercentage = timelineContainer.scrollLeft / scrollableWidth;
                    const thumbWidthPercentage = timelineContainer.clientWidth / timelineContainer.scrollWidth;
                    customScrollbarThumb.style.width = `${thumbWidthPercentage * 100}%`;
                    customScrollbarThumb.style.left = `${scrollPercentage * (100 - thumbWidthPercentage * 100)}%`;
                },
                
                setupCustomScrollbarInteraction() {
                    const { customScrollbar, customScrollbarThumb, timelineContainer } = this.elements;
                    let isDraggingThumb = false, thumbStartX, thumbStartScrollLeft;
                    customScrollbarThumb.addEventListener('mousedown', (e) => {
                        isDraggingThumb = true;
                        thumbStartX = e.clientX;
                        thumbStartScrollLeft = timelineContainer.scrollLeft;
                        customScrollbarThumb.style.cursor = 'grabbing';
                        document.body.style.cursor = 'grabbing';
                        document.body.style.userSelect = 'none';
                    });
                    document.addEventListener('mousemove', (e) => {
                        if (!isDraggingThumb) return;
                        e.preventDefault();
                        const dx = e.clientX - thumbStartX;
                        const scrollbarWidth = customScrollbar.clientWidth;
                        const thumbWidth = customScrollbarThumb.clientWidth;
                        const scrollableWidth = timelineContainer.scrollWidth - timelineContainer.clientWidth;
                        timelineContainer.scrollLeft = thumbStartScrollLeft + (dx / (scrollbarWidth - thumbWidth)) * scrollableWidth;
                    });
                    document.addEventListener('mouseup', () => {
                        isDraggingThumb = false;
                        if (customScrollbarThumb) customScrollbarThumb.style.cursor = 'grab';
                        document.body.style.cursor = '';
                        document.body.style.userSelect = '';
                    });
                    customScrollbar.addEventListener('click', (e) => {
                        if (e.target === customScrollbar) {
                            const scrollbarRect = customScrollbar.getBoundingClientRect();
                            const clickPosition = (e.clientX - scrollbarRect.left) / scrollbarRect.width;
                            const scrollableWidth = timelineContainer.scrollWidth - timelineContainer.clientWidth;
                            timelineContainer.scrollTo({ left: clickPosition * scrollableWidth, behavior: 'smooth' });
                        }
                    });
                    setTimeout(() => this.methods.updateCustomScrollbar(), 200);
                },

                renderScrollbarMarkers() {
                    const { timelineContainer, timelineWrapper, customScrollbarMarkers } = this.elements;
                    const years = [...new Set(this.state.albums.map(album => album.year))].sort();
                    customScrollbarMarkers.innerHTML = ''; // Clear existing markers

                    if (timelineWrapper.scrollWidth <= timelineContainer.clientWidth) {
                        return; // Don't render if not scrollable
                    }

                    years.forEach(year => {
                        const yearSection = document.getElementById(`year-${year}`);
                        if (yearSection && yearSection.style.display !== 'none') {
                            const position = yearSection.offsetLeft + (yearSection.offsetWidth / 2);
                            const percentage = (position / timelineWrapper.scrollWidth) * 100;
                            
                            const marker = document.createElement('div');
                            marker.className = 'scrollbar-marker';
                            marker.style.left = `${percentage}%`;
                            marker.dataset.year = `'${String(year).slice(2)}`;
                            customScrollbarMarkers.appendChild(marker);
                        }
                    });
                },

                setupOnThisDayFeature() {
                    const { onThisDayContainer } = this.elements;
                    if (!onThisDayContainer) return;

                    const today = new Date();
                    const currentMonth = today.toLocaleString('en-US', { month: 'long' });
                    const currentDay = today.getDate();

                    const matchingTracks = [];
                    this.state.albums.forEach(album => {
                        album.pivotalTracks.forEach(track => {
                            const dateParts = track.recordingDate.replace(/,/g, '').split(' ');
                            if (dateParts.length >= 2) {
                                const recordMonth = dateParts[0];
                                const recordDay = parseInt(dateParts[1]);
                                if (recordMonth === currentMonth && recordDay === currentDay) {
                                    matchingTracks.push({ ...track, parentAlbum: album });
                                }
                            }
                        });
                    });

                    if (matchingTracks.length > 0) {
                        const featured = matchingTracks[Math.floor(Math.random() * matchingTracks.length)];
                        const album = featured.parentAlbum;

                        onThisDayContainer.innerHTML = `
                            <div class="p-4 bg-gray-800 border border-gray-700 rounded-lg shadow-lg cursor-pointer hover:shadow-orange-400/20 hover:-translate-y-1 transition-all">
                                <h4 class="text-2xl text-gray-200 mb-2 transform -rotate-1 inline-block bg-yellow-400 text-gray-900 px-2">On This Day In Jazz...</h4>
                                <div class="flex items-center gap-4 mt-2">
                                    <img src="${album.cover}" loading="lazy" class="w-24 h-24 object-cover border-2 border-gray-700 rounded-md" onerror="this.onerror=null;this.src='https://placehold.co/96x96/1c1917/f5f5f4?text=No+Img';">
                                    <div>
                                        <p class="text-sm text-gray-400">On <strong>${currentMonth} ${currentDay}</strong>, ${album.year}, the track...</p>
                                        <p class="text-lg font-bold text-gray-100">"${featured.title}"</p>
                                        <p class="text-sm text-gray-400">from the album <strong>${album.albumTitle}</strong> by <strong>${album.artist}</strong> was recorded.</p>
                                    </div>
                                </div>
                            </div>
                        `;
                        onThisDayContainer.addEventListener('click', () => {
                            const albumIndex = this.state.visibleAlbums.findIndex(a => a.albumTitle === album.albumTitle && a.artist === album.artist);
                            if (albumIndex !== -1) {
                                this.methods.openAlbumModal(this.state.visibleAlbums[albumIndex], albumIndex);
                            } else {
                                const mainIndex = this.state.albums.findIndex(a => a.albumTitle === album.albumTitle && a.artist === album.artist);
                                if (mainIndex !== -1) {
                                     this.methods.openAlbumModal(this.state.albums[mainIndex], -1);
                                }
                            }
                        });
                    } else {
                        onThisDayContainer.innerHTML = `
                             <div class="p-4 bg-gray-800 border border-gray-700 rounded-lg shadow-lg">
                                <h4 class="text-2xl text-gray-200 mb-2 transform -rotate-1 inline-block bg-yellow-400 text-gray-900 px-2">On This Day In Jazz...</h4>
                                <p class="text-center text-gray-400 mt-4">No landmark tracks were recorded on this day in our database. Check back tomorrow!</p>
                            </div>
                        `;
                    }
                },

                renderInfluenceWeb() {
                    const canvas = document.getElementById('influence-web-canvas');
                    if (!canvas) return;
                    canvas.innerHTML = '';
                    
                    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                    svg.id = 'influence-web-svg';
                    canvas.appendChild(svg);

                    const slugify = this.methods.slugify;
                    const nodes = {
                        // Main Hexagonal Paths
                        neoBop: { id: 'neoBop', pathId: 'neoBop', label: 'Neo-Bop', color: 'var(--genre-bebop)', pos: { x: 50, y: 12 }, isSubGenre: false },
                        spiritual: { id: 'spiritual', pathId: 'spiritual', label: 'Spiritual', color: 'var(--genre-free-jazz)', pos: { x: 80, y: 35 }, isSubGenre: false },
                        afroJazz: { id: 'afroJazz', pathId: 'afroJazz', label: 'Afro-Jazz', color: 'var(--genre-hard-bop)', pos: { x: 80, y: 65 }, isSubGenre: false },
                        avantGarde: { id: 'avantGarde', pathId: 'avantGarde', label: 'Avant-Garde', color: 'var(--genre-avant-garde)', pos: { x: 50, y: 88 }, isSubGenre: false },
                        jazzFusion: { id: 'jazzFusion', pathId: 'electric', label: 'Fusion', color: 'var(--genre-jazz-fusion)', pos: { x: 20, y: 65 }, isSubGenre: false },
                        melodic: { id: 'melodic', pathId: 'melodic', label: 'Melodic', color: 'var(--genre-cool-jazz)', pos: { x: 20, y: 35 }, isSubGenre: false },

                        // Album Moons
                        ef1: { id: 'ef1', label: 'The Inner Mounting Flame (1971)', parent: 'jazzFusion', angle: 240, dist: 14, isSubGenre: true },
                        ef2: { id: 'ef2', label: 'Head Hunters (1973)', parent: 'jazzFusion', angle: 180, dist: 14, isSubGenre: true },
                        ef3: { id: 'ef3', label: 'Get Up With It (1974)', parent: 'jazzFusion', angle: 120, dist: 14, isSubGenre: true },
                        
                        sp1: { id: 'sp1', label: 'Journey in Satchidananda (1971)', parent: 'spiritual', angle: 300, dist: 14, isSubGenre: true },
                        sp2: { id: 'sp2', label: 'Black Unity (1972)', parent: 'spiritual', angle: 0, dist: 14, isSubGenre: true },
                        sp3: { id: 'sp3', label: 'Godspelized (1997)', parent: 'spiritual', angle: 60, dist: 14, isSubGenre: true },
                        
                        aj1: { id: 'aj1', label: 'Blackstone Legacy (1971)', parent: 'afroJazz', angle: 0, dist: 14, isSubGenre: true },
                        aj2: { id: 'aj2', label: 'King of Kings (1974)', parent: 'afroJazz', angle: 60, dist: 14, isSubGenre: true },
                        aj3: { id: 'aj3', label: 'Bap-Tizum (1972)', parent: 'afroJazz', angle: 120, dist: 14, isSubGenre: true },

                        ag1: { id: 'ag1', label: 'Science Fiction (1972)', parent: 'avantGarde', angle: 60, dist: 14, isSubGenre: true },
                        ag2: { id: 'ag2', label: 'Ask the Ages (1991)', parent: 'avantGarde', angle: 120, dist: 14, isSubGenre: true },
                        ag3: { id: 'ag3', label: 'Coin Coin Chapter One (2011)', parent: 'avantGarde', angle: 180, dist: 14, isSubGenre: true },

                        mp1: { id: 'mp1', label: 'Return to Forever (1972)', parent: 'melodic', angle: 180, dist: 14, isSubGenre: true },
                        mp2: { id: 'mp2', label: 'The Köln Concert (1975)', parent: 'melodic', angle: 240, dist: 14, isSubGenre: true },
                        mp3: { id: 'mp3', label: 'Pat Metheny Group (1978)', parent: 'melodic', angle: 300, dist: 14, isSubGenre: true },
                        
                        nb1: { id: 'nb1', label: 'Scenery (1976)', parent: 'neoBop', angle: 240, dist: 14, isSubGenre: true },
                        nb2: { id: 'nb2', label: 'Eastern Rebellion (1976)', parent: 'neoBop', angle: 300, dist: 14, isSubGenre: true },
                        nb3: { id: 'nb3', label: 'Black Codes (1985)', parent: 'neoBop', angle: 0, dist: 14, isSubGenre: true },
                    };

                    Object.values(nodes).forEach(node => {
                        const nodeEl = document.createElement('div');
                        nodeEl.className = 'influence-node';
                        if (node.isSubGenre) {
                            nodeEl.classList.add('sub-genre');
                            const parentNode = nodes[node.parent];
                            const angleRad = (node.angle - 90) * (Math.PI / 180);
                            node.pos = {
                                x: parentNode.pos.x + node.dist * Math.cos(angleRad),
                                y: parentNode.pos.y + node.dist * Math.sin(angleRad)
                            };
                        }
                        nodeEl.id = `node-${node.id}`;
                        nodeEl.style.left = `${node.pos.x}%`;
                        nodeEl.style.top = `${node.pos.y}%`;
                        
                        if (!node.isSubGenre) {
                           nodeEl.dataset.pathId = node.pathId;
                        }
                        
                        const labelEl = document.createElement('span');
                        labelEl.className = 'node-label';
                        labelEl.textContent = node.label;
                        if (node.color) {
                            labelEl.style.backgroundColor = node.color;
                            labelEl.style.color = 'var(--text-main)';
                        }
                        
                        nodeEl.innerHTML = `<img src="${node.img || 'images/artistplaceholder.jpg'}" class="node-image" onerror="this.onerror=null;this.src='images/artistplaceholder.jpg';">`;
                        nodeEl.appendChild(labelEl);
                        canvas.appendChild(nodeEl);
                    });
                    
                    document.querySelectorAll('.influence-node:not(.sub-genre)').forEach(node => {
                        node.addEventListener('click', () => {
                            this.methods.openPathModal(node.dataset.pathId);
                        });
                    });

                    setTimeout(() => this.methods.drawInfluenceLines(), 50);
                },

                drawInfluenceLines() {
                    const canvas = document.getElementById('influence-web-canvas');
                    const svg = document.getElementById('influence-web-svg');
                    if (!canvas || !svg) return;
                    
                    svg.innerHTML = '';
                    
                    const mainPathIds = ['neoBop', 'spiritual', 'afroJazz', 'avantGarde', 'jazzFusion', 'melodic'];
                    const mainPathPoints = mainPathIds.map(id => {
                        const el = document.getElementById(`node-${id}`);
                        return `${el.offsetLeft + el.offsetWidth / 2},${el.offsetTop + el.offsetHeight / 2}`;
                    }).join(' ');

                    const hexagon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                    hexagon.setAttribute('points', mainPathPoints);
                    svg.appendChild(hexagon);

                    const connections = [
                        ['neoBop', 'nb1'], ['neoBop', 'nb2'], ['neoBop', 'nb3'],
                        ['spiritual', 'sp1'], ['spiritual', 'sp2'], ['spiritual', 'sp3'],
                        ['afroJazz', 'aj1'], ['afroJazz', 'aj2'], ['afroJazz', 'aj3'],
                        ['avantGarde', 'ag1'], ['avantGarde', 'ag2'], ['avantGarde', 'ag3'],
                        ['jazzFusion', 'jf1'], ['jazzFusion', 'jf2'], ['jazzFusion', 'jf3'],
                        ['melodic', 'mp1'], ['melodic', 'mp2'], ['melodic', 'mp3'],
                    ];

                    connections.forEach(conn => {
                        const el1 = document.getElementById(`node-${conn[0]}`);
                        const el2 = document.getElementById(`node-${conn[1]}`);
                        if (el1 && el2) {
                            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                            line.setAttribute('x1', el1.offsetLeft + el1.offsetWidth / 2);
                            line.setAttribute('y1', el1.offsetTop + el1.offsetHeight / 2);
                            line.setAttribute('x2', el2.offsetLeft + el2.offsetWidth / 2);
                            line.setAttribute('y2', el2.offsetTop + el2.offsetHeight / 2);
                            svg.appendChild(line);
                        }
                    });
                },
                
                setupPanAndZoom() {
                    // Pan and zoom functionality is disabled as per user request.
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => JazzApp.init());
    </script>
</body>
</html>
