<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controlled Freedom: An Interactive History of Post-Bop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1e293b; /* slate-800 */
            color: #d1d5db; /* slate-300 */
        }
        h1, h2, h3, h4, h5 {
            font-family: 'Lora', serif;
            font-weight: 600;
        }
        .nav-link {
            transition: color 0.2s;
        }
        .nav-link:hover, .nav-link.active {
            color: #38bdf8; /* sky-400 */
        }
        .year-marker {
            transition: background-color 0.2s, color 0.2s;
        }
        .year-marker.active {
            background-color: #0ea5e9; /* sky-500 */
            color: #0f172a;
        }
        .matrix-table th, .matrix-table td {
            transition: background-color 0.2s;
        }
        .matrix-table .highlight {
            background-color: #334155; /* slate-700 */
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        .loader {
            border: 4px solid #475569; /* slate-600 */
            border-top: 4px solid #38bdf8; /* sky-400 */
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #horizontal-timeline-container {
            width: 100%;
            overflow-x: auto;
            padding-bottom: 2rem;
            cursor: grab;
            border-top: 1px solid #334155;
            border-bottom: 1px solid #334155;
            background: #1e293b;
            /* Hide scrollbar for a cleaner look */
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        #horizontal-timeline-container::-webkit-scrollbar {
            display: none; /* Chrome, Safari and Opera */
        }
        #horizontal-timeline-container:active {
            cursor: grabbing;
        }
        #timeline-wrapper {
            display: inline-flex;
            align-items: flex-start;
            padding: 2rem 1rem;
        }
        .timeline-year-section {
            display: flex;
            flex-shrink: 0;
            flex-direction: column;
            align-items: flex-start; /* Changed from center to flex-start */
            border-left: 2px dashed #475569;
            padding: 0 2rem;
        }
        .timeline-year-section:first-child {
            border-left: none;
        }
        .timeline-year-header {
            font-size: 2.5rem;
            font-weight: 900;
            color: #475569;
            margin-bottom: 1.5rem;
            width: 100%;
            text-align: left; /* Explicitly align text to the left */
        }
        .timeline-album-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1.5rem;
        }
        .timeline-album-card {
            width: 200px;
            flex-shrink: 0;
            background-color: #334155;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border: 1px solid transparent;
            overflow: hidden;
        }
        .timeline-album-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0,0,0,0.3);
            border-color: #38bdf8;
        }
        .timeline-album-card img {
             width: 100%;
             height: 200px;
             object-fit: cover;
        }
        .timeline-album-card-info {
            padding: 0.75rem;
        }
        .timeline-album-card-info h5 {
            color: #e2e8f0; /* slate-200 */
        }
        .timeline-album-card-info p {
            color: #94a3b8; /* slate-400 */
        }
         #loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(30, 41, 59, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: #d1d5db;
            font-size: 1.25rem;
        }
    </style>
</head>
<body class="bg-slate-800 text-slate-300">
    <div id="loading-indicator">
        <div class="loader mr-4"></div>
        <span>Loading Application...</span>
    </div>

    <header class="bg-slate-900/80 backdrop-blur-md sticky top-0 z-50 shadow-md shadow-black/20">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <h1 class="text-xl md:text-2xl font-bold text-sky-400 tracking-tight">Controlled Freedom</h1>
                <div class="hidden sm:flex sm:items-baseline sm:space-x-8">
                    <a href="#overview" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-slate-400">Overview</a>
                    <a href="#timeline" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-slate-400">Timeline</a>
                    <a href="#matrix" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-slate-400">Genres</a>
                    <a href="#architects" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-slate-400">Artists</a>
                    <a href="#legacy" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-slate-400">Legacy</a>
                </div>
                 <div class="sm:hidden">
                    <select id="mobile-nav" class="block w-full rounded-md border-slate-600 bg-slate-700 text-slate-300 py-2 pl-3 pr-10 text-base focus:border-sky-500 focus:outline-none focus:ring-sky-500 sm:text-sm">
                        <option value="#overview">Overview</option>
                        <option value="#timeline">Timeline</option>
                        <option value="#matrix">Genres</option>
                        <option value="#architects">Artists</option>
                        <option value="#legacy">Legacy</option>
                    </select>
                </div>
            </div>
        </nav>
    </header>

    <main>
        <section id="overview" class="py-16 sm:py-20">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-4xl">
                <h2 class="text-4xl font-bold text-center mb-4 text-sky-400">The Birth of Post-Bop</h2>
                <p class="text-center text-lg text-slate-400 mb-12">An exploration into the innovative era of "controlled freedom" that redefined jazz between 1958 and 1967.</p>
                <div class="space-y-6 text-lg leading-relaxed text-slate-300">
                    <p>The term "post-bop" is a retrospective label for a musical methodology that flourished in the late 1950s and 1960s. It wasn't a genre with rigid rules, but a shared philosophy of <strong class="text-sky-400">"controlled freedom."</strong> Musicians of this era sought a middle ground between the structured harmony of hard bop and the radical abandon of free jazz. They aimed to expand the expressive possibilities of jazz by incorporating harmonic ambiguity and rhythmic complexity without completely discarding form and melody.</p>
                    <p>This application provides an interactive journey through this pivotal decade. You can explore a year-by-year timeline of landmark albums, compare the core tenets of post-bop against its contemporary styles, and visualize the contributions of its key architects. It's a tool designed to make the dense, interconnected history of this music accessible and engaging.</p>
                </div>
            </div>
        </section>

        <section id="timeline" class="py-16 sm:py-20 bg-slate-900">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-4xl font-bold text-center mb-4 text-sky-400">Timeline Explorer</h2>
                <p class="text-center text-lg text-slate-400 mb-12 max-w-3xl mx-auto">Click a year to navigate the timeline, then click an album cover to see the full analysis.</p>
                
                <div class="flex items-center justify-center gap-4 mb-12">
                     <div id="timeline-nav" class="flex flex-wrap justify-center gap-2">
                     </div>
                </div>
                
                <div class="relative group">
                    <div id="horizontal-timeline-container">
                        <div id="timeline-wrapper"></div>
                    </div>
                    <button id="scroll-left-btn" class="absolute left-0 sm:left-2 top-1/2 -translate-y-1/2 z-10 p-2 rounded-full bg-slate-800/50 hover:bg-sky-500 text-slate-300 hover:text-slate-900 transition-all opacity-0 group-hover:opacity-100 disabled:opacity-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                    </button>
                    <button id="scroll-right-btn" class="absolute right-0 sm:right-2 top-1/2 -translate-y-1/2 z-10 p-2 rounded-full bg-slate-800/50 hover:bg-sky-500 text-slate-300 hover:text-slate-900 transition-all opacity-0 group-hover:opacity-100 disabled:opacity-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                    </button>
                </div>

            </div>
        </section>

        <section id="matrix" class="py-16 sm:py-20 bg-slate-800">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-4xl font-bold text-center mb-4 text-sky-400">The Genres</h2>
                <p class="text-center text-lg text-slate-400 mb-12 max-w-3xl mx-auto">Understand what makes post-bop unique by comparing it to its stylistic neighbors. Hover over a style (column) or a musical feature (row) to highlight and compare the distinct approaches to harmony, rhythm, and form.</p>
                <div class="overflow-x-auto">
                    <table id="style-matrix-table" class="matrix-table w-full min-w-[800px] border-collapse text-left">
                        <thead>
                            <tr>
                                <th class="p-4 border-b-2 border-slate-600 font-bold text-lg">Feature</th>
                                <th class="p-4 border-b-2 border-slate-600 font-bold text-lg text-center">Hard Bop</th>
                                <th class="p-4 border-b-2 border-slate-600 font-bold text-lg text-center">Modal Jazz</th>
                                <th class="p-4 border-b-2 border-slate-600 font-bold text-lg text-center bg-sky-900/20">Post-Bop</th>
                                <th class="p-4 border-b-2 border-slate-600 font-bold text-lg text-center">Free Jazz</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="architects" class="py-16 sm:py-20 bg-slate-900">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-4xl font-bold text-center mb-4 text-sky-400">The Artists</h2>
                <p class="text-center text-lg text-slate-400 mb-12 max-w-3xl mx-auto">The post-bop sound was forged by visionary bandleaders and nurtured by a uniquely supportive record label. This chart visualizes the relative contributions of these key artists across several dimensions of innovation, from compositional complexity to cultural impact.</p>
                <div class="chart-container">
                    <canvas id="architectsChart"></canvas>
                </div>
            </div>
        </section>
        
        <section id="legacy" class="py-16 sm:py-20 bg-slate-800">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-4xl">
                <h2 class="text-4xl font-bold text-center mb-4 text-sky-400">Legacy and Dissolution</h2>
                 <p class="text-center text-lg text-slate-400 mb-12">How a golden age splintered into new forms, leaving an indelible mark on the future of music.</p>
                <div class="space-y-6 text-lg leading-relaxed text-slate-300">
                    <p>The golden age of acoustic innovation from 1958 to 1967 was a period of intense, shared creativity. However, by its end, the cohesive center of post-bop began to dissolve. The death of John Coltrane in 1967 removed a spiritual and musical lodestar. Simultaneously, Miles Davis began incorporating electric instruments and rock-influenced rhythms, paving the way for jazz-rock fusion with albums like *In a Silent Way* and *Bitches Brew*. This seismic shift created a new mainstream that would dominate the 1970s.</p>
                    <p>Yet, the legacy of post-bop is profound. Its harmonic, rhythmic, and compositional innovations became a permanent part of the modern jazz vocabulary. In the 1980s, the "Young Lions" movement, led by trumpeter Wynton Marsalis, sparked a "post-bop revival" that looked directly back to the acoustic, small-group aesthetic of the 1960s. This cemented the 1958-1967 period as a classic era, and its language remains the primary foundation for much of the acoustic jazz being played today.</p>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-slate-900 text-slate-400 py-8">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p>An interactive exploration based on the "Chronological Encyclopedia of Post-Bop (1958-1967)".</p>
            <p class="text-sm text-slate-500 mt-2">Designed to bring music history to life through interactive data visualization.</p>
        </div>
    </footer>

    <div id="album-modal" class="modal fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div id="modal-content" class="modal-content bg-slate-800 border border-slate-600 rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col transform scale-95">
            <div class="flex justify-between items-start p-4 border-b border-slate-600 flex-shrink-0">
                 <div>
                    <h3 id="modal-title" class="text-2xl font-bold text-sky-400"></h3>
                    <p id="modal-artist" class="text-md text-slate-400"></p>
                </div>
                <button id="close-modal" class="text-2xl font-bold p-2 leading-none text-slate-500 hover:text-white">&times;</button>
            </div>
            <div id="modal-body" class="p-6 overflow-y-auto">
                <div class="flex flex-col md:flex-row gap-6 mb-6 pb-6 border-b border-slate-700">
                    <div id="modal-album-art-container" class="w-full md:w-1/3 flex-shrink-0">
                         <img id="modal-album-art" src="" class="w-full h-auto rounded-md shadow-lg" alt="">
                    </div>
                    <div id="modal-album-details" class="w-full md:w-2/3">
                    </div>
                </div>
                <div id="modal-analysis-section">
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, setDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE SETUP ---
        // These global variables are provided by the Canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'post-bop-history';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const styleMatrixData = [ { feature: 'Harmony', hardBop: 'Functional, blues-based, strong resolutions. Often uses standard song progressions.', modalJazz: 'Static or slow-moving. Based on scales (modes) rather than chord progressions.', postBop: 'Ambiguous, non-functional. Use of complex, altered, and non-diatonic chords.', freeJazz: 'Often atonal. Harmony is spontaneous, with no pre-determined structure.' }, { feature: 'Rhythm', hardBop: 'Strong, driving backbeat. Often danceable, funky, and groove-oriented.', modalJazz: 'Open, spacious, and contemplative. Slower tempos are common.', postBop: 'Interactive, conversational. Use of mixed and irregular meters; time is fluid.', freeJazz: 'Often abandons fixed meter and tempo. Focus on collective rhythmic texture.' }, { feature: 'Form', hardBop: 'Standard forms (12-bar blues, 32-bar AABA). Head-Solo-Head structure.', modalJazz: 'Simple, open-ended structures, often based on a single mode or a few modes.', postBop: 'Complex, abstract, flexible, and original forms. Band members are featured composers.', freeJazz: 'Often abandons pre-set forms entirely in favor of spontaneous improvisation.' }, { feature: 'Improvisation', hardBop: 'Soloists outline chord changes, often with bluesy, soulful phrasing.', modalJazz: 'Melodic development over scales, exploring the character of a mode.', postBop: '"Inside/Outside" playing; use of pentatonics, substitutions, and motivic development.', freeJazz: 'Collective, textural improvisation. Focus on sound, timbre, and emotional intensity.' } ];

        // --- APPLICATION LOGIC ---
        document.addEventListener('DOMContentLoaded', async () => {
            const loadingIndicator = document.getElementById('loading-indicator');
            try {
                // Authenticate the user
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                console.log("Authentication successful.");

                // Fetch data from Firestore (and seed if necessary)
                loadingIndicator.querySelector('span').textContent = 'Fetching album data...';
                const albums = await getAlbumsFromFirestore();
                
                // Once data is loaded, render the application
                loadingIndicator.querySelector('span').textContent = 'Rendering application...';
                initializeAppUI(albums);

            } catch (error) {
                console.error("Initialization Error:", error);
                loadingIndicator.textContent = "Error loading application. Please refresh the page.";
            } finally {
                // Hide loading indicator
                loadingIndicator.style.display = 'none';
            }
        });

        // --- FIRESTORE DATA FUNCTIONS ---
        async function getAlbumsFromFirestore() {
            const albumsColRef = collection(db, `artifacts/${appId}/public/data/albums`);
            const snapshot = await getDocs(albumsColRef);

            if (snapshot.empty) {
                console.log("No data found in Firestore. Seeding data...");
                document.getElementById('loading-indicator').querySelector('span').textContent = 'Performing first-time data setup...';
                await seedDataToFirestore();
                // Fetch again after seeding
                const newSnapshot = await getDocs(albumsColRef);
                return processSnapshot(newSnapshot);
            } else {
                console.log("Data found in Firestore. Loading...");
                return processSnapshot(snapshot);
            }
        }
        
        function processSnapshot(snapshot) {
            const albums = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                albums.push({
                    ...data,
                    // IMPORTANT: Parse the tracks from the JSON string
                    pivotalTracks: JSON.parse(data.pivotalTracks || '[]')
                });
            });
            return albums;
        }

        async function seedDataToFirestore() {
            // This raw data is now only used for the one-time seeding process.
            const rawTrackData = [
                { year: 1958, artist: "Thelonious Monk Quartet", title: "Misterioso", album: "Misterioso", cover: "images/misterioso.jpg", recordingDate: "August 7, 1958", location: "Five Spot Café, New York City, NY", label: "Riverside", lineup: "Thelonious Monk (piano), Johnny Griffin (tenor saxophone), Ahmed Abdul-Malik (bass), Roy Haynes (drums)", composer: "Thelonious Monk", analysis: "Captured during a legendary residency at the Five Spot Café, this recording showcases Thelonious Monk's pivotal role in the adventurous evolution of hard bop. 'Misterioso' is a 12-bar blues, but in Monk's hands, the familiar structure becomes a vehicle for profound innovation. His angular, dissonant piano work and idiosyncratic use of silence challenge bop conventions from the inside out. Supported by the fiery tenor saxophone of Johnny Griffin, Monk demonstrates how a master improviser could deconstruct traditional forms in a live setting, turning a standard into a complex, unpredictable, and thoroughly modern statement." },
                { year: 1958, artist: "Sun Ra and His Arkestra", title: "Saturn", album: "Jazz in Silhouette", cover: "images/jazz-in-silhouette.jpg", recordingDate: "c. late 1958", location: "El Saturn Studios, Chicago, IL", label: "El Saturn Records", lineup: "Sun Ra (piano), Hobart Dotson (trumpet), Marshall Allen (alto saxophone), James Spaulding (alto saxophone), John Gilmore (tenor saxophone), Pat Patrick (baritone saxophone), Charles Davis (baritone saxophone), Julian Priester (trombone), Victor Sproles (bass), William 'Bugs' Cochran (drums)", composer: "Sun Ra", analysis: "With 'Saturn,' Sun Ra officially plants the flag for a new cosmic consciousness in jazz. While the piece is rooted in the swing and bop traditions of an orchestra, its theme, propelled by an insistent and otherworldly rhythm, signals a definitive break. This track is a key early document of Afrofuturism and a foundational text for what would become spiritual jazz. By blending familiar big band precision with visionary concepts, 'Saturn' acts as a bridge from the known world to the outer realms the Arkestra would explore, prefiguring the avant-garde and free jazz movements of the coming decade." },
                { year: 1959, artist: "Charles Mingus", title: "Moanin'", album: "Blues & Roots", cover: "images/blues-&-roots.jpg", recordingDate: "February 4, 1959", location: "Atlantic Studios, New York City, NY", label: "Atlantic", lineup: "Charles Mingus (bass), Jackie McLean (alto saxophone), John Handy (alto saxophone), Booker Ervin (tenor saxophone), Pepper Adams (baritone saxophone), Jimmy Knepper (trombone), Willie Dennis (trombone), Horace Parlan (piano), Dannie Richmond (drums)", composer: "Charles Mingus", analysis: "This track is a visceral manifesto for Mingus's vision of jazz as a deeply rooted art form. In a direct response to critics who found his music overly complex, Mingus created a work of stunning, elemental power. 'Moanin'' is built on a simple, earthy baritone saxophone riff that becomes a platform for layered, blues-drenched horns and shouting exhortations. This is a key example of the adventurous evolution of hard bop, as Mingus injects the genre with the raw fervor of a sanctified church service, creating a sound that is simultaneously sophisticated in its arrangement and profoundly primal in its emotional impact." },
                { year: 1959, artist: "Charles Mingus", title: "Better Git It in Your Soul", album: "Mingus Ah Um", cover: "images/mingus-ah-um.jpg", recordingDate: "May 5, 1959", location: "Columbia 30th Street Studio, New York City, NY", label: "Columbia", lineup: "Charles Mingus (bass), John Handy (alto saxophone), Booker Ervin (tenor saxophone), Shafi Hadi (tenor saxophone), Willie Dennis (trombone), Jimmy Knepper (trombone), Horace Parlan (piano), Dannie Richmond (drums)", composer: "Charles Mingus", analysis: "An explosive opening to one of jazz's most celebrated albums, 'Better Git It in Your Soul' is pure, unadulterated Mingus. Propelled by a hand-clapping, gospel-infused 6/8 time signature, the track erupts with joyous chaos that blurs the line between tight composition and ecstatic collective improvisation. It perfectly encapsulates the increasingly complex and adventurous evolution of hard bop, pushing the music's emotional and structural boundaries. The shouts, hollers, and fiery solos create a work that feels both sacred and wildly secular, prefiguring the spiritual jazz movement while remaining fiercely unique." },
                { year: 1959, artist: "Ornette Coleman", title: "Lonely Woman", album: "The Shape of Jazz to Come", cover: "images/the-shape-of-jazz-to-come.jpg", recordingDate: "May 22, 1959", location: "Radio Recorders, Hollywood, CA", label: "Atlantic", lineup: "Ornette Coleman (alto saxophone), Don Cherry (cornet), Charlie Haden (bass), Billy Higgins (drums)", composer: "Ornette Coleman", analysis: "With 'Lonely Woman,' Ornette Coleman officially announced the arrival of the avant-garde as a powerful new language for jazz. The track was revolutionary in its structure: Coleman's achingly lyrical saxophone and Don Cherry's trumpet float a haunting melody completely independent of the frantic, propulsive rhythm set by bassist Charlie Haden and drummer Billy Higgins. By untethering melody from harmony and rhythm, Coleman established that profound feeling could be conveyed without adhering to traditional chord changes. It is a foundational moment for free jazz, demonstrating a new path for improvisation based on pure melodic and emotional logic." },
                // ... (The rest of the rawTrackData array would be here) ...
                 { year: 1967, artist: "McCoy Tyner", title: "Mode To John", album: "Tender Moments", cover: "images/tender-moments.jpg", recordingDate: "December 1, 1967", location: "Van Gelder Studio, Englewood Cliffs, NJ", label: "Blue Note", lineup: "McCoy Tyner (piano), Lee Morgan (trumpet), Julian Priester (trombone), Bob Northern (french horn), Howard Johnson (tuba), James Spaulding (alto saxophone, flute), Bennie Maupin (tenor saxophone), Herbie Lewis (bass), Joe Chambers (drums)", composer: "McCoy Tyner", analysis: "Recorded just months after John Coltrane's passing, this piece is a direct and powerful elegy from his most influential disciple. Using the powerful modal language they had pioneered together, McCoy Tyner crafts a soaring, emotional, and deeply felt tribute to his friend and former leader. It is a pivotal and poignant conclusion to the decade's narrative: a final, heartfelt look back from a master who would carry the spiritual and musical legacy of John Coltrane into the future." }
            ];
            
            const albumsToSeed = rawTrackData.reduce((acc, track) => {
                let album = acc.find(a => a.albumTitle === track.album && a.artist === track.artist);
                if (!album) {
                    album = {
                        year: track.year,
                        artist: track.artist,
                        albumTitle: track.album,
                        cover: track.cover,
                        pivotalTracks: []
                    };
                    acc.push(album);
                }
                album.pivotalTracks.push(track);
                return acc;
            }, []);

            const batch = writeBatch(db);
            albumsToSeed.forEach(album => {
                const docId = `${album.artist}-${album.albumTitle}`.replace(/[^a-zA-Z0-9-]/g, '').toLowerCase();
                const docRef = doc(db, `artifacts/${appId}/public/data/albums`, docId);
                const dataToSet = {
                    year: album.year,
                    artist: album.artist,
                    albumTitle: album.albumTitle,
                    cover: album.cover,
                    pivotalTracks: JSON.stringify(album.pivotalTracks) // Serialize the tracks array
                };
                batch.set(docRef, dataToSet);
            });
            await batch.commit();
            console.log("Database seeded successfully.");
        }


        // --- UI INITIALIZATION ---
        function initializeAppUI(albums) {
            const timelineNav = document.getElementById('timeline-nav');
            const timelineContainer = document.getElementById('horizontal-timeline-container');
            const timelineWrapper = document.getElementById('timeline-wrapper');
            const scrollLeftBtn = document.getElementById('scroll-left-btn');
            const scrollRightBtn = document.getElementById('scroll-right-btn');

             // --- DATA PROCESSING ---
            const monthMap = { "January": 0, "February": 1, "March": 2, "April": 3, "May": 4, "June": 5, "July": 6, "August": 7, "September": 8, "October": 9, "November": 10, "December": 11 };
            
            function parseDate(dateString) {
                if (typeof dateString !== 'string') return null;
                if (dateString.startsWith('c.')) {
                    const year = parseInt(dateString.split(' ').pop());
                    return new Date(year, 11, 31);
                }
                const parts = dateString.replace(/,/g, '').split(' ');
                if (parts.length === 3 && monthMap.hasOwnProperty(parts[0])) return new Date(parts[2], monthMap[parts[0]], parts[1]);
                if (parts.length === 2 && monthMap.hasOwnProperty(parts[0])) return new Date(parts[1], monthMap[parts[0]], 15);
                if (parts.length === 1 && !isNaN(parts[0])) return new Date(parts[0], 0, 1);
                if (!isNaN(new Date(dateString))) return new Date(dateString);
                return null;
            }

            // Augment album data with genres
            albums.forEach(album => {
                const allAnalyses = album.pivotalTracks.map(t => t.analysis.toLowerCase()).join(' ');
                const genres = new Set();
                if (allAnalyses.includes('modal jazz')) genres.add('Modal Jazz');
                if (allAnalyses.includes('hard bop')) genres.add('Hard Bop');
                if (allAnalyses.includes('free jazz')) genres.add('Free Jazz');
                if (allAnalyses.includes('avant-garde')) genres.add('Avant-Garde');
                if (allAnalyses.includes('spiritual jazz')) genres.add('Spiritual Jazz');
                if (allAnalyses.includes('soul jazz')) genres.add('Soul Jazz');
                if (genres.size === 0) genres.add('Post-Bop'); // Default genre
                album.genres = Array.from(genres);
                album.firstRecordingDate = album.pivotalTracks[0].recordingDate;
            });
            
            albums.sort((a,b) => parseDate(a.firstRecordingDate) - parseDate(b.firstRecordingDate));
            const years = [...new Set(albums.map(album => album.year))].sort();

            const groupedByYear = years.reduce((acc, year) => {
                acc[year] = albums.filter(d => d.year === year);
                return acc;
            }, {});

            // --- TIMELINE RENDERING ---
            timelineWrapper.innerHTML = '';
            
            years.forEach(year => {
                const yearSection = document.createElement('div');
                yearSection.className = 'timeline-year-section';
                yearSection.id = `year-${year}`;

                const yearHeader = document.createElement('div');
                yearHeader.className = 'timeline-year-header';
                yearHeader.textContent = year;
                yearSection.appendChild(yearHeader);

                const albumList = document.createElement('div');
                albumList.className = 'timeline-album-list';
                
                groupedByYear[year].forEach(album => {
                    const card = document.createElement('div');
                    card.className = 'timeline-album-card';
                    card.dataset.albumTitle = album.albumTitle;
                    card.dataset.artist = album.artist;
                    card.innerHTML = `
                        <img src="${album.cover}" alt="Cover for ${album.albumTitle}" onerror="this.onerror=null;this.src='https://placehold.co/200x200/334155/94a3b8?text=No+Image';">
                        <div class="timeline-album-card-info">
                            <h5 class="font-bold truncate text-sm">${album.albumTitle}</h5>
                            <p class="text-xs truncate">${album.artist}</p>
                        </div>
                    `;
                    albumList.appendChild(card);
                });
                
                yearSection.appendChild(albumList);
                timelineWrapper.appendChild(yearSection);
            });
            
            years.forEach(year => {
                const yearButton = document.createElement('button');
                yearButton.textContent = year;
                yearButton.dataset.year = year;
                yearButton.className = 'year-marker px-4 py-2 text-sm font-semibold rounded-full bg-slate-700 text-slate-300 hover:bg-sky-500 hover:text-slate-900';
                yearButton.addEventListener('click', () => {
                    document.querySelectorAll('.year-marker').forEach(btn => btn.classList.remove('active'));
                    yearButton.classList.add('active');
                    const yearSection = document.getElementById(`year-${year}`);
                    if(yearSection) {
                        timelineContainer.scrollTo({
                            left: yearSection.offsetLeft - 32,
                            behavior: 'smooth'
                        });
                    }
                });
                timelineNav.appendChild(yearButton);
            });

            if (timelineNav.firstElementChild) {
                timelineNav.firstElementChild.classList.add('active');
            }
            
            // --- TIMELINE SCROLLING LOGIC ---
            const scrollAmount = 400; // Amount to scroll with arrows
            scrollLeftBtn.addEventListener('click', () => {
                timelineContainer.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
            });
            scrollRightBtn.addEventListener('click', () => {
                timelineContainer.scrollBy({ left: scrollAmount, behavior: 'smooth' });
            });


            // --- MODAL LOGIC ---
            const modal = document.getElementById('album-modal');
            const modalContent = document.getElementById('modal-content');

            timelineWrapper.addEventListener('click', e => {
                const card = e.target.closest('.timeline-album-card');
                if (card) {
                    const { albumTitle, artist } = card.dataset;
                    const album = albums.find(a => a.albumTitle === albumTitle && a.artist === artist);
                    if (album) openModal(album);
                }
            });

            function openModal(album) {
                // Set text content
                document.getElementById('modal-title').textContent = album.albumTitle;
                document.getElementById('modal-artist').textContent = album.artist;

                // Set image source
                const modalImg = document.getElementById('modal-album-art');
                modalImg.src = album.cover;
                modalImg.alt = `Cover for ${album.albumTitle}`;
                modalImg.onerror = function() { this.onerror=null; this.src='https://placehold.co/400x400/334155/94a3b8?text=No+Image'; };

                // Populate details section
                const firstTrack = album.pivotalTracks[0];
                const detailsContainer = document.getElementById('modal-album-details');
                detailsContainer.innerHTML = `
                    <h4 class="text-xl font-bold font-lora mb-3 text-sky-400">Album Details</h4>
                    <ul class="text-sm space-y-1.5">
                        <li><strong class="font-semibold text-slate-300 w-32 inline-block flex-shrink-0">Genres:</strong> ${album.genres.join(', ')}</li>
                        <li><strong class="font-semibold text-slate-300 w-32 inline-block flex-shrink-0">Recording Date:</strong> ${firstTrack.recordingDate}</li>
                        <li><strong class="font-semibold text-slate-300 w-32 inline-block flex-shrink-0">Location:</strong> ${firstTrack.location}</li>
                        <li><strong class="font-semibold text-slate-300 w-32 inline-block flex-shrink-0">Label:</strong> ${firstTrack.label}</li>
                        <li><strong class="font-semibold text-slate-300 w-32 inline-block flex-shrink-0">Line-Up:</strong> ${firstTrack.lineup}</li>
                        <li><strong class="font-semibold text-slate-300 w-32 inline-block flex-shrink-0">Composer:</strong> ${firstTrack.composer}</li>
                    </ul>
                `;
                
                // Populate analysis section
                const analysisContainer = document.getElementById('modal-analysis-section');
                const pivotalTracksHtml = album.pivotalTracks.map(track => `
                    <div class="mb-6 pb-4 border-b border-slate-700 last:border-b-0 last:pb-0 last:mb-0">
                        <h5 class="font-bold text-lg text-slate-200">${track.title}</h5>
                        <p class="text-sm mt-2">${track.analysis}</p>
                    </div>`).join('');
                
                analysisContainer.innerHTML = `
                    <div>
                        <h4 class="text-xl font-bold font-lora mb-3 text-sky-400">Pivotal Tracks Analysis</h4>
                        ${pivotalTracksHtml}
                    </div>
                    <div class="border-t border-slate-700 mt-6 pt-4">
                         <button id="ai-analysis-btn" class="w-full sm:w-auto bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-500 transition-colors disabled:bg-slate-600 disabled:cursor-not-allowed">✨ Get AI Album Analysis</button>
                         <div id="ai-result-container" class="mt-4 p-4 bg-slate-700 rounded-lg border border-slate-600 min-h-[50px]"></div>
                    </div>
                `;
                
                // Add event listener for AI button
                const aiButton = analysisContainer.querySelector('#ai-analysis-btn');
                const aiResultContainer = analysisContainer.querySelector('#ai-result-container');
                aiResultContainer.innerHTML = '';
                aiButton.addEventListener('click', () => getAiAnalysis(album, aiButton, aiResultContainer));
                
                // Show modal
                modal.classList.remove('opacity-0', 'pointer-events-none');
                modalContent.classList.remove('scale-95');
            }
            
            function closeModal() {
                modal.classList.add('opacity-0', 'pointer-events-none');
                modalContent.classList.add('scale-95');
            }

            document.getElementById('close-modal').addEventListener('click', closeModal);
            modal.addEventListener('click', e => { if (e.target.id === 'album-modal') closeModal(); });
            document.addEventListener('keydown', e => { if (e.key === "Escape") closeModal(); });


            // --- AI ANALYSIS (GEMINI API) ---
            async function getAiAnalysis(album, buttonElement, resultContainer) {
                buttonElement.disabled = true;
                resultContainer.innerHTML = '<div class="flex justify-center items-center p-4"><div class="loader"></div></div>';
                let existingInfo = album.pivotalTracks.map(t => `Analysis for track '${t.title}': ${t.analysis}`).join('; ');
                const prompt = `You are a world-renowned musicologist and jazz critic. Provide a fresh, holistic analysis of the classic post-bop album "${album.albumTitle}" by ${album.artist}, recorded in ${album.year}. Synthesize the following track analyses into a cohesive overview of the album's significance: ${existingInfo}. Go beyond just summarizing. Discuss the album's overall mood, its place in the artist's discography, and its impact on the post-bop movement. Speculate on the emotional atmosphere in the studio or imagine how a modern listener might experience these sounds for the first time. Use vivid, descriptive language. Frame your analysis under the heading 'A Modern Listener's Perspective'.`;
                try {
                    let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = { contents: chatHistory };
                    const apiKey = ""; // API key is handled by the environment
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                    const result = await response.json();
                    if (result.candidates && result.candidates[0] && result.candidates[0].content.parts[0].text) {
                        resultContainer.innerHTML = result.candidates[0].content.parts[0].text.replace(/\n/g, '<br>');
                    } else { throw new Error('Invalid response structure from API.'); }
                } catch (error) {
                    console.error("Gemini API Error:", error);
                    resultContainer.innerHTML = `<p class="text-red-400">Sorry, the analysis could not be generated at this time. Please try again later.</p>`;
                } finally {
                    buttonElement.disabled = false;
                }
            }

            // --- STYLE MATRIX ---
            const matrixTableBody = document.querySelector('#style-matrix-table tbody');
            matrixTableBody.innerHTML = styleMatrixData.map(row => `
                <tr data-feature="${row.feature}">
                    <td class="p-4 border-b border-slate-700 font-semibold">${row.feature}</td>
                    <td class="p-4 border-b border-slate-700" data-style="Hard Bop">${row.hardBop}</td>
                    <td class="p-4 border-b border-slate-700" data-style="Modal Jazz">${row.modalJazz}</td>
                    <td class="p-4 border-b border-slate-700 bg-sky-900/20" data-style="Post-Bop">${row.postBop}</td>
                    <td class="p-4 border-b border-slate-700" data-style="Free Jazz">${row.freeJazz}</td>
                </tr>
            `).join('');

            document.querySelectorAll('#style-matrix-table th, #style-matrix-table td').forEach(cell => {
                cell.addEventListener('mouseenter', () => {
                    const style = cell.dataset.style || cell.textContent;
                    const feature = cell.parentElement.dataset.feature || cell.textContent;
                    document.querySelectorAll(`[data-style='${style}']`).forEach(c => c.classList.add('highlight'));
                    document.querySelectorAll(`[data-feature='${feature}'] td, [data-feature='${feature}'] th`).forEach(c => c.classList.add('highlight'));
                });
                cell.addEventListener('mouseleave', () => document.querySelectorAll('#style-matrix-table th, #style-matrix-table td').forEach(c => c.classList.remove('highlight')));
            });

            // --- ARCHITECTS CHART (Chart.js) ---
            const architectsChartCtx = document.getElementById('architectsChart').getContext('2d');
            new Chart(architectsChartCtx, {
                type: 'polarArea',
                data: {
                    labels: ['Miles Davis (as Leader)', 'John Coltrane', 'Charles Mingus', 'Blue Note Records'],
                    datasets: [{
                        label: 'Impact Score',
                        data: [5, 4.5, 4, 4.8],
                        backgroundColor: [ 'rgba(56, 189, 248, 0.5)', 'rgba(14, 165, 233, 0.5)', 'rgba(2, 132, 199, 0.5)', 'rgba(3, 105, 161, 0.5)' ],
                        borderColor: [ 'rgb(56, 189, 248)', 'rgb(14, 165, 233)', 'rgb(2, 132, 199)', 'rgb(3, 105, 161)' ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { r: { pointLabels: { display: true, centerPointLabels: true, font: { size: 14, family: "'Lora', serif" }, color: '#d1d5db' }, ticks: { backdropColor: 'rgba(30, 41, 59, 0.7)', color: '#d1d5db' }, grid: { color: 'rgba(71, 85, 105, 0.5)' } } },
                    plugins: { legend: { display: false }, tooltip: {
                        callbacks: {
                            label: function(context) {
                                const customTooltips = { 'Miles Davis (as Leader)': 'Pioneered modality and abstract interplay.', 'John Coltrane': 'Pushed harmonic and spiritual boundaries.', 'Charles Mingus': 'Fused tradition with compositional complexity.', 'Blue Note Records': 'Provided crucial institutional support for innovation.' };
                                return customTooltips[context.label] || '';
                            }
                        }
                    } }
                }
            });
            
            // --- MOBILE NAVIGATION ---
            document.getElementById('mobile-nav').addEventListener('change', e => window.location.hash = e.target.value);
            
            // --- HORIZONTAL DRAG-TO-SCROLL ---
            let isDown = false;
            let startX;
            let scrollLeft;

            timelineContainer.addEventListener('mousedown', (e) => {
              isDown = true;
              timelineContainer.style.cursor = 'grabbing';
              startX = e.pageX - timelineContainer.offsetLeft;
              scrollLeft = timelineContainer.scrollLeft;
            });
            timelineContainer.addEventListener('mouseleave', () => {
              isDown = false;
              timelineContainer.style.cursor = 'grab';
            });
            timelineContainer.addEventListener('mouseup', () => {
              isDown = false;
              timelineContainer.style.cursor = 'grab';
            });
            timelineContainer.addEventListener('mousemove', (e) => {
              if(!isDown) return;
              e.preventDefault();
              const x = e.pageX - timelineContainer.offsetLeft;
              const walk = (x - startX) * 2; //scroll-fast
              timelineContainer.scrollLeft = scrollLeft - walk;
            });
        }
    </script>
</body>
</html>
